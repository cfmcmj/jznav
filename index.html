<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Bookmarks Loader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .bookmark-card {
                @apply bg-white rounded-lg shadow-md p-4 mb-4 transition-all duration-300 hover:shadow-lg;
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90 transition-all;
            }
            .input-field {
                @apply border border-gray-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <i class="fa fa-bookmark-o mr-3 text-primary"></i>
                GitHub Bookmarks Loader
            </h1>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- 配置区域 -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Repository Configuration</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label for="githubRepo" class="block text-gray-700 mb-2">GitHub Repository</label>
                    <input 
                        type="text" 
                        id="githubRepo" 
                        class="input-field" 
                        placeholder="username/repo (optional)"
                        aria-describedby="repoHelp"
                    >
                    <p id="repoHelp" class="text-sm text-gray-500 mt-1">Leave empty to use default public repo</p>
                </div>
                
                <div>
                    <label for="githubPath" class="block text-gray-700 mb-2">File Path</label>
                    <input 
                        type="text" 
                        id="githubPath" 
                        class="input-field" 
                        value="bookmarks.json"
                        placeholder="Path to bookmarks file"
                    >
                </div>
            </div>
            
            <div class="mt-4">
                <label for="githubToken" class="block text-gray-700 mb-2">GitHub Token (optional)</label>
                <input 
                    type="text" 
                    id="githubToken" 
                    class="input-field" 
                    placeholder="ghp_..."
                    aria-describedby="tokenHelp"
                >
                <p id="tokenHelp" class="text-sm text-gray-500 mt-1">
                    Only for private repos or rate limit issues
                </p>
            </div>
            
            <div class="mt-6 flex space-x-4">
                <button id="saveConfig" class="btn-primary">
                    <i class="fa fa-save mr-1"></i> Save Configuration
                </button>
                <button id="clearConfig" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-all">
                    <i class="fa fa-trash mr-1"></i> Clear
                </button>
            </div>
            
            <div id="configStatus" class="mt-4 hidden"></div>
        </section>
        
        <!-- 状态区域 -->
        <section id="statusSection" class="mb-8">
            <div id="loadingIndicator" class="hidden bg-blue-50 border-l-4 border-primary p-4 rounded">
                <div class="flex">
                    <i class="fa fa-circle-o-notch fa-spin text-primary mt-1"></i>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700" id="loadingMessage">Loading bookmarks...</p>
                    </div>
                </div>
            </div>
            
            <div id="errorMessage" class="hidden bg-red-50 border-l-4 border-red-400 p-4 rounded">
                <div class="flex">
                    <i class="fa fa-exclamation-circle text-red-500 mt-1"></i>
                    <div class="ml-3">
                        <p class="text-sm text-red-700" id="errorDetails"></p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 书签展示区域 -->
        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Bookmarks</h2>
            <div id="bookmarksContainer" class="space-y-4">
                <div class="text-center py-12 text-gray-500">
                    <i class="fa fa-folder-open-o text-4xl mb-4 opacity-30"></i>
                    <p>Loading bookmarks...</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        // 预设的默认仓库（作为动态填充的基准）
        const DEFAULT_REPO = "adarsh-dhakal/bookmark-example"; // 包含有效的bookmarks.json
        const DEFAULT_PATH = "bookmarks.json";
        
        // DOM元素
        const elements = {
            githubRepo: document.getElementById('githubRepo'),
            githubPath: document.getElementById('githubPath'),
            githubToken: document.getElementById('githubToken'),
            saveConfig: document.getElementById('saveConfig'),
            clearConfig: document.getElementById('clearConfig'),
            configStatus: document.getElementById('configStatus'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            loadingMessage: document.getElementById('loadingMessage'),
            errorMessage: document.getElementById('errorMessage'),
            errorDetails: document.getElementById('errorDetails'),
            bookmarksContainer: document.getElementById('bookmarksContainer')
        };
        
        // 初始化：自动填充默认配置（无用户配置时）
        function initApp() {
            loadOrFillDefaultConfig(); // 加载保存的配置，无则填充默认值
            elements.saveConfig.addEventListener('click', saveConfiguration);
            elements.clearConfig.addEventListener('click', clearConfiguration);
            loadBookmarks(); // 自动加载书签（无需用户手动触发）
        }
        
        // 加载保存的配置，若无则自动填充默认值
        function loadOrFillDefaultConfig() {
            const savedConfig = localStorage.getItem('githubBookmarksConfig');
            if (savedConfig) {
                try {
                    const { repo, path, token } = JSON.parse(savedConfig);
                    elements.githubRepo.value = repo || ''; // 允许为空
                    elements.githubPath.value = path || DEFAULT_PATH;
                    elements.githubToken.value = token || ''; // 允许为空
                    return;
                } catch (e) {
                    console.error('Failed to parse saved config:', e);
                }
            }
            
            // 无保存的配置时，自动填充默认仓库（实现“动态填充”效果）
            elements.githubRepo.value = ''; // 初始为空，让用户知道可修改
            elements.githubPath.value = DEFAULT_PATH;
        }
        
        // 保存配置（移除强制校验）
        function saveConfiguration() {
            const config = {
                repo: elements.githubRepo.value.trim(), // 允许为空
                path: elements.githubPath.value.trim() || DEFAULT_PATH,
                token: elements.githubToken.value.trim() // 允许为空
            };
            
            try {
                localStorage.setItem('githubBookmarksConfig', JSON.stringify(config));
                showConfigStatus('Configuration saved', 'success');
                loadBookmarks(); // 保存后立即加载
            } catch (e) {
                showConfigStatus('Failed to save', 'error');
            }
        }
        
        // 清除配置（恢复默认填充）
        function clearConfiguration() {
            localStorage.removeItem('githubBookmarksConfig');
            elements.githubRepo.value = '';
            elements.githubPath.value = DEFAULT_PATH;
            elements.githubToken.value = '';
            showConfigStatus('Configuration cleared', 'info');
            loadBookmarks(); // 清除后用默认值加载
        }
        
        // 获取当前生效的配置（无配置时自动使用默认仓库）
        function getEffectiveConfig() {
            const savedConfig = localStorage.getItem('githubBookmarksConfig');
            if (savedConfig) {
                try {
                    const { repo, path, token } = JSON.parse(savedConfig);
                    return {
                        repo: repo || DEFAULT_REPO, // 为空时用默认
                        path: path || DEFAULT_PATH,
                        token: token || ''
                    };
                } catch (e) {
                    console.error('Failed to parse config:', e);
                }
            }
            
            // 完全无配置时，使用默认仓库
            return {
                repo: DEFAULT_REPO,
                path: DEFAULT_PATH,
                token: ''
            };
        }
        
        // 加载书签（核心逻辑）
        async function loadBookmarks() {
            const config = getEffectiveConfig();
            showLoading(`Loading from ${config.repo}...`);
            
            try {
                const [owner, repo] = config.repo.split('/');
                if (!owner || !repo) throw new Error('Invalid repo format (username/repo)');
                
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(config.path)}`;
                const headers = { 'Accept': 'application/vnd.github.v3+json' };
                if (config.token) headers['Authorization'] = `token ${config.token}`;
                
                const response = await fetch(url, { headers });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const bookmarks = JSON.parse(atob(data.content));
                renderBookmarks(bookmarks);
                hideStatusIndicators();
                
            } catch (error) {
                console.error('Load error:', error);
                showError(`Failed to load: ${error.message}. Using default repo...`);
                
                // 最终回退到预设默认仓库
                if (config.repo !== DEFAULT_REPO) {
                    try {
                        const fallbackConfig = { ...config, repo: DEFAULT_REPO };
                        const [owner, repo] = fallbackConfig.repo.split('/');
                        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${DEFAULT_PATH}`;
                        
                        const response = await fetch(url, { 
                            headers: { 'Accept': 'application/vnd.github.v3+json' } 
                        });
                        if (!response.ok) throw new Error(`Fallback failed (${response.status})`);
                        
                        const data = await response.json();
                        const bookmarks = JSON.parse(atob(data.content));
                        renderBookmarks(bookmarks);
                        hideStatusIndicators();
                        // 自动填充默认仓库到输入框，让用户知情
                        elements.githubRepo.value = DEFAULT_REPO;
                    } catch (fallbackError) {
                        showError(`Fallback failed: ${fallbackError.message}`);
                        elements.bookmarksContainer.innerHTML = '<p class="text-center py-8 text-gray-500">No bookmarks available</p>';
                    }
                }
            }
        }
        
        // 渲染书签
        function renderBookmarks(bookmarks) {
            if (!bookmarks?.length) {
                elements.bookmarksContainer.innerHTML = '<p class="text-center py-8 text-gray-500">No bookmarks found</p>';
                return;
            }
            
            // 按类别分组
            const groups = {};
            bookmarks.forEach(b => {
                const category = b.category || 'Uncategorized';
                if (!groups[category]) groups[category] = [];
                groups[category].push(b);
            });
            
            elements.bookmarksContainer.innerHTML = Object.entries(groups).map(([category, items]) => `
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">${category}</h3>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${items.map(item => `
                            <div class="bookmark-card">
                                <a href="${item.url}" target="_blank" class="block">
                                    <h4 class="font-medium hover:text-primary">${item.name || 'Untitled'}</h4>
                                    ${item.description ? `<p class="text-sm text-gray-600 mt-1">${item.description}</p>` : ''}
                                    <p class="text-xs text-gray-500 mt-2">${new URL(item.url).hostname}</p>
                                </a>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        // 辅助函数：状态提示
        function showLoading(msg) {
            elements.loadingMessage.textContent = msg;
            elements.loadingIndicator.classList.remove('hidden');
            elements.errorMessage.classList.add('hidden');
        }
        
        function showError(msg) {
            elements.errorDetails.textContent = msg;
            elements.errorMessage.classList.remove('hidden');
            elements.loadingIndicator.classList.add('hidden');
        }
        
        function hideStatusIndicators() {
            elements.loadingIndicator.classList.add('hidden');
            elements.errorMessage.classList.add('hidden');
        }
        
        function showConfigStatus(msg, type) {
            elements.configStatus.textContent = msg;
            elements.configStatus.className = `mt-4 text-sm ${
                type === 'success' ? 'text-green-600' : 
                type === 'error' ? 'text-red-600' : 'text-blue-600'
            }`;
            setTimeout(() => elements.configStatus.classList.add('hidden'), 3000);
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
