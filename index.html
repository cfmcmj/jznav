<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星际导航 | 探索网络宇宙</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%230f172a'/%3E%3Ccircle cx='50' cy='50' r='25' fill='%237c3aed'/%3E%3Ccircle cx='35' cy='40' r='5' fill='white' opacity='0.8'/%3E%3Ccircle cx='65' cy='60' r='3' fill='white' opacity='0.6'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        space: {
                            dark: '#0f172a',
                            darker: '#020617',
                            light: '#1e293b',
                            accent: '#7c3aed',
                            glow: '#a855f7',
                            star: '#e2e8f0'
                        }
                    },
                    fontFamily: {
                        space: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'twinkle': 'twinkle 3s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'orbit': 'orbit 20s linear infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        twinkle: {
                            '0%, 100%': { opacity: 0.6 },
                            '50%': { opacity: 1 }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        orbit: {
                            '0%': { transform: 'rotate(0deg) translateX(100px) rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg) translateX(100px) rotate(-360deg)' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .star { position: absolute; background-color: white; border-radius: 50%; }
            .planet { position: absolute; border-radius: 50%; }
            .gradient-mask-b { mask-image: linear-gradient(to bottom, black 85%, transparent 100%); }
            .card-hover { transition: all 0.3s ease; }
            .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(124, 58, 237, 0.4); }
            .scrollbar-hide::-webkit-scrollbar { display: none; }
            .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
            .nav-btn-visible { opacity: 1; transform: translateY(0); }
            .nav-btn-hidden { opacity: 0; transform: translateY(-10px); pointer-events: none; }
        }
    </style>
</head>
<body class="font-space bg-gray-50 text-gray-900 dark:bg-space-dark dark:text-gray-100 transition-colors duration-500 min-h-screen overflow-x-hidden">
    <!-- 星空背景 -->
    <div id="stars" class="fixed inset-0 -z-10 pointer-events-none"></div>
    <div id="planets" class="fixed inset-0 -z-10 pointer-events-none"></div>
    
    <!-- 导航按钮 - 滚动时显示，停止滚动3秒后隐藏 -->
    <div id="navButtons" class="fixed top-4 right-4 flex gap-3 transition-all duration-300 z-50">
        <button id="themeToggle" class="bg-white/10 backdrop-blur-sm hover:bg-white/20 text-white p-2 rounded-full shadow-lg transition-all duration-300">
            <i class="fa fa-moon-o dark:hidden"></i>
            <i class="fa fa-sun-o hidden dark:inline"></i>
        </button>
        <button id="editButton" class="bg-space-accent hover:bg-space-glow text-white p-2 rounded-full shadow-lg transition-all duration-300">
            <i class="fa fa-cog"></i>
        </button>
    </div>

    <!-- GitHub配置对话框 -->
    <div id="githubConfigModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-space-light rounded-xl p-6 w-full max-w-md shadow-xl transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">GitHub 配置</h3>
                <button id="closeConfigModal" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block mb-1 text-sm font-medium">仓库 (username/repo-name)</label>
                    <input type="text" id="githubRepo" placeholder="username/repo-name" 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md">
                </div>
                <div>
                    <label class="block mb-1 text-sm font-medium">访问令牌 (可选)</label>
                    <input type="password" id="githubToken" placeholder="ghp_..." 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        用于访问私有仓库或修改数据
                    </p>
                </div>
                <button id="saveGitHubConfig" class="w-full bg-space-accent hover:bg-space-glow text-white px-4 py-2 rounded-md transition-colors">
                    确认配置
                </button>
            </div>
        </div>
    </div>

    <!-- 主页 -->
    <div id="homePage" class="container mx-auto px-4 py-8">
        <!-- 顶部小组件 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <!-- 在线时长统计 -->
            <div class="bg-white/70 dark:bg-space-light/50 backdrop-blur-md rounded-xl p-5 shadow-lg card-hover">
                <h3 class="text-lg font-semibold mb-3 flex items-center">
                    <i class="fa fa-clock-o mr-2 text-space-accent"></i>在线时长统计
                </h3>
                <div class="flex items-end gap-2">
                    <div class="text-3xl font-bold" id="onlineHours">0</div>
                    <div class="text-sm mb-1">小时</div>
                </div>
                <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">今日访问：<span id="todayVisits">0</span> 次</div>
            </div>
            
            <!-- 健康提醒 -->
            <div class="bg-white/70 dark:bg-space-light/50 backdrop-blur-md rounded-xl p-5 shadow-lg card-hover">
                <h3 class="text-lg font-semibold mb-3 flex items-center">
                    <i class="fa fa-heartbeat mr-2 text-space-accent"></i>健康提醒
                </h3>
                <div id="healthReminder" class="text-center py-3">
                    距离下一次休息还有 <span id="nextBreak" class="font-bold text-space-accent">30</span> 分钟
                </div>
                <div class="mt-3 flex justify-center">
                    <button id="takeBreakBtn" class="bg-space-accent/20 hover:bg-space-accent/30 text-space-accent px-3 py-1 rounded-full text-sm transition-colors">
                        立即休息
                    </button>
                </div>
            </div>
            
            <!-- 世界时间 -->
            <div class="bg-white/70 dark:bg-space-light/50 backdrop-blur-md rounded-xl p-5 shadow-lg card-hover">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fa fa-globe mr-2 text-space-accent"></i>世界时间
                    </h3>
                    <button id="addTimezone" class="text-sm text-space-accent hover:underline">+ 添加</button>
                </div>
                <div id="timezones" class="space-y-2 max-h-32 overflow-y-auto scrollbar-hide">
                    <!-- 时区将动态添加 -->
                </div>
            </div>
        </div>
        
        <!-- 广告位1 -->
        <div class="mb-8 bg-white/50 dark:bg-space-light/30 backdrop-blur-sm rounded-xl overflow-hidden shadow-md ad-slot" data-slot="1">
            <a id="ad1Link" href="#" target="_blank">
                <img id="ad1Img" src="https://picsum.photos/1200/200?random=1" alt="广告图片1" class="w-full h-40 object-cover transition-transform duration-500 hover:scale-105">
            </a>
        </div>
        
        <!-- 书签区域 -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fa fa-bookmark mr-2 text-space-accent"></i>星际收藏
            </h2>
            <div id="bookmarkGroups" class="space-y-6">
                <!-- 书签组将动态添加 -->
            </div>
        </div>
        
        <!-- 广告位2 -->
        <div class="mb-8 bg-white/50 dark:bg-space-light/30 backdrop-blur-sm rounded-xl overflow-hidden shadow-md ad-slot" data-slot="2">
            <a id="ad2Link" href="#" target="_blank">
                <img id="ad2Img" src="https://picsum.photos/1200/200?random=2" alt="广告图片2" class="w-full h-40 object-cover transition-transform duration-500 hover:scale-105">
            </a>
        </div>
        
        <!-- 常用网站 -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fa fa-rocket mr-2 text-space-accent"></i>常用站点
            </h2>
            <div id="frequentBookmarks" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <!-- 常用书签将动态添加 -->
            </div>
        </div>
        
        <!-- 广告位3 -->
        <div class="mb-12 bg-white/50 dark:bg-space-light/30 backdrop-blur-sm rounded-xl overflow-hidden shadow-md ad-slot" data-slot="3">
            <a id="ad3Link" href="#" target="_blank">
                <img id="ad3Img" src="https://picsum.photos/1200/200?random=3" alt="广告图片3" class="w-full h-40 object-cover transition-transform duration-500 hover:scale-105">
            </a>
        </div>
        
        <!-- 页脚 -->
        <div class="dark-white mt-12 py-6 border-t border-gray-200 dark:border-gray-800">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>共收录 <span id="totalBookmarks">0</span> 个网站</div>
                    <div>Copyright © 2018-<span id="currentYear"></span> <span id="hostname">星际导航</span>, All Rights Reserved</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑页 -->
    <div id="editPage" class="fixed inset-0 bg-white dark:bg-space-dark p-4 md:p-8 z-50 transform translate-x-full transition-transform duration-300 overflow-y-auto">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fa fa-pencil-square-o mr-2 text-space-accent"></i>编辑中心
                </h1>
                <button id="closeEditBtn" class="p-2 hover:bg-gray-200 dark:hover:bg-space-light rounded-full transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 书签管理 -->
            <div class="bg-white dark:bg-space-light rounded-xl p-6 shadow-md mb-8">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <h2 class="text-xl font-semibold">书签管理</h2>
                    <div class="flex gap-2">
                        <button id="importBookmarks" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm transition-colors">
                            <i class="fa fa-upload mr-1"></i>导入书签
                        </button>
                        <button id="exportBookmarks" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm transition-colors">
                            <i class="fa fa-download mr-1"></i>导出书签
                        </button>
                        <button id="addNewBookmark" class="bg-space-accent hover:bg-space-glow text-white px-3 py-1 rounded-md text-sm transition-colors">
                            <i class="fa fa-plus mr-1"></i>添加书签
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <input type="file" id="bookmarkFile" accept=".html" class="hidden">
                    <div class="flex flex-wrap justify-between text-sm text-gray-500 dark:text-gray-400 gap-2">
                        <div>共 <span id="editBookmarkCount">0</span> 个书签</div>
                        <div class="flex gap-3">
                            <button id="backupJSON" class="text-blue-500 hover:underline">
                                <i class="fa fa-save mr-1"></i>备份JSON
                            </button>
                            <button id="loadJSON" class="text-green-500 hover:underline">
                                <i class="fa fa-upload mr-1"></i>载入备份
                            </button>
                            <input type="file" id="jsonFile" accept=".json" class="hidden">
                        </div>
                    </div>
                </div>
                
                <div id="editBookmarksContainer" class="max-h-[500px] overflow-y-auto scrollbar-hide pr-2">
                    <!-- 书签编辑内容将动态生成 -->
                </div>
            </div>
            
            <!-- 广告管理 -->
            <div class="bg-white dark:bg-space-light rounded-xl p-6 shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4">广告管理</h2>
                <div class="space-y-6">
                    <!-- 广告位1 -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <h3 class="font-medium mb-3">广告位 1</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <img id="ad1Preview" src="https://picsum.photos/600/200?random=1" alt="广告1预览" class="w-full h-32 object-cover rounded">
                                <input type="file" id="ad1File" accept="image/*" class="hidden">
                                <button onclick="document.getElementById('ad1File').click()" class="mt-2 text-sm text-space-accent hover:underline transition-colors">
                                    更换图片
                                </button>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium">链接地址</label>
                                <input type="url" id="ad1Url" placeholder="https://example.com" 
                                    class="w-full px-3 py-2 mb-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md text-sm">
                                <button id="saveAd1" class="w-full bg-space-accent hover:bg-space-glow text-white px-3 py-2 rounded-md text-sm transition-colors">
                                    保存设置
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 广告位2 -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <h3 class="font-medium mb-3">广告位 2</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <img id="ad2Preview" src="https://picsum.photos/600/200?random=2" alt="广告2预览" class="w-full h-32 object-cover rounded">
                                <input type="file" id="ad2File" accept="image/*" class="hidden">
                                <button onclick="document.getElementById('ad2File').click()" class="mt-2 text-sm text-space-accent hover:underline transition-colors">
                                    更换图片
                                </button>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium">链接地址</label>
                                <input type="url" id="ad2Url" placeholder="https://example.com" 
                                    class="w-full px-3 py-2 mb-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md text-sm">
                                <button id="saveAd2" class="w-full bg-space-accent hover:bg-space-glow text-white px-3 py-2 rounded-md text-sm transition-colors">
                                    保存设置
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 广告位3 -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <h3 class="font-medium mb-3">广告位 3</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <img id="ad3Preview" src="https://picsum.photos/600/200?random=3" alt="广告3预览" class="w-full h-32 object-cover rounded">
                                <input type="file" id="ad3File" accept="image/*" class="hidden">
                                <button onclick="document.getElementById('ad3File').click()" class="mt-2 text-sm text-space-accent hover:underline transition-colors">
                                    更换图片
                                </button>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium">链接地址</label>
                                <input type="url" id="ad3Url" placeholder="https://example.com" 
                                    class="w-full px-3 py-2 mb-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md text-sm">
                                <button id="saveAd3" class="w-full bg-space-accent hover:bg-space-glow text-white px-3 py-2 rounded-md text-sm transition-colors">
                                    保存设置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 世界时间管理 -->
            <div class="bg-white dark:bg-space-light rounded-xl p-6 shadow-md mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">世界时间管理</h2>
                    <button id="addTimezoneBtn" class="bg-space-accent hover:bg-space-glow text-white px-3 py-1 rounded-md text-sm transition-colors">
                        <i class="fa fa-plus mr-1"></i>添加时区
                    </button>
                </div>
                <div id="timezonesEdit" class="space-y-3 max-h-[300px] overflow-y-auto scrollbar-hide pr-2">
                    <!-- 时区编辑内容将动态生成 -->
                </div>
            </div>
            
            <!-- 保存按钮 -->
            <div class="flex justify-end mt-8">
                <button id="saveChanges" class="bg-space-accent hover:bg-space-glow text-white px-6 py-3 rounded-md transition-colors text-lg font-medium flex items-center">
                    <i class="fa fa-save mr-2"></i>保存更改
                </button>
            </div>
        </div>
    </div>

    <!-- 添加书签弹窗 -->
    <div id="addBookmarkModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-space-light rounded-xl p-6 w-full max-w-md shadow-xl transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold" id="bookmarkModalTitle">添加新书签</h3>
                <button id="closeBookmarkModal" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block mb-1 text-sm font-medium">网址</label>
                    <input type="url" id="newBookmarkUrl" placeholder="https://example.com" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md">
                </div>
                <div>
                    <label class="block mb-1 text-sm font-medium">名称</label>
                    <input type="text" id="newBookmarkName" placeholder="网站名称"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md">
                </div>
                <div>
                    <label class="block mb-1 text-sm font-medium">分组</label>
                    <select id="newBookmarkGroup" 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md">
                        <option value="默认分组">默认分组</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-1 text-sm font-medium">新分组（可选）</label>
                    <input type="text" id="newBookmarkGroupName" placeholder="创建新分组"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md">
                </div>
                <button id="saveNewBookmark" class="w-full bg-space-accent hover:bg-space-glow text-white px-4 py-2 rounded-md transition-colors">
                    保存书签
                </button>
            </div>
        </div>
    </div>

    <!-- 添加时区弹窗 -->
    <div id="addTimezoneModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-space-light rounded-xl p-6 w-full max-w-md shadow-xl transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">添加时区</h3>
                <button id="closeTimezoneModal" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block mb-1 text-sm font-medium">城市名称</label>
                    <input type="text" id="timezoneCity" placeholder="例如：北京" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md">
                </div>
                <div>
                    <label class="block mb-1 text-sm font-medium">时区偏移（小时）</label>
                    <input type="number" id="timezoneOffset" placeholder="例如：8 表示 UTC+8" step="0.5" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md">
                </div>
                <button id="saveNewTimezone" class="w-full bg-space-accent hover:bg-space-glow text-white px-4 py-2 rounded-md transition-colors">
                    保存时区
                </button>
            </div>
        </div>
    </div>

    <!-- 确认删除弹窗 -->
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-space-light rounded-xl p-6 w-full max-w-md shadow-xl transform transition-all">
            <h3 class="text-xl font-semibold mb-4">确认删除</h3>
            <p class="mb-6" id="deleteConfirmationText">您确定要删除此项吗？此操作无法撤销。</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDelete" class="px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    取消
                </button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md transition-colors">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <script>
        let appData = {
            bookmarks: {
                "默认分组": []
            },
            ads: {
                1: {
                    image: "https://picsum.photos/1200/200?random=1",
                    url: ""
                },
                2: {
                    image: "https://picsum.photos/1200/200?random=2",
                    url: ""
                },
                3: {
                    image: "https://picsum.photos/1200/200?random=3",
                    url: ""
                }
            },
            timezones: [
                { city: "北京", offset: 8 },
                { city: "伦敦", offset: 0 },
                { city: "纽约", offset: -4 }
            ],
            github: {
                repo: "default-user/space-bookmarks",
                token: ""
            },
            stats: {
                onlineHours: 0,
                todayVisits: 0
            }
        };

        let currentEditId = null;
        let currentEditGroup = null;
        let currentDeleteId = null;
        let currentDeleteType = null;
        let currentDeleteGroup = null;
        let scrollTimer = null;

        document.addEventListener('DOMContentLoaded', async () => {
            initStars();
            initPlanets();
            initTheme();
            await init();
            setupEventListeners();
            setupScrollHandling();
            startTimers();
            updateFooter();
        });

        function initStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 200;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                const size = Math.random() * 2;
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const delay = Math.random() * 5;
                const opacity = 0.3 + Math.random() * 0.7;
                
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.animation = `twinkle ${3 + Math.random() * 4}s ease-in-out infinite`;
                star.style.animationDelay = `${delay}s`;
                star.style.opacity = opacity;
                
                starsContainer.appendChild(star);
            }
        }

        function initPlanets() {
            const planetsContainer = document.getElementById('planets');
            
            const planets = [
                { size: 15, color: '#3b82f6', top: '20%', left: '10%', animation: 'float 15s ease-in-out infinite' },
                { size: 10, color: '#f97316', top: '60%', left: '80%', animation: 'float 12s ease-in-out infinite' },
                { size: 20, color: '#8b5cf6', top: '40%', left: '90%', animation: 'float 20s ease-in-out infinite' }
            ];
            
            planets.forEach(planet => {
                const el = document.createElement('div');
                el.classList.add('planet');
                el.style.width = `${planet.size}px`;
                el.style.height = `${planet.size}px`;
                el.style.backgroundColor = planet.color;
                el.style.top = planet.top;
                el.style.left = planet.left;
                el.style.animation = planet.animation;
                el.style.opacity = 0.7;
                planetsContainer.appendChild(el);
            });
        }

        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        async function init() {
            loadLocalConfig();
            await loadDataFromGitHub();
            renderBookmarks();
            renderTimezones();
            renderTimezonesEdit();
            renderStats();
            updateAdPreviews();
            
            document.getElementById('githubRepo').value = appData.github.repo;
            document.getElementById('githubToken').value = appData.github.token;
        }

        function loadLocalConfig() {
            const savedGithub = localStorage.getItem('githubConfig');
            if (savedGithub) {
                try {
                    appData.github = JSON.parse(savedGithub);
                } catch (e) {
                    console.error('加载GitHub配置失败', e);
                }
            }
        }

        async function loadDataFromGitHub() {
            let repo = appData.github.repo || 'default-user/space-bookmarks';
            let token = appData.github.token;
            
            try {
                let url;
                let headers = {};
                
                if (token) {
                    url = `https://api.github.com/repos/${repo}/contents/bookmarks.json`;
                    headers = {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    };
                } else {
                    url = `https://raw.githubusercontent.com/${repo}/main/bookmarks.json`;
                }
                
                const response = await fetch(url, { headers });
                
                if (response.ok) {
                    let data;
                    if (token) {
                        const apiData = await response.json();
                        data = JSON.parse(atob(apiData.content));
                    } else {
                        data = await response.json();
                    }
                    
                    if (data.bookmarks) appData.bookmarks = data.bookmarks;
                    if (data.ads) appData.ads = data.ads;
                    if (data.timezones) appData.timezones = data.timezones;
                    if (data.stats) appData.stats = data.stats;
                    
                    showNotification('数据加载成功', 'success');
                } else {
                    console.log('使用默认数据，无法加载GitHub数据');
                    showNotification('使用默认数据', 'info');
                }
            } catch (error) {
                console.error('加载GitHub数据失败', error);
                showNotification('加载数据失败，使用默认数据', 'error');
            }
        }

        async function saveDataToGitHub() {
            const repo = appData.github.repo;
            const token = appData.github.token;
            
            if (!repo) {
                showNotification('请设置GitHub仓库', 'error');
                return false;
            }
            
            try {
                const dataToSave = {
                    bookmarks: appData.bookmarks,
                    ads: appData.ads,
                    timezones: appData.timezones,
                    stats: appData.stats
                };
                
                const content = JSON.stringify(dataToSave, null, 2);
                let encodedContent;
                
                try {
                    encodedContent = btoa(unescape(encodeURIComponent(content)));
                } catch (e) {
                    console.error('编码错误', e);
                    showNotification('数据编码错误', 'error');
                    return false;
                }
                
                const url = `https://api.github.com/repos/${repo}/contents/bookmarks.json`;
                let sha = '';
                
                try {
                    const checkResponse = await fetch(url, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const fileData = await checkResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    console.log('文件可能不存在，将创建新文件');
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: 'Update bookmarks via space navigation',
                        content: encodedContent,
                        sha: sha
                    })
                });
                
                if (response.ok) {
                    showNotification('数据已成功保存到GitHub', 'success');
                    return true;
                } else {
                    const errorData = await response.json();
                    console.error('保存到GitHub失败', errorData);
                    showNotification(`保存失败: ${errorData.message || '未知错误'}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('保存到GitHub时发生错误', error);
                showNotification('保存数据失败，请检查配置', 'error');
                return false;
            }
        }

        function renderBookmarks() {
            const groupsContainer = document.getElementById('bookmarkGroups');
            const frequentContainer = document.getElementById('frequentBookmarks');
            const editContainer = document.getElementById('editBookmarksContainer');
            const countElement = document.getElementById('editBookmarkCount');
            const totalElement = document.getElementById('totalBookmarks');
            
            groupsContainer.innerHTML = '';
            frequentContainer.innerHTML = '';
            editContainer.innerHTML = '';
            
            let totalCount = 0;
            const allBookmarks = [];
            
            for (const [groupName, bookmarks] of Object.entries(appData.bookmarks)) {
                if (bookmarks.length === 0) continue;
                
                totalCount += bookmarks.length;
                allBookmarks.push(...bookmarks);
                
                const groupElement = document.createElement('div');
                groupElement.className = 'bookmark-group';
                
                groupElement.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4 text-space-accent">${groupName}</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        ${bookmarks.map(bookmark => createBookmarkHTML(bookmark)).join('')}
                    </div>
                `;
                
                groupsContainer.appendChild(groupElement);
                
                const editGroupElement = document.createElement('div');
                editGroupElement.className = 'mb-6';
                editGroupElement.innerHTML = `
                    <h3 class="text-lg font-medium mb-3 flex justify-between items-center">
                        <span>${groupName}</span>
                        <button class="delete-group text-red-500 hover:text-red-700 text-sm transition-colors" data-group="${groupName}">
                            <i class="fa fa-trash-o mr-1"></i>删除分组
                        </button>
                    </h3>
                    <div class="space-y-2 pl-4 border-l-2 border-gray-200 dark:border-gray-700">
                        ${bookmarks.map(bookmark => createEditBookmarkHTML(bookmark, groupName)).join('')}
                    </div>
                `;
                
                editContainer.appendChild(editGroupElement);
            }
            
            countElement.textContent = totalCount;
            totalElement.textContent = totalCount;
            
            const groupSelect = document.getElementById('newBookmarkGroup');
            groupSelect.innerHTML = '';
            Object.keys(appData.bookmarks).forEach(groupName => {
                const option = document.createElement('option');
                option.value = groupName;
                option.textContent = groupName;
                groupSelect.appendChild(option);
            });
            
            const sortedBookmarks = [...allBookmarks]
                .sort((a, b) => (b.visitCount || 0) - (a.visitCount || 0))
                .slice(0, 6);
            
            sortedBookmarks.forEach(bookmark => {
                const bookmarkElement = document.createElement('div');
                bookmarkElement.innerHTML = createBookmarkHTML(bookmark);
                frequentContainer.appendChild(bookmarkElement.firstElementChild);
            });
        }

        function createBookmarkHTML(bookmark) {
            let favicon = '';
            try {
                const url = new URL(bookmark.url);
                favicon = `<img src="https://${url.hostname}/favicon.ico" alt="${bookmark.name}图标" class="w-6 h-6 rounded mr-2 object-contain" onError="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%237c3aed%22%3E%3Ctext x=%2212%22 y=%2218%22 font-size=%2216%22 text-anchor=%22middle%22%3E${bookmark.name.charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E';">`;
            } catch (e) {
                const firstChar = bookmark.name.charAt(0).toUpperCase();
                favicon = `<div class="w-6 h-6 rounded bg-space-accent/20 text-space-accent flex items-center justify-center mr-2">${firstChar}</div>`;
            }
            
            return `
                <a href="${bookmark.url}" target="_blank" class="bookmark-card bg-white/80 dark:bg-space-light/60 backdrop-blur-sm rounded-lg p-3 flex items-center hover:shadow-md transition-all duration-200 card-hover" data-id="${bookmark.id}">
                    <div class="flex-shrink-0">${favicon}</div>
                    <div class="truncate">${bookmark.name}</div>
                </a>
            `;
        }

        function createEditBookmarkHTML(bookmark, groupName) {
            return `
                <div class="bookmark-edit-item flex justify-between items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md transition-colors">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-space-accent/20 text-space-accent flex items-center justify-center rounded mr-2">
                            ${bookmark.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="max-w-xs">
                            <div class="font-medium truncate">${bookmark.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 truncate">${bookmark.url}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-bookmark text-blue-500 hover:text-blue-700 transition-colors" data-id="${bookmark.id}" data-group="${groupName}">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="delete-bookmark text-red-500 hover:text-red-700 transition-colors" data-id="${bookmark.id}" data-group="${groupName}">
                            <i class="fa fa-trash-o"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTimezones() {
            const container = document.getElementById('timezones');
            container.innerHTML = '';
            
            appData.timezones.forEach((timezone, index) => {
                const timezoneElement = document.createElement('div');
                timezoneElement.className = 'flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-800 rounded-md';
                
                timezoneElement.innerHTML = `
                    <div>${timezone.city} (UTC${timezone.offset >= 0 ? '+' : ''}${timezone.offset})</div>
                    <div class="font-medium" data-timezone="${index}"></div>
                `;
                
                container.appendChild(timezoneElement);
            });
        }

        function renderTimezonesEdit() {
            const container = document.getElementById('timezonesEdit');
            container.innerHTML = '';
            
            appData.timezones.forEach((timezone, index) => {
                const timezoneElement = document.createElement('div');
                timezoneElement.className = 'flex justify-between items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md transition-colors';
                
                timezoneElement.innerHTML = `
                    <div>
                        <div class="font-medium">${timezone.city}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">UTC${timezone.offset >= 0 ? '+' : ''}${timezone.offset}</div>
                    </div>
                    <button class="delete-timezone text-red-500 hover:text-red-700 transition-colors" data-index="${index}">
                        <i class="fa fa-trash-o"></i>
                    </button>
                `;
                
                container.appendChild(timezoneElement);
            });
        }

        function renderStats() {
            document.getElementById('onlineHours').textContent = appData.stats.onlineHours.toFixed(1);
            document.getElementById('todayVisits').textContent = appData.stats.todayVisits;
        }

        function updateAdPreviews() {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`ad${i}Preview`).src = appData.ads[i].image;
                document.getElementById(`ad${i}Url`).value = appData.ads[i].url || '';
                document.getElementById(`ad${i}Img`).src = appData.ads[i].image;
                document.getElementById(`ad${i}Link`).href = appData.ads[i].url || '#';
            }
        }

        function updateFooter() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            if (appData.github.repo) {
                const parts = appData.github.repo.split('/');
                if (parts.length > 0) {
                    document.getElementById('hostname').textContent = parts[0];
                }
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 z-50';
            
            switch (type) {
                case 'success':
                    notification.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    notification.classList.add('bg-red-500', 'text-white');
                    break;
                case 'warning':
                    notification.classList.add('bg-yellow-500', 'text-gray-800');
                    break;
                default:
                    notification.classList.add('bg-blue-500', 'text-white');
            }
            
            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-100');
                notification.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function parseBookmarkHtml(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const bookmarks = {};
            
            function parseNode(node, currentGroup) {
                if (node.tagName === 'DT') {
                    const child = node.firstElementChild;
                    if (child.tagName === 'A') {
                        const url = child.getAttribute('href');
                        const name = child.textContent.trim();
                        
                        if (url && name) {
                            const id = 'bm_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                            
                            const isDuplicate = currentGroup.some(bm => bm.url === url);
                            if (!isDuplicate) {
                                currentGroup.push({ id, url, name, visitCount: 0 });
                            }
                        }
                    } else if (child.tagName === 'DL') {
                        Array.from(child.children).forEach(subNode => {
                            parseNode(subNode, currentGroup);
                        });
                    }
                } else if (node.tagName === 'H3') {
                    const groupName = node.textContent.trim() || '未命名分组';
                    const group = bookmarks[groupName] || [];
                    bookmarks[groupName] = group;
                    
                    let nextNode = node.nextElementSibling;
                    while (nextNode && nextNode.tagName !== 'DL') {
                        nextNode = nextNode.nextElementSibling;
                    }
                    
                    if (nextNode) {
                        Array.from(nextNode.children).forEach(subNode => {
                            parseNode(subNode, group);
                        });
                    }
                }
            }
            
            const bookmarkNodes = doc.getElementsByTagName('DL')[0];
            if (bookmarkNodes) {
                Array.from(bookmarkNodes.children).forEach(node => {
                    parseNode(node, bookmarks['默认分组'] || (bookmarks['默认分组'] = []));
                });
            }
            
            return bookmarks;
        }

        function mergeBookmarks(existing, newBookmarks) {
            const merged = { ...existing };
            
            for (const [groupName, bookmarks] of Object.entries(newBookmarks)) {
                if (!merged[groupName]) {
                    merged[groupName] = [];
                }
                
                bookmarks.forEach(newBookmark => {
                    const exists = merged[groupName].some(bm => bm.url === newBookmark.url);
                    if (!exists) {
                        merged[groupName].push(newBookmark);
                    }
                });
            }
            
            return merged;
        }

        function startTimers() {
            function updateTimes() {
                const now = new Date();
                const utcTime = now.getTime() + now.getTimezoneOffset() * 60000;
                
                appData.timezones.forEach((timezone, index) => {
                    const element = document.querySelector(`[data-timezone="${index}"]`);
                    if (element) {
                        const localTime = new Date(utcTime + timezone.offset * 3600000);
                        element.textContent = localTime.toLocaleTimeString();
                    }
                });
                
                const minutes = now.getMinutes();
                const nextBreak = 30 - (minutes % 30);
                document.getElementById('nextBreak').textContent = nextBreak;
            }
            
            updateTimes();
            setInterval(updateTimes, 1000);
            
            setInterval(() => {
                appData.stats.onlineHours += 5 / 60;
                renderStats();
            }, 5 * 60 * 1000);
        }

        function setupScrollHandling() {
            const navButtons = document.getElementById('navButtons');
            
            function showButtons() {
                navButtons.classList.remove('nav-btn-hidden');
                navButtons.classList.add('nav-btn-visible');
            }
            
            function hideButtons() {
                navButtons.classList.remove('nav-btn-visible');
                navButtons.classList.add('nav-btn-hidden');
            }
            
            window.addEventListener('scroll', () => {
                showButtons();
                
                clearTimeout(scrollTimer);
                scrollTimer = setTimeout(hideButtons, 3000);
            });
            
            showButtons();
            scrollTimer = setTimeout(hideButtons, 3000);
        }

        function setupEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }
            });
            
            document.getElementById('editButton').addEventListener('click', () => {
                document.getElementById('githubConfigModal').classList.remove('hidden');
            });
            
            document.getElementById('closeEditBtn').addEventListener('click', () => {
                document.getElementById('editPage').classList.add('translate-x-full');
            });
            
            document.getElementById('closeConfigModal').addEventListener('click', () => {
                document.getElementById('githubConfigModal').classList.add('hidden');
            });
            
            document.getElementById('saveGitHubConfig').addEventListener('click', () => {
                const repo = document.getElementById('githubRepo').value.trim();
                const token = document.getElementById('githubToken').value.trim();
                
                appData.github = { repo, token };
                localStorage.setItem('githubConfig', JSON.stringify(appData.github));
                
                document.getElementById('githubConfigModal').classList.add('hidden');
                document.getElementById('editPage').classList.remove('translate-x-full');
                
                showNotification('GitHub配置已保存');
            });
            
            document.getElementById('importBookmarks').addEventListener('click', () => {
                document.getElementById('bookmarkFile').click();
            });
            
            document.getElementById('bookmarkFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const newBookmarks = parseBookmarkHtml(event.target.result);
                            appData.bookmarks = mergeBookmarks(appData.bookmarks, newBookmarks);
                            
                            let totalNew = 0;
                            for (const [group, bms] of Object.entries(newBookmarks)) {
                                totalNew += bms.length;
                            }
                            
                            renderBookmarks();
                            showNotification(`成功导入 ${totalNew} 个书签（已去重）`, 'success');
                        } catch (error) {
                            console.error('解析书签失败', error);
                            showNotification('导入书签失败，请检查文件格式', 'error');
                        }
                    };
                    reader.readAsText(file);
                } catch (error) {
                    console.error('读取文件失败', error);
                    showNotification('读取文件失败', 'error');
                }
                
                document.getElementById('bookmarkFile').value = '';
            });
            
            document.getElementById('exportBookmarks').addEventListener('click', () => {
                let html = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>书签导出</TITLE>
<H1>书签</H1>
<DL><p>`;
                
                for (const [groupName, bookmarks] of Object.entries(appData.bookmarks)) {
                    if (bookmarks.length === 0) continue;
                    
                    html += `<DT><H3>${groupName}</H3>
<DL><p>`;
                    
                    bookmarks.forEach(bookmark => {
                        html += `<DT><A HREF="${bookmark.url}">${bookmark.name}</A>`;
                    });
                    
                    html += `</DL><p>`;
                }
                
                html += `</DL>`;
                
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bookmarks_${new Date().toISOString().slice(0,10)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('书签已导出', 'success');
            });
            
            document.getElementById('backupJSON').addEventListener('click', () => {
                const dataStr = JSON.stringify(appData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('JSON备份已创建', 'success');
            });
            
            document.getElementById('loadJSON').addEventListener('click', () => {
                document.getElementById('jsonFile').click();
            });
            
            document.getElementById('jsonFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        if (backupData.bookmarks) appData.bookmarks = backupData.bookmarks;
                        if (backupData.ads) appData.ads = backupData.ads;
                        if (backupData.timezones) appData.timezones = backupData.timezones;
                        if (backupData.stats) appData.stats = backupData.stats;
                        
                        renderBookmarks();
                        renderTimezones();
                        renderTimezonesEdit();
                        renderStats();
                        updateAdPreviews();
                        
                        showNotification('备份数据已载入', 'success');
                    } catch (error) {
                        console.error('解析备份文件失败', error);
                        showNotification('载入备份失败，请检查文件格式', 'error');
                    }
                };
                reader.readAsText(file);
                
                document.getElementById('jsonFile').value = '';
            });
            
            document.getElementById('addNewBookmark').addEventListener('click', () => {
                document.getElementById('bookmarkModalTitle').textContent = '添加新书签';
                document.getElementById('newBookmarkUrl').value = '';
                document.getElementById('newBookmarkName').value = '';
                document.getElementById('newBookmarkGroupName').value = '';
                currentEditId = null;
                currentEditGroup = null;
                
                document.getElementById('addBookmarkModal').classList.remove('hidden');
            });
            
            document.getElementById('closeBookmarkModal').addEventListener('click', () => {
                document.getElementById('addBookmarkModal').classList.add('hidden');
            });
            
            document.getElementById('saveNewBookmark').addEventListener('click', () => {
                const url = document.getElementById('newBookmarkUrl').value.trim();
                let name = document.getElementById('newBookmarkName').value.trim();
                let groupName = document.getElementById('newBookmarkGroupName').value.trim() || 
                               document.getElementById('newBookmarkGroup').value;
                
                if (!url) {
                    showNotification('请输入网址', 'error');
                    return;
                }
                
                if (!name) {
                    try {
                        const urlObj = new URL(url);
                        name = urlObj.hostname.replace('www.', '');
                    } catch (e) {
                        name = '未命名网站';
                    }
                }
                
                if (!appData.bookmarks[groupName]) {
                    appData.bookmarks[groupName] = [];
                }
                
                if (currentEditId && currentEditGroup) {
                    const group = appData.bookmarks[currentEditGroup];
                    const index = group.findIndex(bm => bm.id === currentEditId);
                    
                    if (index !== -1) {
                        group[index].url = url;
                        group[index].name = name;
                        
                        if (groupName !== currentEditGroup) {
                            const bookmark = group.splice(index, 1)[0];
                            appData.bookmarks[groupName].push(bookmark);
                        }
                    }
                } else {
                    const isDuplicate = appData.bookmarks[groupName].some(bm => bm.url === url);
                    if (isDuplicate) {
                        showNotification('该网址已存在', 'warning');
                        return;
                    }
                    
                    appData.bookmarks[groupName].push({
                        id: 'bm_' + Date.now() + '_' + Math.floor(Math.random() * 1000),
                        url,
                        name,
                        visitCount: 0
                    });
                }
                
                renderBookmarks();
                document.getElementById('addBookmarkModal').classList.add('hidden');
                showNotification(currentEditId ? '书签已更新' : '书签已添加', 'success');
            });
            
            document.getElementById('editBookmarksContainer').addEventListener('click', (e) => {
                if (e.target.closest('.edit-bookmark')) {
                    const btn = e.target.closest('.edit-bookmark');
                    const id = btn.getAttribute('data-id');
                    const groupName = btn.getAttribute('data-group');
                    
                    const bookmark = appData.bookmarks[groupName].find(bm => bm.id === id);
                    if (bookmark) {
                        currentEditId = id;
                        currentEditGroup = groupName;
                        
                        document.getElementById('bookmarkModalTitle').textContent = '编辑书签';
                        document.getElementById('newBookmarkUrl').value = bookmark.url;
                        document.getElementById('newBookmarkName').value = bookmark.name;
                        document.getElementById('newBookmarkGroup').value = groupName;
                        document.getElementById('newBookmarkGroupName').value = '';
                        
                        document.getElementById('addBookmarkModal').classList.remove('hidden');
                    }
                } else if (e.target.closest('.delete-bookmark')) {
                    const btn = e.target.closest('.delete-bookmark');
                    currentDeleteId = btn.getAttribute('data-id');
                    currentDeleteGroup = btn.getAttribute('data-group');
                    currentDeleteType = 'bookmark';
                    
                    document.getElementById('deleteConfirmationText').textContent = '您确定要删除这个书签吗？';
                    document.getElementById('confirmDeleteModal').classList.remove('hidden');
                } else if (e.target.closest('.delete-group')) {
                    const btn = e.target.closest('.delete-group');
                    currentDeleteId = btn.getAttribute('data-group');
                    currentDeleteType = 'group';
                    
                    document.getElementById('deleteConfirmationText').textContent = '您确定要删除这个分组及其所有书签吗？';
                    document.getElementById('confirmDeleteModal').classList.remove('hidden');
                }
            });
            
            document.getElementById('cancelDelete').addEventListener('click', () => {
                document.getElementById('confirmDeleteModal').classList.add('hidden');
                currentDeleteId = null;
                currentDeleteType = null;
                currentDeleteGroup = null;
            });
            
            document.getElementById('confirmDelete').addEventListener('click', () => {
                if (currentDeleteType === 'bookmark' && currentDeleteGroup) {
                    appData.bookmarks[currentDeleteGroup] = appData.bookmarks[currentDeleteGroup].filter(
                        bm => bm.id !== currentDeleteId
                    );
                    
                    if (appData.bookmarks[currentDeleteGroup].length === 0) {
                        delete appData.bookmarks[currentDeleteGroup];
                    }
                    
                    renderBookmarks();
                    showNotification('书签已删除', 'success');
                } else if (currentDeleteType === 'group') {
                    delete appData.bookmarks[currentDeleteId];
                    renderBookmarks();
                    showNotification('分组已删除', 'success');
                } else if (currentDeleteType === 'timezone') {
                    appData.timezones.splice(currentDeleteId, 1);
                    renderTimezones();
                    renderTimezonesEdit();
                    showNotification('时区已删除', 'success');
                }
                
                document.getElementById('confirmDeleteModal').classList.add('hidden');
                currentDeleteId = null;
                currentDeleteType = null;
                currentDeleteGroup = null;
            });
            
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`ad${i}File`).addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (file.size > 3 * 1024 * 1024) {
                        showNotification('图片大小不能超过3MB', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        appData.ads[i].image = event.target.result;
                        document.getElementById(`ad${i}Preview`).src = event.target.result;
                        document.getElementById(`ad${i}Img`).src = event.target.result;
                        showNotification(`广告${i}图片已更新`, 'success');
                    };
                    reader.readAsDataURL(file);
                    
                    document.getElementById(`ad${i}File`).value = '';
                });
                
                document.getElementById(`saveAd${i}`).addEventListener('click', () => {
                    appData.ads[i].url = document.getElementById(`ad${i}Url`).value.trim();
                    document.getElementById(`ad${i}Link`).href = appData.ads[i].url || '#';
                    showNotification(`广告${i}设置已保存`, 'success');
                });
            }
            
            document.getElementById('addTimezone').addEventListener('click', () => {
                document.getElementById('timezoneCity').value = '';
                document.getElementById('timezoneOffset').value = '';
                document.getElementById('addTimezoneModal').classList.remove('hidden');
            });
            
            document.getElementById('addTimezoneBtn').addEventListener('click', () => {
                document.getElementById('timezoneCity').value = '';
                document.getElementById('timezoneOffset').value = '';
                document.getElementById('addTimezoneModal').classList.remove('hidden');
            });
            
            document.getElementById('closeTimezoneModal').addEventListener('click', () => {
                document.getElementById('addTimezoneModal').classList.add('hidden');
            });
            
            document.getElementById('saveNewTimezone').addEventListener('click', () => {
                const city = document.getElementById('timezoneCity').value.trim();
                const offset = parseFloat(document.getElementById('timezoneOffset').value);
                
                if (!city || isNaN(offset)) {
                    showNotification('请填写完整的时区信息', 'error');
                    return;
                }
                
                appData.timezones.push({ city, offset });
                renderTimezones();
                renderTimezonesEdit();
                
                document.getElementById('addTimezoneModal').classList.add('hidden');
                showNotification('时区已添加', 'success');
            });
            
            document.getElementById('timezonesEdit').addEventListener('click', (e) => {
                if (e.target.closest('.delete-timezone')) {
                    const btn = e.target.closest('.delete-timezone');
                    currentDeleteId = parseInt(btn.getAttribute('data-index'));
                    currentDeleteType = 'timezone';
                    
                    document.getElementById('deleteConfirmationText').textContent = '您确定要删除这个时区吗？';
                    document.getElementById('confirmDeleteModal').classList.remove('hidden');
                }
            });
            
            document.getElementById('takeBreakBtn').addEventListener('click', () => {
                alert('是时候休息一下了！站起来活动活动，让眼睛远离屏幕几分钟。');
            });
            
            document.getElementById('saveChanges').addEventListener('click', async () => {
                const success = await saveDataToGitHub();
                if (success) {
                    document.getElementById('editPage').classList.add('translate-x-full');
                }
            });
            
            document.getElementById('bookmarkGroups').addEventListener('click', (e) => {
                const bookmarkCard = e.target.closest('.bookmark-card');
                if (bookmarkCard) {
                    const id = bookmarkCard.getAttribute('data-id');
                    
                    for (const group of Object.values(appData.bookmarks)) {
                        const bookmark = group.find(bm => bm.id === id);
                        if (bookmark) {
                            bookmark.visitCount = (bookmark.visitCount || 0) + 1;
                            appData.stats.todayVisits += 1;
                            renderStats();
                            break;
                        }
                    }
                }
            });
            
            document.getElementById('frequentBookmarks').addEventListener('click', (e) => {
                const bookmarkCard = e.target.closest('.bookmark-card');
                if (bookmarkCard) {
                    const id = bookmarkCard.getAttribute('data-id');
                    
                    for (const group of Object.values(appData.bookmarks)) {
                        const bookmark = group.find(bm => bm.id === id);
                        if (bookmark) {
                            bookmark.visitCount = (bookmark.visitCount || 0) + 1;
                            appData.stats.todayVisits += 1;
                            renderStats();
                            break;
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
    