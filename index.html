<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceNavigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'space-dark': '#0f172a',
                        'space-darker': '#0a0f1d',
                        'space-light': '#1e293b',
                        'space-accent': '#3b82f6',
                        'space-nebula': '#8b5cf6',
                        'space-glow': '#e0e7ff'
                    },
                    fontFamily: {
                        space: ['Orbitron', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .star {
                position: absolute;
                background-color: white;
                border-radius: 50%;
                animation: twinkle 2s infinite ease-in-out;
            }
            @keyframes twinkle {
                0%, 100% { opacity: 0.5; }
                50% { opacity: 1; }
            }
            .widget-card {
                @apply bg-space-light/40 backdrop-blur-md rounded-xl border border-space-accent/20 overflow-hidden transition-all duration-300 hover:border-space-accent/50 hover:shadow-lg hover:shadow-space-accent/10;
            }
            .widget-header {
                @apply px-4 py-3 border-b border-space-accent/20 flex justify-between items-center;
            }
            .widget-title {
                @apply font-medium text-space-glow flex items-center;
            }
            .search-suggestion {
                @apply px-4 py-2 hover:bg-space-light/50 cursor-pointer transition-colors text-sm;
            }
            .search-suggestion-active {
                @apply bg-space-accent/20;
            }
        }
    </style>
</head>
<body class="bg-space-dark text-white min-h-screen relative overflow-x-hidden">
    <div id="stars" class="fixed inset-0 z-0"></div>
    
    <header id="header" class="bg-space-dark/80 backdrop-blur-md py-4 border-b border-space-accent/20 relative z-10 transition-all duration-500">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-compass text-space-accent text-xl"></i>
                <h1 class="text-lg font-bold font-space">SpaceNavigator</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-space-light/30 transition-colors touch-target">
                    <i class="fa fa-moon-o text-space-accent"></i>
                </button>
                <button id="settings-btn" class="p-2 rounded-full hover:bg-space-light/30 transition-colors touch-target">
                    <i class="fa fa-cog text-space-accent"></i>
                </button>
            </div>
        </div>
    </header>
    
    <main class="container mx-auto px-4 py-8 relative z-10">
        <!-- 日期和时间 -->
        <div class="widget-card mb-8">
            <div class="p-6">
                <div id="time-display" class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-space-accent to-space-nebula mb-2">
                    00:00:00
                </div>
                <div id="date-display" class="text-center text-gray-400">
                    2023年1月1日 星期日
                </div>
            </div>
        </div>
        
        <div class="widget-card">
            <div class="p-4">
                <!-- 优化的搜索引擎 -->
                <div class="relative">
                    <!-- 搜索类型切换 -->
                    <div class="flex border-b border-space-accent/30 mb-2">
                        <button id="search-type-site" class="flex-1 py-1 text-sm font-medium text-space-glow border-b-2 border-space-accent">站内搜索</button>
                        <button id="search-type-web" class="hidden flex-1 py-1 text-sm font-medium text-gray-400 hover:text-white">网页搜索</button>
                    </div>
                    
                    <input type="text" id="search-input" placeholder="搜索书签..." class="w-full bg-space-darker border border-space-accent/30 rounded-lg px-4 py-3 pr-10 focus:outline-none focus:border-space-accent transition-colors text-base">
                    <button id="search-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-space-accent transition-colors touch-target">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
                
                <!-- 搜索建议 -->
                <div id="search-suggestions" class="absolute left-4 right-4 mt-1 bg-space-light rounded-lg shadow                    border border-space-accent/30 shadow-lg z-20 hidden max-h-60 overflow-y-auto scrollbar-hide">
                    <!-- 搜索建议将通过JS动态生成 -->
                </div>
                
                <!-- 搜索历史 -->
                <div id="search-history" class="mt-3 hidden">
                    <div class="flex justify-between items-center text-xs text-gray-500 mb-1">
                        <span>搜索历史</span>
                        <button id="clear-history" class="hover:text-space-accent">清除</button>
                    </div>
                    <div id="history-list" class="flex flex-wrap gap-2">
                        <!-- 搜索历史将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 搜索引擎切换 (已隐藏网页搜索相关) -->
                <div id="web-search-options" class="mt-4 flex justify-between text-sm text-gray-400 hidden">
                    <div class="flex space-x-3">
                        <button class="search-engine-btn active px-2 py-1 rounded hover:bg-space-light/30 transition-colors" data-engine="baidu">百度</button>
                        <button class="search-engine-btn px-2 py-1 rounded hover:bg-space-light/30 transition-colors" data-engine="google">谷歌</button>
                        <button class="search-engine-btn px-2 py-1 rounded hover:bg-space-light/30 transition-colors" data-engine="bing">必应</button>
                    </div>
                    <button id="search-settings" class="hover:text-space-accent transition-colors touch-target">
                        <i class="fa fa-sliders mr-1"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 时区和使用统计 - 移动端堆叠布局 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="widget-card">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fa fa-globe mr-2"></i>世界时钟
                    </h3>
                </div>
                <div id="timezones-container" class="p-4 grid grid-cols-2 gap-4">
                    <!-- 时区将通过JS动态生成 -->
                </div>
            </div>
            
            <div class="widget-card">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fa fa-line-chart mr-2"></i>使用统计
                    </h3>
                </div>
                <div class="p-4">
                    <canvas id="usage-chart" height="180"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 广告位 1 - 响应式尺寸 -->
        <div class="my-8 rounded rounded-xl overflow-hidden border border-space-accent/30 relative group widget-card">
            <div class="ad-container aspect-video bg-space-light/30 flex items-center justify-center overflow-hidden">
                <img id="ad1-img" src="https://picsum.photos/1200/400?random=1" alt="广告图片1" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                <a id="ad1-link" href="#" target="_blank" class="absolute inset-0"></a>
            </div>
        </div>
        
        <!-- 书签分类和内容 - 移动端自适应网格 -->
        <div id="bookmarks-container" class="space-y-6">
            <!-- 书签分组将通过JS动态生成 -->
        </div>
        
        <!-- 广告位 2 -->
        <div class="my-8 rounded-xl overflow overflow-hidden border border-space-accent/30 relative group widget-card">
            <div class="ad-container aspect-[21/9] bg-space-light/30 flex items-center justify-center overflow-hidden">
                <img id="ad2-img" src="https://picsum.photos/1200/400?random=2" alt="广告图片2" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                <a id="ad2-link" href="#" target="_blank" class="absolute inset-0"></a>
            </div>
        </div>
        
        <!-- 广告位 3 -->
        <div class="my-8 rounded-xl overflow-hidden border border-space-accent/30 relative group widget-card">
            <div class="ad-container aspect-[21/9] bg-space-light/30 flex items-center justify-center overflow-hidden">
                <img id="ad3-img" src="https://picsum.photos/1200/400?random=3" alt="广告图片3" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                <a id="ad3-link" href="#" target="_blank" class="absolute inset-0"></a>
            </div>
        </div>
    </main>
    
    <!-- 底部信息 -->
    <footer class="bg-space-dark/80 backdrop-blur-md py-4 border-t border-space-accent/20 relative z-10">
        <div class="container mx-auto px-4">
            <div class="dark-white flex flex-col md:flex-row justify-between items-center">
                <div>共收录<span id="total-bookmarks">0</span>个网站</div>
                <div class="mt-2 md:mt-0">Copyright © 2018-<span id="current-year"></span> <span id="hostname">SpaceNavigator</span>, All Rights Reserved</div>
            </div>
        </div>
    </footer>
    
    <!-- 设置对话框 - 移动端适配 -->
    <div id="settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-space-light rounded-xl w-full max-w-md p-6 border border-space-accent/30 relative mx-4">
            <button id="close-settings" class="absolute top-4 right-4 text-gray-400 hover:text-white touch-target">
                <i class="fa fa-times"></i>
            </button>
            <h2 class="text-xl font-bold mb-4 text-center">GitHub 配置</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-300 mb-1">仓库 (username/repo-name)</label>
                    <input type="text" id="github-repo" placeholder="username/repo-name" class="w-full bg-space-dark border border-space-accent/50 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-space-accent" readonly>
                </div>
                <div>
                    <label class="block text-sm text-gray-300 mb-1">个人访问令牌 (Token)</label>
                    <input type="password" id="github-token" placeholder="ghp_..." class="w-full bg-space-dark border border-space-accent/50 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-space-accent">
                    <p class="text-xs text-gray-500 mt-1">需要 repo 权限，用于读写书签数据</p>
                </div>
                <button id="authenticate-btn" class="w-full bg-gradient-to-r from-space-accent to-space-nebula py-3 rounded-lg hover:opacity-90 transition transition-opacity font-medium">
                    验证并进入编辑模式
                </button>
                <p class="text-xs text-center text-gray-500">未配置时将使用默认公开仓库</p>
            </div>
        </div>
    </div>
    
    <!-- 编辑页 - 移动端滚动优化 -->
    <div id="editor-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-space-light rounded-xl w-full max-w-5xl max-h-[90vh] overflow-hidden border border-space-accent/30 flex flex flex-col">
                <div class="p-4 border-b border-space-accent/20 flex justify-between items-center">
                    <h2 class="text-xl font-bold">书签编辑中心</h2>
                    <div class="flex space-x-2">
                        <button id="import-bookmarks" class="px-3 py-2 text-sm bg-space-dark rounded hover:bg-space-darker transition-colors touch-target">
                            <i class="fa fa-upload mr-1"></i>导入
                        </button>
                        <button id="export-bookmarks" class="px-3 py-2 text-sm bg-space-dark rounded hover:bg-space-darker transition-colors touch-target">
                            <i class="fa fa-download mr-1"></i>导出
                        </button>
                        <button id="close-editor" class="touch-target p-2 text-gray-400 hover:text-white">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex flex-1 overflow-hidden flex-col md:flex-row">
                    <!-- 书签编辑区 - 移动端优先显示 -->
                    <div class="flex-1 overflow-y-auto p-4">
                        <h3 class="text-lg font-semibold mb-3">书签管理</h3>
                        <div class="mb-4">
                            <button id="add-bookmark-group" class="px-4 py-2 bg-space-accent/20 hover:bg-space-accent/30 rounded-lg transition-colors text-sm touch-target">
                                <i class="fa fa-folder-open-o mr-1"></i>添加书签组
                            </button>
                        </div>
                        <div id="bookmarks-editor-container" class="space-y-6">
                            <!-- 编辑区书签内容将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 广告和时区编辑区 - 移动端可滚动 -->
                    <div class="w-full md:w-80 border-t md:border-t-0 md:border-l border-space-accent/20 p-4 overflow-y-auto">
                        <h3 class="text-lg font-semibold mb-3">广告管理</h3>
                        <div class="space-y-6">
                            <!-- 广告1编辑 -->
                            <div class="bg-space-dark/50 rounded-lg p-3">
                                <h4 class="text-sm font-medium mb-2">广告位 1</h4>
                                <div class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">图片URL</label>
                                        <input type="text" id="ad1-url-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-sm text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">链接URL</label>
                                        <input type="text" id="ad1-link-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-sm text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">上传图片</label>
                                        <input type="file" id="ad1-upload" accept="image/*" class="w-full text-xs text-gray-400">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 广告2编辑 -->
                            <div class="bg-space-dark/50 rounded-lg p-3">
                                <h4 class="text-sm font-medium mb-2">广告位 2</h4>
                                <div class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">图片URL</label>
                                        <input type="text" id="ad2-url-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-sm text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">链接URL</label>
                                        <input type="text" id="ad2-link-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-sm text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">上传图片</label>
                                        <input type="file" id="ad2-upload" accept="image/*" class="w-full text-xs text-gray-400">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 广告3编辑 -->
                            <div class="bg-space-dark/50 rounded-lg p-3">
                                <h4 class="text-sm font-medium mb-2">广告位 3</h4>
                                <div class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">图片URL</label>
                                        <input type="text" id="ad3-url-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-sm text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">链接URL</label>
                                        <input type="text" id="ad3-link-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-sm text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">上传图片</label>
                                        <input type="file" id="ad3-upload" accept="image/*" class="w-full text-xs text-gray-400">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 时区编辑区 - 仅在编辑中心显示 -->
                        <h3 class="text-lg font-semibold mb-3 mt-8">时区管理</h3>
                        <div class="space-y-4">
                            <div class="flex">
                                <input type="text" id="new-timezone" placeholder="城市名称 (例如: 纽约, 伦敦, 东京)" class="flex-1 bg-space-dark border border-space-accent/50 rounded-l-lg px-3 py-2 text-white focus:outline-none focus:ring-1 focus:ring-space-accent">
                                <button id="add-timezone-btn" class="bg-space-accent px-4 py-2 rounded-r-lg hover:bg-space-accent/80 transition-colors touch-target">
                                    添加
                                </button>
                            </div>
                            <div id="timezones-list" class="space-y-2 max-h-60 overflow-y-auto scrollbar-hide">
                                <!-- 时区列表将通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-space-accent/20 flex justify-between items-center">
                    <div>
                        <span id="bookmark-count-display" class="text-sm text-gray-400">共 0 个书签</span>
                    </div>
                    <button id="save-changes" class="px-6 py-3 bg-gradient-to-r from-space-accent to-space-nebula rounded-lg hover:opacity-90 transition-opacity font-medium touch-target">
                        保存更改
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 搜索设置对话框 -->
    <div id="search-settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-space-light rounded-xl w-full max-w-md p-6 border border-space-accent/30 relative mx-4">
            <button id="close-search-settings" class="absolute top-4 right-4 text-gray-400 hover:text-white touch-target">
                <i class="fa fa-times"></i>
            </button>
            <h2 class="text-xl font-bold mb-4">搜索设置</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-300 mb-1">默认搜索引擎</label>
                    <select id="default-search-engine" class="w-full bg-space-dark border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-space-accent">
                        <option value="baidu">百度</option>
                        <option value="google">谷歌</option>
                        <option value="bing">必应</option>
                    </select>
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="save-search-history" class="form-checkbox h-4 w-4 text-space-accent bg-space-dark border-gray-700 rounded">
                        <span class="ml-2 text-sm">保存搜索历史</span>
                    </label>
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="show-search-suggestions" class="form-checkbox h-4 w-4 text-space-accent bg-space-dark border-gray-700 rounded">
                        <span class="ml-2 text-sm">显示搜索建议</span>
                    </label>
                </div>
                <button id="save-search-settings" class="w-full bg-gradient-to-r from-space-accent to-space-nebula py-2 rounded-lg hover:opacity-90 transition-opacity font-medium">
                    保存设置
                </button>
            </div>
        </div>
    </div>
    
    <!-- 确认对话框 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-space-light rounded-xl w-full max-w-md p-6 border border-space-accent/30 mx-4">
            <h3 id="confirm-title" class="text-lg font-bold mb-2">确认操作</h3>
            <p id="confirm-message" class="text-gray-300 mb-4">确认要执行此操作吗？</p>
            <div class="flex space-x-3">
                <button id="cancel-confirm" class="flex-1 py-2 bg-space-dark border border-gray-700 rounded-lg hover:bg-space-darker transition-colors">
                    取消
                </button>
                <button id="confirm-action" class="flex-1 py-2 bg-gradient-to-r from-space-accent to-space-nebula rounded-lg hover:opacity-90 transition-opacity">
                    确认
                </button>
            </div>
        </div>
    </div>
    
    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-4 right-4 bg-space-light rounded-lg border border-space-accent/30 shadow-lg p-4 max-w-xs transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="flex items-start">
            <div id="notification-icon" class="mr-3 text-space-accent text-xl">
                <i class="fa fa-info-circle"></i>
            </div>
            <div class="flex-1">
                <h4 id="notification-title" class="font-medium">通知标题</h4>
                <p id="notification-message" class="text-sm text-gray-300 mt-1">通知内容</p>
            </div>
            <button id="close-notification" class="text-gray-400 hover:text-white ml-2">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>
    
    <script>
        // 由GitHub Actions自动注入的仓库信息（部署时替换）
        const DEFAULT_REPO = "your-username/your-repo"; // 占位符，Actions会替换
        const DEFAULT_RAW_URL = `https://raw.githubusercontent.com/${DEFAULT_REPO}/main/bookmarks.json`;
        
        // 搜索引擎配置
        const searchEngines = {
            baidu: {
                url: 'https://www.baidu.com/s',
                param: 'wd'
            },
            google: {
                url: 'https://www.google.com/search',
                param: 'q'
            },
            bing: {
                url: 'https://www.bing.com/search',
                param: 'q'
            }
        };
        
        // 应用数据
        const appData = {
            bookmarks: [],
            ads: [
                { imgUrl: 'https://picsum.photos/1200/400?random=1', linkUrl: '#' },
                { imgUrl: 'https://picsum.photos/1200/400?random=2', linkUrl: '#' },
                { imgUrl: 'https://picsum.photos/1200/400?random=3', linkUrl: '#' }
            ],
            timezones: [],
            github: {
                repo: DEFAULT_REPO,
                token: ''
            },
            search: {
                type: 'site',
                engine: 'baidu',
                history: [],
                showSuggestions: true
            },
            usageData: [1.2, 0.8, 1.5, 0.6, 2.1, 1.8, 3.5],
            currentTheme: "dark"
        };
        
        // DOM元素
        const elements = {
            stars: document.getElementById('stars'),
            header: document.getElementById('header'),
            themeToggle: document.getElementById('theme-toggle'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettings: document.getElementById('close-settings'),
            githubRepo: document.getElementById('github-repo'),
            githubToken: document.getElementById('github-token'),
            authenticateBtn: document.getElementById('authenticate-btn'),
            editorModal: document.getElementById('editor-modal'),
            closeEditor: document.getElementById('close-editor'),
            bookmarksContainer: document.getElementById('bookmarks-container'),
            bookmarksEditorContainer: document.getElementById('bookmarks-editor-container'),
            importBookmarks: document.getElementById('import-bookmarks'),
            exportBookmarks: document.getElementById('export-bookmarks'),
            saveChanges: document.getElementById('save-changes'),
            addBookmarkGroup: document.getElementById('add-bookmark-group'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            cancelConfirm: document.getElementById('cancel-confirm'),
            confirmAction: document.getElementById('confirm-action'),
            notification: document.getElementById('notification'),
            notificationTitle: document.getElementById('notification-title'),
            notificationMessage: document.getElementById('notification-message'),
            notificationIcon: document.getElementById('notification-icon'),
            closeNotification: document.getElementById('close-notification'),
            totalBookmarks: document.getElementById('total-bookmarks'),
            currentYear: document.getElementById('current-year'),
            hostname: document.getElementById('hostname'),
            bookmarkCountDisplay: document.getElementById('bookmark-count-display'),
            newTimezone: document.getElementById('new-timezone'),
            addTimezoneBtn: document.getElementById('add-timezone-btn'),
            timezonesContainer: document.getElementById('timezones-container'),
            timezonesList: document.getElementById('timezones-list'),
            timeDisplay: document.getElementById('time-display'),
            dateDisplay: document.getElementById('date-display'),
            ad1Img: document.getElementById('ad1-img'),
            ad1Link: document.getElementById('ad1-link'),
            ad1UrlInput: document.getElementById('ad1-url-input'),
            ad1LinkInput: document.getElementById('ad1-link-input'),
            ad1Upload: document.getElementById('ad1-upload'),
            ad2Img: document.getElementById('ad2-img'),
            ad2Link: document.getElementById('ad2-link'),
            ad2UrlInput: document.getElementById('ad2-url-input'),
            ad2LinkInput: document.getElementById('ad2-link-input'),
            ad2Upload: document.getElementById('ad2-upload'),
            ad3Img: document.getElementById('ad3-img'),
            ad3Link: document.getElementById('ad3-link'),
            ad3UrlInput: document.getElementById('ad3-url-input'),
            ad3LinkInput: document.getElementById('ad3-link-input'),
            ad3Upload: document.getElementById('ad3-upload'),
            // 搜索引擎相关元素
            searchInput: document.getElementById('search-input'),
            searchBtn: document.getElementById('search-btn'),
            searchSuggestions: document.getElementById('search-suggestions'),
            searchHistory: document.getElementById('search-history'),
            historyList: document.getElementById('history-list'),
            clearHistory: document.getElementById('clear-history'),
            searchSettings: document.getElementById('search-settings'),
            searchSettingsModal: document.getElementById('search-settings-modal'),
            closeSearchSettings: document.getElementById('close-search-settings'),
            defaultSearchEngine: document.getElementById('default-search-engine'),
            saveSearchHistory: document.getElementById('save-search-history'),
            showSearchSuggestions: document.getElementById('show-search-suggestions'),
            saveSearchSettings: document.getElementById('save-search-settings'),
            // 搜索类型切换（仅保留网页搜索）
            searchTypeSite: document.getElementById('search-type-site'),
            searchTypeWeb: document.getElementById('search-type-web'),
            webSearchOptions: document.getElementById('web-search-options'),
            // 搜索结果
            searchResultsContainer: document.getElementById('search-results-container'),
            searchResults: document.getElementById('search-results'),
            searchResultsCount: document.getElementById('search-results-count'),
            clearSearch: document.getElementById('clear-search')
        };
        
        // 确认对话框回调
        let confirmCallback = null;
        let scrollTimer;
        let searchSuggestionIndex = -1;
        let searchSuggestionTimeout = null;
        
        // 城市到时区的映射表
        const cityToTimezone = {
            '北京': 'Asia/Shanghai',
            '上海': 'Asia/Shanghai',
            '香港': 'Asia/Hong_Kong',
            '台北': 'Asia/Taipei',
            '东京': 'Asia/Tokyo',
            '首尔': 'Asia/Seoul',
            '伦敦': 'Europe/London',
            '巴黎': 'Europe/Paris',
            '柏林': 'Europe/Berlin',
            '纽约': 'America/New_York',
            '洛杉矶': 'America/Los_Angeles',
            '芝加哥': 'America/Chicago',
            '悉尼': 'Australia/Sydney',
            '莫斯科': 'Europe/Moscow',
            '新加坡': 'Asia/Singapore',
            '曼谷': 'Asia/Bangkok',
            '迪拜': 'Asia/Dubai'
        };
        
        // 初始化函数
        async function init() {
            createStars();
            initUsageChart();
            setupEventListeners();
            loadLocalSettings();
            
            // 自动填充仓库信息
            document.getElementById('github-repo').value = DEFAULT_REPO;
            
            // 确保搜索类型为站内搜索
            appData.search.type = 'site';
            elements.webSearchOptions.classList.add('hidden');
            
            await loadDataFromGitHub();
            renderTimezones();
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000);
            renderBookmarks();
            updateBookmarkCount();
            setupAdEditor();
            elements.currentYear.textContent = new Date().getFullYear();
            
            // 初始化搜索引擎
            initSearchEngine();
            loadSearchHistory();
            renderSearchHistory();
            
            // 检查主题设置并应用
            if (appData.currentTheme === 'light') {
                switchToLightMode();
            } else {
                switchToDarkMode();
            }
            
            // 初始化部署时间（首次使用时设置）
            if (!localStorage.getItem('initialDeploymentDate')) {
                localStorage.setItem('initialDeploymentDate', new Date().toISOString());
            }
        }
        
        // 创建星空背景
        function createStars() {
            const starsCount = 150;
            for (let i = 0; i < starsCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // 随机大小和位置
                const size = Math.random() * 2;
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const delay = Math.random() * 5;
                
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.animationDelay = `${delay}s`;
                
                elements.stars.appendChild(star);
            }
        }
        
        // 初始化使用统计图表
        function initUsageChart() {
            const ctx = document.getElementById('usage-chart').getContext('2d');
            
            // 获取初始部署日期
            const initialDate = new Date(localStorage.getItem('initialDeploymentDate') || new Date());
            const today = new Date();
            const daysSinceDeployment = Math.ceil((today - initialDate) / (1000 * 60 * 60 * 24));
            
            // 生成基于部署天数的统计数据
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(today.getDate() - i);
                labels.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                
                // 生成模拟数据，随部署时间增长
                const baseValue = Math.min(5, 1 + daysSinceDeployment / 10);
                data.push((baseValue + Math.random() * 2).toFixed(1));
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '使用次数',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 主题切换
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            // 设置按钮
            elements.settingsBtn.addEventListener('click', () => {
                elements.settingsModal.classList.remove('hidden');
            });
            
            // 关闭设置
            elements.closeSettings.addEventListener('click', () => {
                elements.settingsModal.classList.add('hidden');
            });
            
            // 验证GitHub
            elements.authenticateBtn.addEventListener('click', async () => {
                appData.github.repo = elements.githubRepo.value.trim();
                appData.github.token = elements.githubToken.value.trim();
                
                if (!appData.github.repo || !appData.github.token) {
                    showNotification('验证失败', '请填写仓库和Token信息', 'error');
                    return;
                }
                
                const isVerified = await verifyGitHubToken();
                if (isVerified) {
                    saveLocalSettings();
                    elements.settingsModal.classList.add('hidden');
                    elements.editorModal.classList.remove('hidden');
                    showNotification('验证成功', '已进入编辑模式', 'success');
                } else {
                    showNotification('验证失败', '仓库或Token信息不正确', 'error');
                }
            });
            
            // 关闭编辑模式
            elements.closeEditor.addEventListener('click', () => {
                elements.editorModal.classList.add('hidden');
            });
            
            // 添加书签组
            elements.addBookmarkGroup.addEventListener('click', addNewBookmarkGroup);
            
            // 导入书签
            elements.importBookmarks.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.html';
                
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (file) {
                        importHTMLBookmarks(file);
                    }
                };
                
                input.click();
            });
            
            // 导出书签
            elements.exportBookmarks.addEventListener('click', exportHTMLBookmarks);
            
            // 保存更改
            elements.saveChanges.addEventListener('click', async () => {
                saveAdSettings();
                const success = await saveDataToGitHub();
                if (success) {
                    renderBookmarks();
                    setupBookmarkEventListeners();
                    renderTimezones(); // 保存后更新时区显示
                    elements.editorModal.classList.add('hidden');
                }
            });
            
            // 取消确认
            elements.cancelConfirm.addEventListener('click', () => {
                elements.confirmModal.classList.add('hidden');
                confirmCallback = null;
            });
            
            // 确认操作
            elements.confirmAction.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                elements.confirmModal.classList.add('hidden');
                confirmCallback = null;
            });
            
            // 关闭通知
            elements.closeNotification.addEventListener('click', hideNotification);
            
            // 广告图片上传
            elements.ad1Upload.addEventListener('change', handleAdImageUpload(0));
            elements.ad2Upload.addEventListener('change', handleAdImageUpload(1));
            elements.ad3Upload.addEventListener('change', handleAdImageUpload(2));
            
            // 滚动事件 - 控制顶部导航栏显示/隐藏
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimer);
                
                if (window.scrollY > 100) {
                    elements.header.classList.add('opacity-0', 'pointer-events-none');
                    elements.header.classList.remove('opacity-100', 'pointer-events-auto');
                } else {
                    elements.header.classList.remove('opacity-0', 'pointer-events-none');
                    elements.header.classList.add('opacity-100', 'pointer-events-auto');
                }
                
                scrollTimer = setTimeout(() => {
                    if (window.scrollY > 100) {
                        elements.header.classList.add('opacity-0', 'pointer-events-none');
                        elements.header.classList.remove('opacity-100', 'pointer-events-auto');
                    }
                }, 3000);
            });
            
            // 搜索引擎切换（仅保留站内搜索）
            document.querySelectorAll('.search-engine-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    appData.search.engine = btn.dataset.engine;
                    saveSearchSettings();
                    initSearchEngine();
                });
            });
            
            // 搜索类型切换（禁用网页搜索）
            elements.searchTypeSite.addEventListener('click', () => {
                setSearchType('site');
            });
            
            elements.searchTypeWeb.addEventListener('click', () => {
                // 保持站内搜索
                setSearchType('site');
            });
            
            // 搜索按钮点击
            elements.searchBtn.addEventListener('click', () => {
                performSearch(elements.searchInput.value);
            });
            
            // 搜索输入框回车
            elements.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(elements.searchInput.value);
                    hideSearchSuggestions();
                }
            });
            
            // 搜索输入框输入
            elements.searchInput.addEventListener('input', handleSearchInput);
            
            // 搜索输入框获得焦点
            elements.searchInput.addEventListener('focus', () => {
                if (appData.search.saveHistory && appData.search.history.length > 0) {
                    elements.searchHistory.classList.remove('hidden');
                }
                if (elements.searchInput.value.trim()) {
                    handleSearchInput();
                }
            });
            
            // 清除搜索历史
            elements.clearHistory.addEventListener('click', clearSearchHistory);
            
            // 清除搜索结果
            elements.clearSearch.addEventListener('click', clearSearchResults);
            
            // 打开搜索设置
            elements.searchSettings.addEventListener('click', () => {
                elements.searchSettingsModal.classList.remove('hidden');
            });
            
            // 关闭搜索设置
            elements.closeSearchSettings.addEventListener('click', () => {
                elements.searchSettingsModal.classList.add('hidden');
            });
            
            // 保存搜索设置
            elements.saveSearchSettings.addEventListener('click', () => {
                saveSearchSettings();
                elements.searchSettingsModal.classList.add('hidden');
                showNotification('设置已保存', '搜索设置已更新', 'success');
            });
            
            // 点击页面其他地方隐藏搜索建议和历史
            document.addEventListener('click', (e) => {
                if (!elements.searchInput.contains(e.target) && 
                    !elements.searchSuggestions.contains(e.target) &&
                    !elements.searchHistory.contains(e.target) &&
                    !elements.searchSettings.contains(e.target) &&
                    !elements.searchResultsContainer.contains(e.target)) {
                    hideSearchSuggestions();
                    elements.searchHistory.classList.add('hidden');
                }
            });
        }
        
        // 设置书签事件监听器
        function setupBookmarkEventListeners() {
            // 先移除旧的事件监听器，避免重复绑定
            const editorContainer = elements.bookmarksEditorContainer;
            const newContainer = editorContainer.cloneNode(true);
            editorContainer.parentNode.replaceChild(newContainer, editorContainer);
            elements.bookmarksEditorContainer = newContainer;
            
            // 重新绑定事件
            elements.bookmarksEditorContainer.addEventListener('click', (e) => {
                const addBtn = e.target.closest('.add-bookmark');
                if (addBtn) {
                    const groupIndex = parseInt(addBtn.dataset.index);
                    addNewBookmark(groupIndex);
                    return;
                }
                
                const deleteGroupBtn = e.target.closest('.delete-group');
                if (deleteGroupBtn) {
                    const groupIndex = parseInt(deleteGroupBtn.dataset.index);
                    confirmAction(
                        '删除书签组',
                        `您确定要删除"${appData.bookmarks[groupIndex].name}"书签组吗？此操作不可恢复。`,
                        () => {
                            appData.bookmarks.splice(groupIndex, 1);
                            renderBookmarks();
                            setupBookmarkEventListeners();
                            updateBookmarkCount();
                        }
                    );
                    return;
                }
                
                const deleteBookmarkBtn = e.target.closest('.delete-bookmark');
                if (deleteBookmarkBtn) {
                    const groupIndex = parseInt(deleteBookmarkBtn.dataset.groupIndex);
                    const bookmarkIndex = parseInt(deleteBookmarkBtn.dataset.bookmarkIndex);
                    confirmAction(
                        '删除书签',
                        `您确定要删除"${appData.bookmarks[groupIndex].bookmarks[bookmarkIndex].title}"吗？`,
                        () => {
                            appData.bookmarks[groupIndex].bookmarks.splice(bookmarkIndex, 1);
                            renderBookmarks();
                            setupBookmarkEventListeners();
                            updateBookmarkCount();
                        }
                    );
                    return;
                }
            });
            
            // 处理输入框变化
            elements.bookmarksEditorContainer.addEventListener('input', (e) => {
                // 组名称更新
                const groupNameInput = e.target.closest('.group-name-input');
                if (groupNameInput) {
                    const groupIndex = parseInt(groupNameInput.dataset.index);
                    const newValue = groupNameInput.value.trim() || '未命名组';
                    appData.bookmarks[groupIndex].name = newValue;
                    return;
                }
                
                // 书签标题更新
                const titleInput = e.target.closest('.bookmark-title-input');
                if (titleInput) {
                    const groupIndex = parseInt(titleInput.dataset.groupIndex);
                    const bookmarkIndex = parseInt(titleInput.dataset.bookmarkIndex);
                    const newValue = titleInput.value.trim();
                    appData.bookmarks[groupIndex].bookmarks[bookmarkIndex].title = newValue;
                    return;
                }
                
                // 书签URL更新
                const urlInput = e.target.closest('.bookmark-url-input');
                if (urlInput) {
                    const groupIndex = parseInt(urlInput.dataset.groupIndex);
                    const bookmarkIndex = parseInt(urlInput.dataset.bookmarkIndex);
                    const newValue = urlInput.value.trim();
                    appData.bookmarks[groupIndex].bookmarks[bookmarkIndex].url = newValue;
                    
                    // 尝试更新favicon
                    updateBookmarkFavicon(groupIndex, bookmarkIndex, newValue);
                    return;
                }
            });
        }
        
        // 更新书签favicon
        function updateBookmarkFavicon(groupIndex, bookmarkIndex, url) {
            if (!url) return;
            
            const bookmark = appData.bookmarks[groupIndex].bookmarks[bookmarkIndex];
            
            try {
                const urlObj = new URL(url);
                const faviconUrl = `${urlObj.protocol}//${urlObj.hostname}/favicon.ico`;
                
                // 测试favicon是否存在
                const testImg = new Image();
                testImg.onload = () => {
                    bookmark.favicon = faviconUrl;
                    renderBookmarks();
                    setupBookmarkEventListeners();
                };
                testImg.onerror = () => {
                    // 尝试使用第三方服务获取favicon
                    const thirdPartyFavicon = `https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=${encodeURIComponent(url)}&size=32`;
                    bookmark.favicon = thirdPartyFavicon;
                    renderBookmarks();
                    setupBookmarkEventListeners();
                };
                testImg.src = faviconUrl;
            } catch (e) {
                console.error('无法解析URL:', e);
                bookmark.favicon = '';
            }
        }
        
        // 更新书签计数
        function updateBookmarkCount() {
            let total = 0;
            appData.bookmarks.forEach(group => {
                total += group.bookmarks.length;
            });
            elements.totalBookmarks.textContent = total;
            elements.bookmarkCountDisplay.textContent = `共 ${total} 个书签`;
        }
        
        // 导入HTML书签
        function importHTMLBookmarks(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(e.target.result, 'text/html');
                    const bookmarks = doc.querySelectorAll('a');
                    
                    const newBookmarks = [];
                    let currentGroup = null;
                    
                    bookmarks.forEach(bookmark => {
                        if (bookmark.href && bookmark.href !== 'javascript:void(0);') {
                            // 查找父级文件夹
                            let parent = bookmark.parentNode;
                            while (parent && parent.tagName !== 'DL' && parent.tagName !== 'BODY') {
                                if (parent.tagName === 'H3') {
                                    const groupName = parent.textContent.trim() || '未命名组';
                                    currentGroup = {
                                        name: groupName,
                                        bookmarks: []
                                    };
                                    newBookmarks.push(currentGroup);
                                    break;
                                }
                                parent = parent.parentNode;
                            }
                            
                            if (!currentGroup) {
                                // 如果没有找到组，创建一个默认组
                                currentGroup = {
                                    name: '导入的书签',
                                    bookmarks: []
                                };
                                newBookmarks.push(currentGroup);
                            }
                            
                            // 添加书签
                            currentGroup.bookmarks.push({
                                title: bookmark.textContent.trim() || '未命名书签',
                                url: bookmark.href,
                                favicon: ''
                            });
                        } else if (bookmark.querySelector('h3')) {
                            // 书签组
                            const groupName = bookmark.querySelector('h3').textContent.trim() || '未命名组';
                            currentGroup = {
                                name: groupName,
                                bookmarks: []
                            };
                            newBookmarks.push(currentGroup);
                        }
                    });
                    
                    // 合并新书签（去重）
                    newBookmarks.forEach(newGroup => {
                        // 查找是否已有同名组
                        const existingGroup = appData.bookmarks.find(g => g.name === newGroup.name);
                        
                        if (existingGroup) {
                            // 向现有组添加新书签（去重）
                            newGroup.bookmarks.forEach(newBookmark => {
                                const isDuplicate = existingGroup.bookmarks.some(b => 
                                    b.url.toLowerCase() === newBookmark.url.toLowerCase()
                                );
                                
                                if (!isDuplicate) {
                                    existingGroup.bookmarks.push(newBookmark);
                                }
                            });
                        } else {
                            // 添加新组
                            appData.bookmarks.push(newGroup);
                        }
                    });
                    
                    renderBookmarks();
                    setupBookmarkEventListeners();
                    updateBookmarkCount();
                    showNotification('导入成功', `成功导入 ${newBookmarks.length} 个书签组`, 'success');
                } catch (error) {
                    console.error('导入书签失败:', error);
                    showNotification('导入失败', '无法解析书签文件', 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // 导出HTML书签
        function exportHTMLBookmarks() {
            let html = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>书签导出</TITLE>
<H1>书签</H1>
<DL><p>`;
            
            appData.bookmarks.forEach(group => {
                html += `<DT><H3>${escapeHTML(group.name)}</H3>
<DL><p>`;
                
                group.bookmarks.forEach(bookmark => {
                    html += `<DT><A HREF="${escapeHTML(bookmark.url)}">${escapeHTML(bookmark.title)}</A>`;
                });
                
                html += `</DL><p>`;
            });
            
            html += `</DL>`;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `space-navigator-bookmarks-${new Date().toISOString().slice(0, 10)}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('导出成功', '书签已导出为HTML文件', 'success');
        }
        
        // 添加新书签组
        function addNewBookmarkGroup() {
            const newGroup = {
                name: '未命名组',
                bookmarks: []
            };
            
            appData.bookmarks.push(newGroup);
            renderBookmarks();
            setupBookmarkEventListeners();
        }
        
        // 添加新书签
        function addNewBookmark(groupIndex) {
            const newBookmark = {
                title: '新书签',
                url: 'https://',
                favicon: ''
            };
            
            appData.bookmarks[groupIndex].bookmarks.push(newBookmark);
            renderBookmarks();
            setupBookmarkEventListeners();
            updateBookmarkCount();
        }
        
        // 渲染书签
        function renderBookmarks() {
            // 清空容器
            elements.bookmarksContainer.innerHTML = '';
            elements.bookmarksEditorContainer.innerHTML = '';
            
            if (appData.bookmarks.length === 0) {
                elements.bookmarksContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-400">
                        <i class="fa fa-folder-open-o text-4xl mb-3"></i>
                        <p>暂无书签数据</p>
                        <p class="text-sm mt-1">请在编辑模式下添加您的书签</p>
                    </div>
                `;
                elements.bookmarksEditorContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-400">
                        <p>暂无书签数据</p>
                        <p class="text-sm mt-1">点击"添加书签组"开始创建</p>
                    </div>
                `;
                return;
            }
            
            // 为每个书签组生成唯一ID，防止DOM干扰
            appData.bookmarks.forEach((group, groupIndex) => {
                const groupId = `group-${Date.now()}-${groupIndex}`;
                
                // 主页书签组
                const groupElement = document.createElement('div');
                groupElement.className = 'bookmark-group';
                groupElement.dataset.groupId = groupId;
                groupElement.innerHTML = `
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fa fa-folder-open-o mr-2 text-space-accent"></i>
                        ${group.name}
                    </h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        ${group.bookmarks.map((bookmark, bookmarkIndex) => 
                            createBookmarkElement(bookmark, groupId, bookmarkIndex)
                        ).join('')}
                    </div>
                `;
                elements.bookmarksContainer.appendChild(groupElement);
                
                // 编辑页书签组 - 使用唯一ID避免事件冲突
                const editorGroupElement = document.createElement('div');
                editorGroupElement.className = 'editor-bookmark-group bg-space-dark/30 rounded-xl p-4';
                editorGroupElement.dataset.groupId = groupId;
                editorGroupElement.dataset.index = groupIndex;
                editorGroupElement.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center">
                            <i class="fa fa-folder-open-o mr-2 text-space-accent"></i>
                            <input type="text" value="${escapeHTML(group.name)}" 
                                   class="group-name-input bg-space-darker border-b border-transparent hover:border-space-accent/50 focus:border-space-accent focus:outline-none text-white" 
                                   data-group-id="${groupId}" data-index="${groupIndex}">
                        </div>
                        <div class="flex space-x-1">
                            <button class="add-bookmark p-1.5 rounded hover:bg-space-light transition-colors touch-target" 
                                    data-group-id="${groupId}" data-index="${groupIndex}">
                                <i class="fa fa-plus text-sm"></i>
                            </button>
                            <button class="delete-group p-1.5 rounded hover:bg-space-light transition-colors text-red-400 touch-target" 
                                    data-group-id="${groupId}" data-index="${groupIndex}">
                                <i class="fa fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-2 max-h-60 overflow-y-auto scrollbar-hide">
                        ${group.bookmarks.map((bookmark, bookmarkIndex) => 
                            createEditorBookmarkElement(bookmark, groupId, groupIndex, bookmarkIndex)
                        ).join('')}
                    </div>
                `;
                elements.bookmarksEditorContainer.appendChild(editorGroupElement);
            });
        }
        
        // 创建书签元素
        function createBookmarkElement(bookmark, groupId, bookmarkIndex) {
            let favicon = '';
            if (bookmark.favicon) {
                favicon = `<img src="${escapeHTML(bookmark.favicon)}" alt="${escapeHTML(bookmark.title)}图标" class="w-5 h-5 mr-2 object-contain">`;
            } else if (bookmark.title) {
                const initial = bookmark.title.charAt(0).toUpperCase();
                favicon = `<div class="w-5 h-5 mr-2 rounded bg-space-accent/30 flex items-center justify-center text-xs">${initial}</div>`;
            } else {
                favicon = `<i class="fa fa-globe w-5 h-5 mr-2 text-space-accent"></i>`;
            }
            
            return `
                <a href="${escapeHTML(bookmark.url)}" target="_blank" class="bookmark-item bg-space-light/30 hover:bg-space-light/50 backdrop-blur-sm rounded-lg p-3 flex items-center transition-all group touch-target"
                   data-group-id="${groupId}" data-bookmark-index="${bookmarkIndex}">
                    <div class="flex-shrink-0">
                        ${favicon}
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-medium truncate group-hover:text-space-glow transition-colors">${escapeHTML(bookmark.title)}</p>
                    </div>
                </a>
            `;
        }
        
        // 创建编辑页书签元素 - 使用唯一ID避免冲突
        function createEditorBookmarkElement(bookmark, groupId, groupIndex, bookmarkIndex) {
            return `
                <div class="editor-bookmark bg-space-darker/50 rounded-lg p-3 flex justify-between items-center"
                     data-group-id="${groupId}" data-bookmark-index="${bookmarkIndex}">
                    <div class="flex-1 min-w-0 mr-2">
                        <div class="flex items-center mb-1">
                            <input type="text" value="${escapeHTML(bookmark.title)}" 
                                   class="bookmark-title-input bg-space-darker border-b border-transparent hover:border-space-accent/50 focus:border-space-accent focus:outline-none text-sm text-white w-full" 
                                   data-group-id="${groupId}" data-group-index="${groupIndex}" data-bookmark-index="${bookmarkIndex}">
                        </div>
                        <input type="text" value="${escapeHTML(bookmark.url)}" 
                               class="bookmark-url-input bg-space-darker border-b border-transparent hover:border-space-accent/50 focus:border-space-accent focus:outline-none text-xs text-gray-400 w-full" 
                               data-group-id="${groupId}" data-group-index="${groupIndex}" data-bookmark-index="${bookmarkIndex}">
                    </div>
                    <div class="flex space-x-1">
                        <button class="edit-bookmark p-1.5 rounded hover:bg-space-light transition-colors touch-target" 
                                data-group-id="${groupId}" data-group-index="${groupIndex}" data-bookmark-index="${bookmarkIndex}">
                            <i class="fa fa-pencil text-sm"></i>
                        </button>
                        <button class="delete-bookmark p-1.5 rounded hover:bg-space-light transition-colors text-red-400 touch-target" 
                                data-group-id="${groupId}" data-group-index="${groupIndex}" data-bookmark-index="${bookmarkIndex}">
                            <i class="fa fa-trash text-sm"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 渲染搜索历史
        function renderSearchHistory() {
            elements.historyList.innerHTML = '';
            
            if (appData.search.history.length === 0) {
                elements.searchHistory.classList.add('hidden');
                return;
            }
            
            appData.search.history.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-space-darker/50 px-3 py-1.5 rounded-full text-sm flex items-center';
                div.innerHTML = `
                    <i class="fa fa-history mr-1 text-gray-500"></i>
                    <span>${escapeHTML(item)}</span>
                    <button class="delete-history-item ml-1 text-gray-500 hover:text-red-400">
                        <i class="fa fa-times-circle"></i>
                    </button>
                `;
                
                // 点击历史项进行搜索
                div.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-history-item')) {
                        elements.searchInput.value = item;
                        performSearch(item);
                    }
                });
                
                // 删除历史项
                div.querySelector('.delete-history-item').addEventListener('click', (e) => {
                    e.stopPropagation();
                    appData.search.history.splice(index, 1);
                    saveSearchSettings();
                    renderSearchHistory();
                });
                
                elements.historyList.appendChild(div);
            });
        }
        
        // 清除搜索历史
        function clearSearchHistory() {
            appData.search.history = [];
            saveSearchSettings();
            renderSearchHistory();
            showNotification('操作成功', '搜索历史已清除', 'success');
        }
        
        // 保存搜索设置
        function saveSearchSettings() {
            appData.search.engine = elements.defaultSearchEngine.value;
            appData.search.saveHistory = elements.saveSearchHistory.checked;
            appData.search.showSuggestions = elements.showSuggestions.checked;
            
            // 保存到本地存储
            localStorage.setItem('spaceNavigatorSearchSettings', JSON.stringify({
                type: appData.search.type,
                engine: appData.search.engine,
                saveHistory: appData.search.saveHistory,
                showSuggestions: appData.search.showSuggestions
            }));
            
            // 保存搜索历史
            localStorage.setItem('spaceNavigatorSearchHistory', JSON.stringify(appData.search.history));
            
            // 更新UI
            initSearchEngine();
            
            if (!appData.search.saveHistory) {
                elements.searchHistory.classList.add('hidden');
            } else if (appData.search.history.length > 0) {
                elements.searchHistory.classList.remove('hidden');
            }
        }
        
        // 加载搜索历史
        function loadSearchHistory() {
            const savedHistory = localStorage.getItem('spaceNavigatorSearchHistory');
            if (savedHistory) {
                try {
                    appData.search.history = JSON.parse(savedHistory);
                } catch (e) {
                    console.error('加载搜索历史失败:', e);
                    appData.search.history = [];
                }
            }
        }
        
        // 初始化搜索引擎
        function initSearchEngine() {
            elements.defaultSearchEngine.value = appData.search.engine;
            elements.saveSearchHistory.checked = appData.search.saveHistory;
            elements.showSearchSuggestions.checked = appData.search.showSuggestions;
            
            document.querySelectorAll('.search-engine-btn').forEach(btn => {
                if (btn.dataset.engine === appData.search.engine) {
                    btn.classList.add('active', 'text-space-glow');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('active', 'text-space-glow');
                    btn.classList.add('text-gray-400');
                }
            });
            
            setSearchType(appData.search.type);
        }
        
        // 设置搜索类型
        function setSearchType(type) {
            appData.search.type = 'site'; // 强制为站内搜索
            
            elements.searchTypeSite.classList.add('text-space-glow', 'border-space-accent');
            elements.searchTypeSite.classList.remove('text-gray-400');
            elements.searchTypeWeb.classList.remove('text-space-glow', 'border-space-accent');
            elements.searchTypeWeb.classList.add('text-gray-400');
            
            elements.webSearchOptions.classList.add('hidden');
        }
        
        // 处理搜索输入
        function handleSearchInput() {
            const query = elements.searchInput.value.trim();
            
            if (!query) {
                hideSearchSuggestions();
                if (appData.search.saveHistory && appData.search.history.length > 0) {
                    elements.searchHistory.classList.remove('hidden');
                }
                return;
            }
            
            elements.searchHistory.classList.add('hidden');
            
            if (!appData.search.showSuggestions) {
                return;
            }
            
            clearTimeout(searchSuggestionTimeout);
            searchSuggestionTimeout = setTimeout(() => {
                showSearchSuggestions(query);
            }, 300);
        }
        
        // 显示搜索建议
        function showSearchSuggestions(query) {
            const suggestions = [];
            const lowerQuery = query.toLowerCase();
            
            // 从书签标题和URL中获取建议
            appData.bookmarks.forEach(group => {
                group.bookmarks.forEach(bookmark => {
                    if (bookmark.title.toLowerCase().includes(lowerQuery) && !suggestions.includes(bookmark.title)) {
                        suggestions.push(bookmark.title);
                    }
                    if (bookmark.url.toLowerCase().includes(lowerQuery) && !suggestions.includes(bookmark.url)) {
                        suggestions.push(bookmark.url);
                    }
                });
            });
            
            // 限制建议数量
            const limitedSuggestions = suggestions.slice(0, 5);
            
            if (limitedSuggestions.length === 0) {
                hideSearchSuggestions();
                return;
            }
            
            elements.searchSuggestions.innerHTML = '';
            limitedSuggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'search-suggestion';
                div.dataset.suggestion = suggestion;
                div.textContent = suggestion;
                
                div.addEventListener('click', () => {
                    elements.searchInput.value = suggestion;
                    performSearch(suggestion);
                    hideSearchSuggestions();
                });
                
                elements.searchSuggestions.appendChild(div);
            });
            
            elements.searchSuggestions.classList.remove('hidden');
            searchSuggestionIndex = -1;
        }
        
        // 隐藏搜索建议
        function hideSearchSuggestions() {
            elements.searchSuggestions.classList.add('hidden');
            searchSuggestionIndex = -1;
        }
        
        // 清除搜索结果
        function clearSearchResults() {
            // 重置搜索状态
            elements.searchInput.value = '';
            hideSearchSuggestions();
            elements.searchResultsContainer.classList.add('hidden');
            elements.searchHistory.classList.add('hidden');
            
            saveSearchSettings();
        }
        
        // 执行搜索
        function performSearch(query) {
            if (!query.trim()) return;
            
            // 仅执行站内搜索
            performSiteSearch(query);
            
            // 保存搜索历史
            if (appData.search.saveHistory && !appData.search.history.includes(query)) {
                appData.search.history.unshift(query);
                // 限制历史记录数量
                if (appData.search.history.length > 20) {
                    appData.search.history.pop();
                }
                saveSearchSettings();
                renderSearchHistory();
            }
        }
        
        // 执行站内搜索
        function performSiteSearch(query) {
            const results = [];
            const lowerQuery = query.toLowerCase();
            
            // 搜索所有书签
            appData.bookmarks.forEach((group, groupIndex) => {
                group.bookmarks.forEach((bookmark, bookmarkIndex) => {
                    const titleMatch = bookmark.title.toLowerCase().includes(lowerQuery);
                    const urlMatch = bookmark.url.toLowerCase().includes(lowerQuery);
                    
                    if (titleMatch || urlMatch) {
                        // 计算匹配分数，标题匹配权重更高
                        let score = 0;
                        if (titleMatch) score += 2;
                        if (urlMatch) score += 1;
                        
                        results.push({
                            group: group.name,
                            title: bookmark.title,
                            url: bookmark.url,
                            favicon: bookmark.favicon,
                            score: score,
                            groupIndex: groupIndex,
                            bookmarkIndex: bookmarkIndex
                        });
                    }
                });
            });
            
            // 按匹配分数排序
            results.sort((a, b) => b.score - a.score);
            
            // 显示结果
            displaySearchResults(results, query);
        }
        
        // 显示搜索结果
        function displaySearchResults(results, query) {
            elements.searchResults.innerHTML = '';
            elements.searchResultsCount.textContent = `找到 ${results.length} 个结果`;
            
            if (results.length === 0) {
                elements.searchResults.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fa fa-search text-4xl mb-3"></i>
                        <p>没有找到与"${escapeHTML(query)}"相关的书签</p>
                    </div>
                `;
            } else {
                results.forEach(result => {
                    let favicon = '';
                    if (result.favicon) {
                        favicon = `<img src="${escapeHTML(result.favicon)}" alt="${escapeHTML(result.title)}图标" class="w-5 h-5 mr-2 object-contain">`;
                    } else if (result.title) {
                        const initial = result.title.charAt(0).toUpperCase();
                        favicon = `<div class="w-5 h-5 mr-2 rounded bg-space-accent/30 flex items-center justify-center text-xs">${initial}</div>`;
                    } else {
                        favicon = `<i class="fa fa-globe w-5 h-5 mr-2 text-space-accent"></i>`;
                    }
                    
                    const resultElement = document.createElement('div');
                    resultElement.className = 'search-result p-3 border-b border-space-accent/10 hover:bg-space-light/20 transition-colors';
                    resultElement.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mt-0.5">
                                ${favicon}
                            </div>
                            <div class="ml-2 flex-1">
                                <div class="flex flex-wrap items-center gap-2">
                                    <a href="${escapeHTML(result.url)}" target="_blank" class="text-white hover:text-space-accent transition-colors font-medium">
                                        ${highlightMatch(escapeHTML(result.title), query)}
                                    </a>
                                    <span class="text-xs bg-space-dark px-2 py-0.5 rounded text-gray-400">${escapeHTML(result.group)}</span>
                                </div>
                                <p class="text-sm text-gray-400 mt-1 break-all">${highlightMatch(escapeHTML(result.url), query)}</p>
                            </div>
                        </div>
                    `;
                    
                    elements.searchResults.appendChild(resultElement);
                });
            }
            
            elements.searchResultsContainer.classList.remove('hidden');
        }
        
        // 高亮匹配的文本
        function highlightMatch(text, query) {
            if (!query) return text;
            
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.replace(regex, '<span class="text-space-accent">$1</span>');
        }
        
        // 转义正则表达式特殊字符
        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // 从GitHub加载数据
        async function loadDataFromGitHub() {
            try {
                // 尝试从本地存储加载
                const localData = localStorage.getItem('spaceNavigatorData');
                if (localData) {
                    const parsedData = JSON.parse(localData);
                    if (parsedData.bookmarks) appData.bookmarks = parsedData.bookmarks;
                    if (parsedData.ads) appData.ads = parsedData.ads;
                    if (parsedData.timezones) appData.timezones = parsedData.timezones;
                    return;
                }
                
                // 本地没有数据时从GitHub加载
                const response = await fetch(DEFAULT_RAW_URL);
                if (response.ok) {
                    const data = await response.json();
                    if (data.bookmarks) appData.bookmarks = data.bookmarks;
                    if (data.ads) appData.ads = data.ads;
                    if (data.timezones) appData.timezones = data.timezones;
                    
                    // 保存到本地存储
                    saveLocalSettings();
                }
            } catch (error) {
                console.error('从GitHub加载数据失败:', error);
                showNotification('数据加载失败', '使用默认数据', 'warning');
            }
        }
        
        // 保存数据到GitHub
        async function saveDataToGitHub() {
            try {
                // 保存到本地存储
                saveLocalSettings();
                
                // 如果没有配置GitHub，只保存到本地
                if (!appData.github.repo || !appData.github.token) {
                    showNotification('保存成功', '数据已保存到本地', 'success');
                    return true;
                }
                
                // 准备要保存的数据
                const data = {
                    bookmarks: appData.bookmarks,
                    ads: appData.ads,
                    timezones: appData.timezones
                };
                
                const [owner, repo] = appData.github.repo.split('/');
                const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/bookmarks.json`;
                
                // 先获取现有文件的SHA
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `token ${appData.github.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = '';
                if (response.ok) {
                    const fileData = await response.json();
                    sha = fileData.sha;
                }
                
                // 上传新内容
                const putResponse = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${appData.github.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update bookmarks - ${new Date().toISOString()}`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                        sha: sha
                    })
                });
                
                if (putResponse.ok) {
                    showNotification('保存成功', '数据已同步到GitHub', 'success');
                    return true;
                } else {
                    const errorData = await putResponse.json();
                    console.error('保存到GitHub失败:', errorData);
                    showNotification('同步失败', '请检查GitHub配置', 'error');
                    return false;
                }
            } catch (error) {
                console.error('保存数据失败:', error);
                showNotification('保存失败', '请稍后重试', 'error');
                return false;
            }
        }
        
        // 验证GitHub Token
        async function verifyGitHubToken() {
            try {
                const [owner, repo] = appData.github.repo.split('/');
                if (!owner || !repo) return false;
                
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
                    headers: {
                        'Authorization': `token ${appData.github.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                return response.ok;
            } catch (error) {
                console.error('验证GitHub Token失败:', error);
                return false;
            }
        }
        
        // 保存本地设置
        function saveLocalSettings() {
            localStorage.setItem('spaceNavigatorData', JSON.stringify({
                bookmarks: appData.bookmarks,
                ads: appData.ads,
                timezones: appData.timezones,
                github: {
                    repo: appData.github.repo
                    // 不保存token到本地存储
                },
                currentTheme: appData.currentTheme
            }));
        }
        
        // 加载本地设置
        function loadLocalSettings() {
            try {
                const localData = localStorage.getItem('spaceNavigatorData');
                if (localData) {
                    const parsedData = JSON.parse(localData);
                    if (parsedData.bookmarks) appData.bookmarks = parsedData.bookmarks;
                    if (parsedData.ads) appData.ads = parsedData.ads;
                    if (parsedData.timezones) appData.timezones = parsedData.timezones;
                    if (parsedData.github && parsedData.github.repo) {
                        appData.github.repo = parsedData.github.repo;
                        elements.githubRepo.value = parsedData.github.repo;
                    }
                    if (parsedData.currentTheme) appData.currentTheme = parsedData.currentTheme;
                }
                
                const savedSearchSettings = localStorage.getItem('spaceNavigatorSearchSettings');
                if (savedSearchSettings) {
                    try {
                        const parsedSearchSettings = JSON.parse(savedSearchSettings);
                        appData.search = { ...appData.search, ...parsedSearchSettings };
                        appData.search.type = 'site'; // 强制为站内搜索
                    } catch (e) {
                        console.error('加载搜索设置失败:', e);
                    }
                }
            } catch (error) {
                console.error('加载本地设置失败:', error);
            }
        }
        
        // 转义HTML
        function escapeHTML(str) {
            if (!str) return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // 切换到浅色模式
        function switchToLightMode() {
            document.documentElement.classList.add('light');
            elements.themeToggle.innerHTML = '<i class="fa fa-sun-o text-yellow-500"></i>';
            appData.currentTheme = 'light';
            saveLocalSettings();
        }
        
        // 切换到深色模式
        function switchToDarkMode() {
            document.documentElement.classList.remove('light');
            elements.themeToggle.innerHTML = '<i class="fa fa-moon-o text-space-accent"></i>';
            appData.currentTheme = 'dark';
            saveLocalSettings();
        }
        
        // 切换主题
        function toggleTheme() {
            if (appData.currentTheme === 'dark') {
                switchToLightMode();
            } else {
                switchToDarkMode();
            }
        }
        
        // 处理广告图片上传
        function handleAdImageUpload(index) {
            return function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    if (index === 0) {
                        elements.ad1Img.src = event.target.result;
                        elements.ad1UrlInput.value = event.target.result;
                    } else if (index === 1) {
                        elements.ad2Img.src = event.target.result;
                        elements.ad2UrlInput.value = event.target.result;
                    } else if (index === 2) {
                        elements.ad3Img.src = event.target.result;
                        elements.ad3UrlInput.value = event.target.result;
                    }
                };
                reader.readAsDataURL(file);
            };
        }
        
        // 设置广告编辑区
        function setupAdEditor() {
            if (appData.ads.length >= 1) {
                elements.ad1Img.src = appData.ads[0].imgUrl;
                elements.ad1Link.href = appData.ads[0].linkUrl;
                elements.ad1UrlInput.value = appData.ads[0].imgUrl;
                elements.ad1LinkInput.value = appData.ads[0].linkUrl;
            }
            
            if (appData.ads.length >= 2) {
                elements.ad2Img.src = appData.ads[1].imgUrl;
                elements.ad2Link.href = appData.ads[1].linkUrl;
                elements.ad2UrlInput.value = appData.ads[1].imgUrl;
                elements.ad2LinkInput.value = appData.ads[1].linkUrl;
            }
            
            if (appData.ads.length >= 3) {
                elements.ad3Img.src = appData.ads[2].imgUrl;
                elements.ad3Link.href = appData.ads[2].linkUrl;
                elements.ad3UrlInput.value = appData.ads[2].imgUrl;
                elements.ad3LinkInput.value = appData.ads[2].linkUrl;
            }
        }
        
        // 保存广告设置
        function saveAdSettings() {
            if (appData.ads.length < 1) appData.ads.push({});
            appData.ads[0].imgUrl = elements.ad1UrlInput.value;
            appData.ads[0].linkUrl = elements.ad1LinkInput.value;
            
            if (appData.ads.length < 2) appData.ads.push({});
            appData.ads[1].imgUrl = elements.ad2UrlInput.value;
            appData.ads[1].linkUrl = elements.ad2LinkInput.value;
            
            if (appData.ads.length < 3) appData.ads.push({});
            appData.ads[2].imgUrl = elements.ad3UrlInput.value;
            appData.ads[2].linkUrl = elements.ad3LinkInput.value;
            
            setupAdEditor();
        }
        
        // 渲染时区列表
        function renderTimezones() {
            elements.timezonesContainer.innerHTML = '';
            elements.timezonesList.innerHTML = '';
            
            if (appData.timezones.length === 0) {
                elements.timezonesContainer.innerHTML = `
                    <div class="col-span-2 text-center py-6 text-gray-400 text-sm">
                        <p>请添加时区</p>
                    </div>
                `;
                return;
            }
            
            // 渲染主页面时区显示
            appData.timezones.forEach((timezone, index) => {
                // 主页面显示
                const timezoneElement = document.createElement('div');
                timezoneElement.className = 'bg-space-light/20 rounded-lg p-3';
                
                // 使用Intl.DateTimeFormat获取准确时间
                const formatter = new Intl.DateTimeFormat('zh-CN', {
                    timeZone: timezone.timezone,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const dateFormatter = new Intl.DateTimeFormat('zh-CN', {
                    timeZone: timezone.timezone,
                    month: 'short',
                    day: 'numeric',
                    weekday: 'short'
                });
                
                const time = formatter.format(new Date());
                const date = dateFormatter.format(new Date());
                
                timezoneElement.innerHTML = `
                    <div class="text-sm text-gray-400">${timezone.city}</div>
                    <div class="text-lg font-medium mt-1">${time}</div>
                    <div class="text-xs text-gray-500 mt-1">${date}</div>
                `;
                elements.timezonesContainer.appendChild(timezoneElement);
                
                // 编辑页显示
                const editElement = document.createElement('div');
                editElement.className = 'flex justify-between items-center bg-space-dark/50 p-2 rounded-lg';
                editElement.innerHTML = `
                    <div>
                        <div class="font-medium">${timezone.city}</div>
                        <div class="text-xs text-gray-400">${timezone.timezone}</div>
                    </div>
                    <button class="delete-timezone p-1.5 rounded hover:bg-space-light transition-colors text-red-400 touch-target"
                            data-index="${index}">
                        <i class="fa fa-trash text-sm"></i>
                    </button>
                `;
                
                // 删除时区
                editElement.querySelector('.delete-timezone').addEventListener('click', () => {
                    appData.timezones.splice(index, 1);
                    renderTimezones();
                });
                
                elements.timezonesList.appendChild(editElement);
            });
        }
        
        // 添加新时区
        function addNewTimezone(cityName) {
            if (!cityName.trim()) return;
            
            // 尝试匹配城市到时区
            const lowercaseCity = cityName.toLowerCase();
            let timezone = null;
            
            // 查找匹配的城市
            for (const [city, tz] of Object.entries(cityToTimezone)) {
                if (city.toLowerCase().includes(lowercaseCity) || lowercaseCity.includes(city.toLowerCase())) {
                    timezone = tz;
                    cityName = city; // 使用标准城市名
                    break;
                }
            }
            
            // 如果没有找到匹配的时区，尝试使用城市名作为时区（可能不准确）
            if (!timezone) {
                // 检查是否是有效的时区
                try {
                    Intl.DateTimeFormat(undefined, { timeZone: cityName });
                    timezone = cityName;
                } catch (e) {
                    showNotification('添加失败', '无法识别的城市，请尝试其他名称', 'error');
                    return;
                }
            }
            
            // 检查是否已添加
            const isDuplicate = appData.timezones.some(tz => tz.timezone === timezone);
            if (isDuplicate) {
                showNotification('已添加', '该时区已在列表中', 'info');
                return;
            }
            
            appData.timezones.push({
                city: cityName,
                timezone: timezone
            });
            
            elements.newTimezone.value = '';
            renderTimezones();
            showNotification('添加成功', `已添加 ${cityName} 时区`, 'success');
        }
        
        // 更新时间显示
        function updateTimeDisplay() {
            const now = new Date();
            
            // 更新本地时间
            const timeFormatter = new Intl.DateTimeFormat('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const dateFormatter = new Intl.DateTimeFormat('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            elements.timeDisplay.textContent = timeFormatter.format(now);
            elements.dateDisplay.textContent = dateFormatter.format(now);
            
            // 更新所有时区时间
            if (appData.timezones.length > 0) {
                const timezoneElements = elements.timezonesContainer.querySelectorAll('.bg-space-light\\/20');
                appData.timezones.forEach((timezone, index) => {
                    if (timezoneElements[index]) {
                        const formatter = new Intl.DateTimeFormat('zh-CN', {
                            timeZone: timezone.timezone,
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });
                        const timeElement = timezoneElements[index].querySelector('.text-lg');
                        if (timeElement) {
                            timeElement.textContent = formatter.format(now);
                        }
                    }
                });
            }
        }
        
        // 显示确认对话框
        function confirmAction(title, message, callback) {
            elements.confirmTitle.textContent = title;
            elements.confirmMessage.textContent = message;
            confirmCallback = callback;
            elements.confirmModal.classList.remove('hidden');
        }
        
        // 显示通知
        function showNotification(title, message, type = 'info') {
            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;
            
            // 设置通知图标
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'error') icon = 'fa-exclamation-circle';
            else if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            elements.notificationIcon.innerHTML = `<i class="fa ${icon}"></i>`;
            elements.notificationIcon.className = `mr-3 text-xl ${
                type === 'success' ? 'text-green-500' :
                type === 'error' ? 'text-red-500' :
                type === 'warning' ? 'text-yellow-500' : 'text-space-accent'
            }`;
            
            // 显示通知
            elements.notification.classList.remove('translate-y-20', 'opacity-0');
            elements.notification.classList.add('translate-y-0', 'opacity-100');
            
            // 自动隐藏
            setTimeout(hideNotification, 3000);
        }
        
        // 隐藏通知
        function hideNotification() {
            elements.notification.classList.add('translate-y-20', 'opacity-0');
            elements.notification.classList.remove('translate-y-0', 'opacity-100');
        }
        
        // 更新搜索建议高亮
        function updateSearchSuggestionHighlight() {
            const suggestions = elements.searchSuggestions.querySelectorAll('.search-suggestion');
            suggestions.forEach((suggestion, index) => {
                if (index === searchSuggestionIndex) {
                    suggestion.classList.add('search-suggestion-active');
                    elements.searchInput.value = suggestion.dataset.suggestion;
                } else {
                    suggestion.classList.remove('search-suggestion-active');
                }
            });
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            init();
            // 初始化书签事件监听器
            setTimeout(setupBookmarkEventListeners, 100);
        });
    </script>
</body>
</html>
