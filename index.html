<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 自定义域名配置：添加这两个meta标签指定仓库信息 -->
    <!-- <meta name="github-owner" content="你的用户名"> -->
    <!-- <meta name="github-repo" content="你的仓库名"> -->
    <title>智能书签管理器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        neutral: '#6B7280',
                        light: '#F9FAFB',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .transition-height {
                transition: max-height 0.3s ease-out;
            }
            .card-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-primary mb-2">
                <i class="fa fa-bookmark-o mr-2"></i>智能书签管理器
            </h1>
            <p class="text-neutral">轻松管理和访问你的网络书签</p>
        </header>

        <!-- 配置区域 -->
        <div class="bg-white rounded-lg p-6 card-shadow mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-cog text-primary mr-2"></i>仓库配置
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label for="github-owner" class="block text-sm font-medium text-gray-700 mb-1">
                        GitHub 用户名/组织名
                    </label>
                    <input 
                        type="text" 
                        id="github-owner" 
                        placeholder="例如: octocat"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                    >
                </div>
                
                <div>
                    <label for="github-repo" class="block text-sm font-medium text-gray-700 mb-1">
                        仓库名
                    </label>
                    <input 
                        type="text" 
                        id="github-repo" 
                        placeholder="例如: my-bookmarks"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                    >
                </div>
                
                <div>
                    <label for="file-path" class="block text-sm font-medium text-gray-700 mb-1">
                        文件路径
                    </label>
                    <input 
                        type="text" 
                        id="file-path" 
                        value="bookmarks.json" 
                        placeholder="文件在仓库中的路径"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                    >
                </div>
                
                <div class="flex flex-wrap gap-3 pt-2">
                    <button 
                        onclick="loadBookmarks()" 
                        class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded-md flex items-center transition-all"
                    >
                        <i class="fa fa-refresh mr-2"></i>加载书签
                    </button>
                    
                    <button 
                        onclick="useCurrentDeploymentRepo()" 
                        class="bg-secondary hover:bg-secondary/90 text-white px-5 py-2 rounded-md flex items-center transition-all"
                    >
                        <i class="fa fa-magic mr-2"></i>使用当前部署仓库
                    </button>
                    
                    <button 
                        onclick="showRecommendedRepos()" 
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-5 py-2 rounded-md flex items-center transition-all"
                    >
                        <i class="fa fa-star mr-2"></i>推荐仓库
                    </button>
                </div>
                
                <div id="status-message" class="p-3 rounded-md text-sm hidden"></div>
                
                <div id="repo-verification" class="text-sm mt-2 hidden"></div>
            </div>
            
            <!-- 帮助提示 -->
            <div id="help-hint" class="mt-4 p-3 bg-gray-50 rounded-md text-sm text-neutral border border-gray-200 hidden">
                <p class="font-medium mb-1"><i class="fa fa-info-circle mr-1"></i>配置帮助</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>对于标准GitHub Pages (xxx.github.io/yyy)，可自动识别仓库信息</li>
                    <li>对于自定义域名，可在HTML头部添加meta标签预设仓库信息</li>
                    <li>点击"使用当前部署仓库"可自动填充当前页面所在的仓库</li>
                </ul>
            </div>
        </div>
        
        <!-- 推荐仓库列表 (默认隐藏) -->
        <div id="recommended-repos" class="bg-white rounded-lg p-6 card-shadow mb-8 hidden">
            <h3 class="text-lg font-semibold mb-3">推荐公开书签仓库</h3>
            <div class="grid gap-3">
                <div class="p-3 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer transition-all" onclick="selectRepo('fmies-projects', 'bookmarks')">
                    <div class="font-medium">fmies-projects / bookmarks</div>
                    <div class="text-sm text-neutral">通用书签集合示例</div>
                </div>
                <div class="p-3 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer transition-all" onclick="selectRepo('web-dev-bookmarks', 'frontend-bookmarks')">
                    <div class="font-medium">web-dev-bookmarks / frontend-bookmarks</div>
                    <div class="text-sm text-neutral">前端开发者常用资源</div>
                </div>
                <div class="p-3 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer transition-all" onclick="selectRepo('awesome-bookmarks', 'programming')">
                    <div class="font-medium">awesome-bookmarks / programming</div>
                    <div class="text-sm text-neutral">程序员精选书签</div>
                </div>
            </div>
        </div>
        
        <!-- 书签内容区域 -->
        <div id="bookmarks-container" class="bg-white rounded-lg p-6 card-shadow min-h-[200px]">
            <div class="flex items-center justify-center h-20 text-neutral">
                <i class="fa fa-bookmark-o mr-2"></i> 请配置仓库并加载书签
            </div>
        </div>
    </div>

    <script>
        // 页面加载时自动获取并填充默认仓库信息
        document.addEventListener('DOMContentLoaded', () => {
            // 显示帮助提示
            setTimeout(() => {
                document.getElementById('help-hint').classList.remove('hidden');
            }, 1500);
            
            // 尝试多种方式自动检测仓库信息
            autoDetectDefaultRepo();
            
            // 为输入框添加验证
            setupInputValidation();
        });

        /**
         * 多层次自动检测仓库信息
         * 综合多种机制提高成功率
         */
        async function autoDetectDefaultRepo() {
            const ownerInput = document.getElementById('github-owner');
            const repoInput = document.getElementById('github-repo');
            
            // 如果已有值则不覆盖
            if (ownerInput.value && repoInput.value) return;

            // 检测机制优先级排序
            const detectionMethods = [
                getRepoFromMetaTags,    // 1. Meta标签配置
                getRepoFromUrl,         // 2. URL解析
                getRepoFromLocalStorage,// 3. 本地存储
                getRepoFromGitHubApi    // 4. GitHub API查询
            ];

            for (const method of detectionMethods) {
                try {
                    const { owner, repo } = await method();
                    if (owner && repo) {
                        ownerInput.value = ownerInput.value || owner;
                        repoInput.value = repoInput.value || repo;
                        
                        // 验证并加载
                        if (ownerInput.value && repoInput.value) {
                            verifyRepo(ownerInput.value, repoInput.value);
                            return;
                        }
                    }
                } catch (e) {
                    console.log(`检测方法 ${method.name} 失败:`, e.message);
                    continue; // 一种方法失败则尝试下一种
                }
            }

            // 所有方法都失败时，显示推荐仓库
            setTimeout(() => {
                document.getElementById('status-message').textContent = '未检测到仓库信息，可从推荐仓库中选择或手动配置';
                document.getElementById('status-message').className = 'p-3 rounded-md text-sm text-neutral bg-gray-50';
            }, 1000);
        }

        /**
         * 从meta标签获取仓库信息
         */
        function getRepoFromMetaTags() {
            return new Promise(resolve => {
                const owner = document.querySelector('meta[name="github-owner"]')?.content?.trim();
                const repo = document.querySelector('meta[name="github-repo"]')?.content?.trim();
                resolve({ owner, repo });
            });
        }

        /**
         * 从URL解析仓库信息
         */
        function getRepoFromUrl() {
            return new Promise(resolve => {
                const result = { owner: null, repo: null };
                const currentHost = window.location.hostname;
                const pathSegments = window.location.pathname.split('/').filter(segment => segment);
                
                // 标准GitHub Pages格式: https://<owner>.github.io/<repo>/
                if (currentHost.endsWith('.github.io')) {
                    result.owner = currentHost.replace('.github.io', '').trim();
                    // 提取仓库名（路径第一段）
                    if (pathSegments.length > 0) {
                        result.repo = pathSegments[0].trim();
                    } else {
                        // 特殊情况: 主页仓库通常与用户名相同
                        result.repo = result.owner;
                    }
                }
                
                resolve(result);
            });
        }

        /**
         * 从本地存储获取仓库信息
         */
        function getRepoFromLocalStorage() {
            return new Promise(resolve => {
                try {
                    const owner = localStorage.getItem('githubOwner')?.trim();
                    const repo = localStorage.getItem('githubRepo')?.trim();
                    resolve({ owner, repo });
                } catch (e) {
                    resolve({ owner: null, repo: null });
                }
            });
        }

        /**
         * 通过GitHub API查询当前页面的部署仓库
         * 这是最可靠的方法，但有API速率限制
         */
        async function getRepoFromGitHubApi() {
            return new Promise(async (resolve) => {
                try {
                    // 对于GitHub Pages，尝试通过API查询站点信息
                    const domain = window.location.hostname;
                    const apiUrl = `https://api.github.com/repos/github/pages/sites/${domain}`;
                    
                    const response = await fetch(apiUrl);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.repository) {
                            const repoFullName = data.repository.full_name;
                            if (repoFullName && repoFullName.includes('/')) {
                                const [owner, repo] = repoFullName.split('/');
                                resolve({ owner, repo });
                                return;
                            }
                        }
                    }
                } catch (e) {
                    console.log('GitHub API查询失败:', e.message);
                }
                resolve({ owner: null, repo: null });
            });
        }

        /**
         * 手动触发使用当前部署仓库
         * 提供用户主动触发的选项，提高成功率
         */
        async function useCurrentDeploymentRepo() {
            const statusElement = document.getElementById('status-message');
            const ownerInput = document.getElementById('github-owner');
            const repoInput = document.getElementById('github-repo');
            
            statusElement.textContent = '正在查询当前部署的仓库信息...';
            statusElement.className = 'p-3 rounded-md text-sm text-blue-700 bg-blue-50';
            
            try {
                // 尝试多种方式获取当前部署仓库
                const { owner, repo } = await getRepoFromGitHubApi();
                
                if (owner && repo) {
                    ownerInput.value = owner;
                    repoInput.value = repo;
                    statusElement.textContent = `已自动填充当前部署仓库: ${owner}/${repo}`;
                    statusElement.className = 'p-3 rounded-md text-sm text-green-700 bg-green-50';
                    verifyRepo(owner, repo);
                    return;
                }
                
                // 如果API查询失败，尝试从URL和本地存储组合获取
                const urlRepo = await getRepoFromUrl();
                const localRepo = await getRepoFromLocalStorage();
                
                if (urlRepo.owner && urlRepo.repo) {
                    ownerInput.value = urlRepo.owner;
                    repoInput.value = urlRepo.repo;
                    statusElement.textContent = `已从URL获取仓库信息: ${urlRepo.owner}/${urlRepo.repo}`;
                    statusElement.className = 'p-3 rounded-md text-sm text-green-700 bg-green-50';
                    verifyRepo(urlRepo.owner, urlRepo.repo);
                    return;
                } else if (localRepo.owner && localRepo.repo) {
                    ownerInput.value = localRepo.owner;
                    repoInput.value = localRepo.repo;
                    statusElement.textContent = `已从历史记录获取仓库信息: ${localRepo.owner}/${localRepo.repo}`;
                    statusElement.className = 'p-3 rounded-md text-sm text-green-700 bg-green-50';
                    verifyRepo(localRepo.owner, localRepo.repo);
                    return;
                }
                
                // 所有方法都失败
                statusElement.textContent = '无法自动获取当前部署仓库，请手动输入';
                statusElement.className = 'p-3 rounded-md text-sm text-yellow-700 bg-yellow-50';
                document.getElementById('recommended-repos').classList.remove('hidden');
                
            } catch (e) {
                statusElement.textContent = `获取失败: ${e.message}，请手动输入`;
                statusElement.className = 'p-3 rounded-md text-sm text-red-700 bg-red-50';
            }
        }

        /**
         * 验证仓库是否存在并可访问
         */
        async function verifyRepo(owner, repo) {
            const verificationElement = document.getElementById('repo-verification');
            
            if (!owner || !repo) return;
            
            verificationElement.textContent = `正在验证仓库 ${owner}/${repo}...`;
            verificationElement.className = 'text-sm text-blue-600 mt-2';
            verificationElement.classList.remove('hidden');
            
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`);
                if (response.ok) {
                    verificationElement.textContent = `仓库验证成功: ${owner}/${repo} 是一个有效的公开仓库`;
                    verificationElement.className = 'text-sm text-green-600 mt-2';
                    
                    // 检查bookmarks.json是否存在
                    const filePath = document.getElementById('file-path').value;
                    const fileCheck = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`);
                    if (!fileCheck.ok) {
                        verificationElement.innerHTML += `<br>注意: 未找到 ${filePath} 文件，可能需要调整文件路径`;
                    }
                } else {
                    verificationElement.textContent = `仓库验证失败: 无法访问 ${owner}/${repo}，请检查信息是否正确`;
                    verificationElement.className = 'text-sm text-red-600 mt-2';
                }
            } catch (e) {
                verificationElement.textContent = `验证出错: ${e.message}`;
                verificationElement.className = 'text-sm text-red-600 mt-2';
            }
        }

        /**
         * 显示/隐藏推荐仓库
         */
        function showRecommendedRepos() {
            const repoList = document.getElementById('recommended-repos');
            repoList.classList.toggle('hidden');
        }

        /**
         * 选择推荐的仓库
         */
        function selectRepo(owner, repo) {
            document.getElementById('github-owner').value = owner;
            document.getElementById('github-repo').value = repo;
            document.getElementById('recommended-repos').classList.add('hidden');
            verifyRepo(owner, repo);
        }

        /**
         * 为输入框添加验证
         */
        function setupInputValidation() {
            const ownerInput = document.getElementById('github-owner');
            const repoInput = document.getElementById('github-repo');
            
            // 输入变化时进行验证
            [ownerInput, repoInput].forEach(input => {
                input.addEventListener('blur', () => {
                    if (ownerInput.value && repoInput.value) {
                        verifyRepo(ownerInput.value, repoInput.value);
                    }
                });
            });
        }

        /**
         * 保存配置到本地存储
         */
        function saveConfigToLocalStorage(owner, repo) {
            try {
                localStorage.setItem('githubOwner', owner);
                localStorage.setItem('githubRepo', repo);
            } catch (e) {
                console.warn('无法保存到本地存储:', e);
            }
        }

        /**
         * 加载书签数据
         */
        async function loadBookmarks() {
            const owner = document.getElementById('github-owner').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            const filePath = document.getElementById('file-path').value.trim();
            const statusElement = document.getElementById('status-message');
            const container = document.getElementById('bookmarks-container');
            
            // 基本验证
            if (!owner || !repo) {
                statusElement.textContent = '请填写GitHub用户名和仓库名';
                statusElement.className = 'p-3 rounded-md text-sm text-red-700 bg-red-50';
                return;
            }

            try {
                // 显示加载状态
                statusElement.textContent = '正在加载书签数据...';
                statusElement.className = 'p-3 rounded-md text-sm text-blue-700 bg-blue-50';
                container.innerHTML = '<div class="flex items-center justify-center h-20 text-neutral"><i class="fa fa-circle-o-notch fa-spin mr-2"></i> 加载中...</div>';
                
                // 保存配置到本地存储
                saveConfigToLocalStorage(owner, repo);
                
                // 使用GitHub API获取文件
                const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`未找到文件，请确认仓库"${owner}/${repo}"中存在"${filePath}"`);
                    }
                    throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // 处理GitHub API返回的base64编码内容
                if (data.content) {
                    // 修复Base64解码问题
                    const safeContent = data.content.replace(/-/g, '+').replace(/_/g, '/');
                    const padLength = (4 - (safeContent.length % 4)) % 4;
                    const paddedContent = safeContent + '='.repeat(padLength);
                    
                    const decodedArray = Uint8Array.from(atob(paddedContent), c => c.charCodeAt(0));
                    const decoder = new TextDecoder('utf-8');
                    const decodedContent = decoder.decode(decodedArray);
                    
                    const bookmarks = JSON.parse(decodedContent);
                    const count = countBookmarks(bookmarks);
                    statusElement.textContent = `成功加载 ${count} 个书签`;
                    statusElement.className = 'p-3 rounded-md text-sm text-green-700 bg-green-50';
                    renderBookmarks(bookmarks);
                } else {
                    throw new Error('无法获取书签数据，文件可能为空');
                }
            } catch (error) {
                console.error('加载书签失败:', error);
                statusElement.textContent = `加载失败: ${error.message}`;
                statusElement.className = 'p-3 rounded-md text-sm text-red-700 bg-red-50';
                container.innerHTML = `
                    <div class="p-4 text-center">
                        <i class="fa fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                        <p class="mb-3">加载书签时出现错误</p>
                        <div class="text-sm text-neutral text-left max-w-md mx-auto">
                            <p>请检查以下事项：</p>
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li>确认GitHub用户名和仓库名正确</li>
                                <li>确认${filePath}文件存在于仓库中</li>
                                <li>确认仓库是公开可访问的</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
        }

        /**
         * 统计书签数量
         */
        function countBookmarks(bookmarksData) {
            if (!bookmarksData || !bookmarksData.bookmarks) return 0;
            
            let count = 0;
            bookmarksData.bookmarks.forEach(folder => {
                if (folder.bookmarks) count += folder.bookmarks.length;
            });
            return count;
        }

        /**
         * 渲染书签
         */
        function renderBookmarks(bookmarksData) {
            const container = document.getElementById('bookmarks-container');
            container.innerHTML = '';
            
            if (!bookmarksData || !bookmarksData.bookmarks || bookmarksData.bookmarks.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-neutral">
                        <i class="fa fa-folder-open-o text-3xl mb-3"></i>
                        <p>未找到书签数据或书签为空</p>
                    </div>
                `;
                return;
            }
            
            // 创建书签列表
            const bookmarksList = document.createElement('div');
            bookmarksList.className = 'space-y-4';
            
            bookmarksData.bookmarks.forEach(folder => {
                const folderDiv = document.createElement('div');
                folderDiv.className = 'border border-gray-100 rounded-lg overflow-hidden';
                
                // 文件夹标题
                const folderName = document.createElement('div');
                folderName.className = 'bg-gray-50 px-4 py-2 font-medium flex items-center justify-between cursor-pointer hover:bg-gray-100 transition-colors';
                folderName.innerHTML = `
                    <span><i class="fa fa-folder text-yellow-500 mr-2"></i>${folder.name || '未命名文件夹'}</span>
                    <i class="fa fa-chevron-down text-xs transition-transform duration-300"></i>
                `;
                
                // 文件夹内容
                const folderContent = document.createElement('div');
                folderContent.className = 'px-4 py-3 hidden';
                
                if (folder.bookmarks && folder.bookmarks.length > 0) {
                    const bookmarksUl = document.createElement('ul');
                    bookmarksUl.className = 'space-y-2';
                    
                    folder.bookmarks.forEach(bookmark => {
                        const bookmarkLi = document.createElement('li');
                        bookmarkLi.className = 'flex items-start';
                        bookmarkLi.innerHTML = `
                            <i class="fa fa-bookmark text-primary mt-1 mr-2"></i>
                            <a href="${bookmark.url}" target="_blank" class="hover:text-primary transition-colors">
                                ${bookmark.title || bookmark.url}
                            </a>
                        `;
                        bookmarksUl.appendChild(bookmarkLi);
                    });
                    
                    folderContent.appendChild(bookmarksUl);
                } else {
                    folderContent.innerHTML = '<div class="text-neutral italic"><i class="fa fa-info-circle mr-1"></i> 空文件夹</div>';
                }
                
                // 点击折叠/展开
                folderName.addEventListener('click', () => {
                    folderContent.classList.toggle('hidden');
                    const icon = folderName.querySelector('.fa-chevron-down');
                    icon.classList.toggle('rotate-180');
                });
                
                folderDiv.appendChild(folderName);
                folderDiv.appendChild(folderContent);
                bookmarksList.appendChild(folderDiv);
            });
            
            container.appendChild(bookmarksList);
        }
    </script>
</body>
</html>
