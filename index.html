<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星际导航 | 探索网络宇宙</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        space: {
                            dark: '#0B0E2D',
                            darker: '#070A1A',
                            blue: '#1E3A8A',
                            purple: '#4C1D95',
                            pink: '#EC4899',
                            neon: '#3B82F6',
                            glow: '#60A5FA'
                        }
                    },
                    fontFamily: {
                        space: ['Orbitron', 'sans-serif']
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'twinkle': 'twinkle 3s ease-in-out infinite',
                        'spin-slow': 'spin 20s linear infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        twinkle: {
                            '0%, 100%': { opacity: 0.6 },
                            '50%': { opacity: 1 }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .text-shadow { text-shadow: 0 0 8px rgba(100, 149, 237, 0.8); }
            .text-shadow-neon { text-shadow: 0 0 10px rgba(59, 130, 246, 0.8), 0 0 20px rgba(59, 130, 246, 0.5); }
            .bg-stars { background-image: radial-gradient(circle, #ffffff 1px, rgba(0, 0, 0, 0) 1px); background-size: 50px 50px; }
            .glow { box-shadow: 0 0 15px rgba(59, 130, 246, 0.7); }
            .glow-pink { box-shadow: 0 0 15px rgba(236, 72, 153, 0.7); }
            .bookmark-hover { transition: all 0.3s ease; }
            .bookmark-hover:hover { transform: translateY(-3px) scale(1.02); }
            .planet { border-radius: 50%; position: absolute; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2), transparent 70%); }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%231E3A8A'/%3E%3Ccircle cx='50' cy='50' r='30' fill='%233B82F6'/%3E%3Ccircle cx='50' cy='50' r='15' fill='%2360A5FA'/%3E%3C/svg%3E" type="image/svg+xml">
</head>
<body class="font-sans bg-gray-50 text-gray-900 dark:bg-space-dark dark:text-gray-100 transition-colors duration-500 min-h-screen overflow-x-hidden">
    <!-- 星空背景 -->
    <div class="fixed inset-0 bg-stars opacity-30 dark:opacity-60 pointer-events-none z-0"></div>
    
    <!-- 装饰行星 -->
    <div class="fixed top-20 left-10 w-32 h-32 planet bg-space-purple/30 animate-float hidden lg:block z-0"></div>
    <div class="fixed bottom-40 right-20 w-48 h-48 planet bg-space-blue/20 animate-float animation-delay-2000 hidden lg:block z-0"></div>
    <div class="fixed top-1/3 right-1/4 w-24 h-24 planet bg-space-pink/20 animate-float animation-delay-4000 hidden md:block z-0"></div>
    
    <!-- 顶部导航栏 -->
    <header class="relative z-10 backdrop-blur-md bg-white/70 dark:bg-space-darker/80 border-b border-gray-200 dark:border-space-blue/30 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-space-blue to-space-purple flex items-center justify-center glow">
                    <i class="fa fa-compass text-white text-xl"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-space font-bold text-shadow-neon">星际导航</h1>
            </div>
            
            <div class="flex items-center space-x-1 md:space-x-4">
                <!-- 主题切换按钮 -->
                <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-space-blue/30 transition-all duration-300 relative group">
                    <i class="fa fa-moon-o dark:hidden text-gray-700"></i>
                    <i class="fa fa-sun-o hidden dark:block text-yellow-300"></i>
                    <span class="absolute right-full mr-2 mt-1 w-36 bg-gray-800 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        切换到<span class="dark:hidden">黑夜</span><span class="hidden dark:inline">白天</span>模式
                    </span>
                </button>
                
                <!-- 编辑页入口 -->
                <button id="editBtn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-space-blue/30 transition-all duration-300 relative group">
                    <i class="fa fa-cog text-gray-700 dark:text-gray-300"></i>
                    <span class="absolute right-full mr-2 mt-1 w-24 bg-gray-800 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        书签编辑中心
                    </span>
                </button>
            </div>
        </div>
    </header>

    <!-- 顶部小组件区域 -->
    <section id="widgetsBar" class="relative z-10 container mx-auto px-4 py-4 transition-all duration-500">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- 在线时长统计 -->
            <div class="bg-white/80 dark:bg-space-darker/60 backdrop-blur-sm rounded-xl p-4 border border-gray-200 dark:border-space-blue/20 shadow-lg hover:shadow-xl transition-all duration-300">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-space font-semibold text-gray-700 dark:text-gray-300">在线时长</h3>
                    <i class="fa fa-clock-o text-space-neon"></i>
                </div>
                <div class="h-24">
                    <canvas id="onlineTimeChart"></canvas>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">本周累计: <span id="totalOnlineTime">3.5 小时</span></div>
            </div>
            
            <!-- 健康提醒 -->
            <div class="bg-white/80 dark:bg-space-darker/60 backdrop-blur-sm rounded-xl p-4 border border-gray-200 dark:border-space-blue/20 shadow-lg hover:shadow-xl transition-all duration-300">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-space font-semibold text-gray-700 dark:text-gray-300">健康提醒</h3>
                    <i class="fa fa-heartbeat text-space-pink"></i>
                </div>
                <div id="healthReminder" class="h-24 flex items-center justify-center text-center">
                    <p class="text-gray-600 dark:text-gray-300">距离下一次休息还有 <span class="font-bold text-space-neon">25 分钟</span></p>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">每小时活动有助于保护视力</div>
            </div>
            
            <!-- 世界时间 -->
            <div class="bg-white/80 dark:bg-space-darker/60 backdrop-blur-sm rounded-xl p-4 border border-gray-200 dark:border-space-blue/20 shadow-lg hover:shadow-xl transition-all duration-300">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-space font-semibold text-gray-700 dark:text-gray-300">世界时间</h3>
                    <div class="flex space-x-1">
                        <button id="addTimezone" class="p-1 rounded hover:bg-gray-200 dark:hover:bg-space-blue/30 text-gray-600 dark:text-gray-400">
                            <i class="fa fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>
                <div id="timezonesContainer" class="h-24 overflow-y-auto pr-1">
                    <!-- 世界时间会动态添加到这里 -->
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">点击城市可删除</div>
            </div>
        </div>
    </section>

    <!-- 广告位 1 -->
    <section class="relative z-10 container mx-auto px-4 py-4">
        <div id="adSlot1" class="bg-white/60 dark:bg-space-blue/20 backdrop-blur-sm rounded-xl p-2 border border-gray-200 dark:border-space-blue/30 shadow-md overflow-hidden">
            <div class="aspect-video w-full bg-gradient-to-r from-space-blue/20 to-space-purple/20 rounded-lg flex items-center justify-center">
                <p class="text-gray-500 dark:text-gray-400 text-center">广告位 1</p>
            </div>
        </div>
    </section>

    <!-- 书签展示区域 -->
    <section class="relative z-10 container mx-auto px-4 py-6">
        <h2 class="text-2xl font-space font-bold mb-6 text-shadow">网络星系</h2>
        
        <div id="bookmarksContainer" class="space-y-6">
            <!-- 书签分组会动态添加到这里 -->
        </div>
    </section>

    <!-- 广告位 2 -->
    <section class="relative z-10 container mx-auto px-4 py-4">
        <div id="adSlot2" class="bg-white/60 dark:bg-space-blue/20 backdrop-blur-sm rounded-xl p-2 border border-gray-200 dark:border-space-blue/30 shadow-md overflow-hidden">
            <div class="aspect-video w-full bg-gradient-to-r from-space-purple/20 to-space-pink/20 rounded-lg flex items-center justify-center">
                <p class="text-gray-500 dark:text-gray-400 text-center">广告位 2</p>
            </div>
        </div>
    </section>

    <!-- 广告位 3 -->
    <section class="relative z-10 container mx-auto px-4 py-4">
        <div id="adSlot3" class="bg-white/60 dark:bg-space-blue/20 backdrop-blur-sm rounded-xl p-2 border border-gray-200 dark:border-space-blue/30 shadow-md overflow-hidden">
            <div class="aspect-video w-full bg-gradient-to-r from-space-pink/20 to-space-blue/20 rounded-lg flex items-center justify-center">
                <p class="text-gray-500 dark:text-gray-400 text-center">广告位 3</p>
            </div>
        </div>
    </section>

    <!-- 页脚 -->
    <footer class="relative z-10 mt-12 py-6 border-t border-gray-200 dark:border-space-blue/30 bg-white/80 dark:bg-space-darker/80 backdrop-blur-md">
        <div class="container mx-auto px-4">
            <div class="dark-white flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0" id="totalSites">共收录 0 个网站</div>
                <div>
                    <p>Copyright © 2018-<span id="currentYear"></span> <span id="hostname">星际导航</span>, All Rights Reserved</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- 编辑页模态框 -->
    <div id="editModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="modalOverlay"></div>
        <div class="relative bg-white dark:bg-space-darker rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
            <!-- 编辑页头部 -->
            <div class="border-b border-gray-200 dark:border-space-blue/30 p-4 flex justify-between items-center">
                <h2 class="text-xl font-space font-bold">书签编辑中心</h2>
                <button id="closeEditModal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-space-blue/30">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 编辑页内容 -->
            <div class="flex-1 overflow-y-auto p-4">
                <!-- GitHub 配置 -->
                <div class="mb-6 bg-gray-50 dark:bg-space-blue/10 p-4 rounded-xl">
                    <h3 class="font-space font-semibold mb-3">GitHub 配置</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">用户名</label>
                            <input type="text" id="githubUsername" placeholder="username" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">仓库名</label>
                            <input type="text" id="githubRepo" placeholder="repo-name" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Token (可选)</label>
                            <input type="password" id="githubToken" placeholder="ghp_..." class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                        </div>
                    </div>
                    <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
                        未配置时将使用默认仓库: jiezion/jznav
                    </div>
                </div>
                
                <!-- 书签管理 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-space font-semibold">书签管理</h3>
                        <button id="addBookmarkBtn" class="px-3 py-1 bg-space-neon text-white rounded-lg hover:bg-space-blue transition-colors">
                            <i class="fa fa-plus mr-1"></i> 添加书签
                        </button>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mb-4">
                        <button id="importBookmarkBtn" class="px-3 py-1 bg-gray-200 dark:bg-space-blue/30 rounded-lg hover:bg-gray-300 dark:hover:bg-space-blue/50 transition-colors">
                            <i class="fa fa-upload mr-1"></i> 导入HTML书签
                        </button>
                        <button id="exportBookmarkBtn" class="px-3 py-1 bg-gray-200 dark:bg-space-blue/30 rounded-lg hover:bg-gray-300 dark:hover:bg-space-blue/50 transition-colors">
                            <i class="fa fa-download mr-1"></i> 导出HTML书签
                        </button>
                        <button id="backupJSONBtn" class="px-3 py-1 bg-gray-200 dark:bg-space-blue/30 rounded-lg hover:bg-gray-300 dark:hover:bg-space-blue/50 transition-colors">
                            <i class="fa fa-save mr-1"></i> 备份JSON
                        </button>
                        <button id="loadJSONBtn" class="px-3 py-1 bg-gray-200 dark:bg-space-blue/30 rounded-lg hover:bg-gray-300 dark:hover:bg-space-blue/50 transition-colors">
                            <i class="fa fa-load mr-1"></i> 加载JSON
                        </button>
                    </div>
                    
                    <div id="bookmarksEditContainer" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        <!-- 编辑模式的书签会动态添加到这里 -->
                    </div>
                    
                    <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
                        共 <span id="bookmarkCount">0</span> 个书签
                    </div>
                </div>
                
                <!-- 广告管理 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-space font-semibold">广告管理</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- 广告位 1 编辑 -->
                        <div class="bg-gray-50 dark:bg-space-blue/10 p-4 rounded-xl">
                            <h4 class="font-medium mb-2">广告位 1</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">广告图片 (最大3M)</label>
                                    <input type="file" id="ad1Image" accept="image/*" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">广告链接</label>
                                    <input type="url" id="ad1Link" placeholder="https://example.com" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                                </div>
                            </div>
                            <div class="mt-2 flex justify-end">
                                <button data-ad="1" class="deleteAdBtn px-3 py-1 bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
                                    <i class="fa fa-trash mr-1"></i> 删除广告
                                </button>
                            </div>
                        </div>
                        
                        <!-- 广告位 2 编辑 -->
                        <div class="bg-gray-50 dark:bg-space-blue/10 p-4 rounded-xl">
                            <h4 class="font-medium mb-2">广告位 2</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">广告图片 (最大3M)</label>
                                    <input type="file" id="ad2Image" accept="image/*" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">广告链接</label>
                                    <input type="url" id="ad2Link" placeholder="https://example.com" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                                </div>
                            </div>
                            <div class="mt-2 flex justify-end">
                                <button data-ad="2" class="deleteAdBtn px-3 py-1 bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
                                    <i class="fa fa-trash mr-1"></i> 删除广告
                                </button>
                            </div>
                        </div>
                        
                        <!-- 广告位 3 编辑 -->
                        <div class="bg-gray-50 dark:bg-space-blue/10 p-4 rounded-xl">
                            <h4 class="font-medium mb-2">广告位 3</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">广告图片 (最大3M)</label>
                                    <input type="file" id="ad3Image" accept="image/*" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">广告链接</label>
                                    <input type="url" id="ad3Link" placeholder="https://example.com" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                                </div>
                            </div>
                            <div class="mt-2 flex justify-end">
                                <button data-ad="3" class="deleteAdBtn px-3 py-1 bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
                                    <i class="fa fa-trash mr-1"></i> 删除广告
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 世界时间管理 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-space font-semibold">世界时间管理</h3>
                        <button id="addTimezoneBtn" class="px-3 py-1 bg-space-neon text-white rounded-lg hover:bg-space-blue transition-colors">
                            <i class="fa fa-plus mr-1"></i> 添加时区
                        </button>
                    </div>
                    
                    <div id="timezonesEditContainer" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                        <!-- 编辑模式的世界时间会动态添加到这里 -->
                    </div>
                </div>
            </div>
            
            <!-- 编辑页底部 -->
            <div class="border-t border-gray-200 dark:border-space-blue/30 p-4 flex justify-end space-x-3">
                <button id="cancelEditBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-space-blue/20 transition-colors">
                    取消
                </button>
                <button id="saveChangesBtn" class="px-4 py-2 bg-space-neon text-white rounded-lg hover:bg-space-blue transition-colors">
                    保存更改
                </button>
            </div>
        </div>
    </div>

    <!-- 添加书签模态框 -->
    <div id="addBookmarkModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="addBookmarkOverlay"></div>
        <div class="relative bg-white dark:bg-space-darker rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-xl font-space font-bold mb-4">添加新书签</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">网站标题</label>
                    <input type="text" id="newBookmarkTitle" placeholder="网站名称" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">网站URL</label>
                    <input type="url" id="newBookmarkUrl" placeholder="https://example.com" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">分组</label>
                    <input type="text" id="newBookmarkGroup" placeholder="默认分组" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelAddBookmarkBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-space-blue/20 transition-colors">
                    取消
                </button>
                <button id="confirmAddBookmarkBtn" class="px-4 py-2 bg-space-neon text-white rounded-lg hover:bg-space-blue transition-colors">
                    添加
                </button>
            </div>
        </div>
    </div>

    <!-- 添加时区模态框 -->
    <div id="addTimezoneModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="addTimezoneOverlay"></div>
        <div class="relative bg-white dark:bg-space-darker rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-xl font-space font-bold mb-4">添加时区</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">城市名称</label>
                    <input type="text" id="newTimezoneCity" placeholder="例如: 北京" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">时区 (UTC±X)</label>
                    <input type="text" id="newTimezoneOffset" placeholder="例如: +8" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-space-blue/50 bg-white dark:bg-space-darker focus:outline-none focus:ring-2 focus:ring-space-neon">
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelAddTimezoneBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-space-blue/20 transition-colors">
                    取消
                </button>
                <button id="confirmAddTimezoneBtn" class="px-4 py-2 bg-space-neon text-white rounded-lg hover:bg-space-blue transition-colors">
                    添加
                </button>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center space-x-2 max-w-sm"></div>

    <script>
        // 全局数据存储
        const appData = {
            bookmarks: [],
            worldClocks: [
                { id: '1', city: '北京', timezone: '+8' },
                { id: '2', city: '伦敦', timezone: '0' },
                { id: '3', city: '纽约', timezone: '-4' }
            ],
            ads: [
                { id: '1', imageUrl: '', link: '' },
                { id: '2', imageUrl: '', link: '' },
                { id: '3', imageUrl: '', link: '' }
            ],
            settings: {
                theme: 'light',
                onlineTime: [
                    { day: '周一', hours: 0.5 },
                    { day: '周二', hours: 0.8 },
                    { day: '周三', hours: 1.2 },
                    { day: '周四', hours: 0.6 },
                    { day: '周五', hours: 0.4 }
                ]
            }
        };

        // DOM 元素
        const elements = {
            themeToggle: document.getElementById('themeToggle'),
            editBtn: document.getElementById('editBtn'),
            editModal: document.getElementById('editModal'),
            modalOverlay: document.getElementById('modalOverlay'),
            closeEditModal: document.getElementById('closeEditModal'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            saveChangesBtn: document.getElementById('saveChangesBtn'),
            bookmarksContainer: document.getElementById('bookmarksContainer'),
            bookmarksEditContainer: document.getElementById('bookmarksEditContainer'),
            addBookmarkBtn: document.getElementById('addBookmarkBtn'),
            addBookmarkModal: document.getElementById('addBookmarkModal'),
            addBookmarkOverlay: document.getElementById('addBookmarkOverlay'),
            cancelAddBookmarkBtn: document.getElementById('cancelAddBookmarkBtn'),
            confirmAddBookmarkBtn: document.getElementById('confirmAddBookmarkBtn'),
            importBookmarkBtn: document.getElementById('importBookmarkBtn'),
            exportBookmarkBtn: document.getElementById('exportBookmarkBtn'),
            backupJSONBtn: document.getElementById('backupJSONBtn'),
            loadJSONBtn: document.getElementById('loadJSONBtn'),
            bookmarkCount: document.getElementById('bookmarkCount'),
            totalSites: document.getElementById('totalSites'),
            currentYear: document.getElementById('currentYear'),
            hostname: document.getElementById('hostname'),
            timezonesContainer: document.getElementById('timezonesContainer'),
            timezonesEditContainer: document.getElementById('timezonesEditContainer'),
            addTimezoneBtn: document.getElementById('addTimezoneBtn'),
            addTimezoneModal: document.getElementById('addTimezoneModal'),
            addTimezoneOverlay: document.getElementById('addTimezoneOverlay'),
            cancelAddTimezoneBtn: document.getElementById('cancelAddTimezoneBtn'),
            confirmAddTimezoneBtn: document.getElementById('confirmAddTimezoneBtn'),
            githubUsername: document.getElementById('githubUsername'),
            githubRepo: document.getElementById('githubRepo'),
            githubToken: document.getElementById('githubToken'),
            widgetsBar: document.getElementById('widgetsBar'),
            notification: document.getElementById('notification')
        };

        // 初始化
        async function init() {
            // 设置当前年份
            elements.currentYear.textContent = new Date().getFullYear();
            
            // 加载主题设置
            loadTheme();
            
            // 从GitHub加载数据
            await loadDataFromGitHub();
            
            // 渲染UI
            renderBookmarks();
            renderBookmarksEdit();
            renderTimezones();
            renderTimezonesEdit();
            renderAds();
            initOnlineTimeChart();
            updateBookmarkCount();
            
            // 设置事件监听
            setupEventListeners();
            
            // 设置滚动监听，控制小组件栏显示/隐藏
            setupScrollListener();
        }

        // 加载主题设置
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            appData.settings.theme = savedTheme;
            
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // 切换主题
        function toggleTheme() {
            const newTheme = appData.settings.theme === 'light' ? 'dark' : 'light';
            appData.settings.theme = newTheme;
            
            if (newTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            localStorage.setItem('theme', newTheme);
        }

        // 从GitHub加载数据
        async function loadDataFromGitHub() {
            try {
                let username = elements.githubUsername.value.trim() || 'jiezion';
                let repo = elements.githubRepo.value.trim() || 'jznav';
                const token = elements.githubToken.value.trim();
                
                let url;
                let headers = {};
                
                if (token) {
                    url = `https://api.github.com/repos/${username}/${repo}/contents/bookmarks.json`;
                    headers = {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    };
                } else {
                    url = `https://raw.githubusercontent.com/${username}/${repo}/main/bookmarks.json`;
                }
                
                const response = await fetch(url, { headers });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                let data;
                if (token) {
                    const githubData = await response.json();
                    const content = atob(githubData.content);
                    data = JSON.parse(content);
                } else {
                    data = await response.json();
                }
                
                // 合并数据，新数据覆盖默认数据
                if (data.bookmarks) appData.bookmarks = data.bookmarks;
                if (data.worldClocks) appData.worldClocks = data.worldClocks;
                if (data.ads) appData.ads = data.ads;
                if (data.settings) appData.settings = { ...appData.settings, ...data.settings };
                
                showNotification('数据加载成功', 'success');
            } catch (error) {
                console.error('加载GitHub数据失败:', error);
                showNotification('使用本地默认数据', 'info');
            }
        }

        // 保存数据到GitHub
        async function saveDataToGitHub() {
            try {
                let username = elements.githubUsername.value.trim() || 'jiezion';
                let repo = elements.githubRepo.value.trim() || 'jznav';
                const token = elements.githubToken.value.trim();
                
                if (!token && (username !== 'jiezion' || repo !== 'jznav')) {
                    showNotification('没有Token，无法保存到自定义仓库', 'error');
                    return false;
                }
                
                const content = JSON.stringify(appData, null, 2);
                
                // 处理非Latin1字符
                const base64Content = btoa(unescape(encodeURIComponent(content)));
                
                let url = `https://api.github.com/repos/${username}/${repo}/contents/bookmarks.json`;
                let sha;
                
                // 检查文件是否已存在
                try {
                    const checkResponse = await fetch(url, {
                        headers: token ? { 'Authorization': `token ${token}` } : {}
                    });
                    
                    if (checkResponse.ok) {
                        const existingData = await checkResponse.json();
                        sha = existingData.sha;
                    }
                } catch (e) {
                    console.log('文件可能不存在，将创建新文件');
                }
                
                const payload = {
                    message: `Update bookmarks - ${new Date().toISOString()}`,
                    content: base64Content
                };
                
                if (sha) {
                    payload.sha = sha;
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': token ? `token ${token}` : '',
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                showNotification('数据已成功保存到GitHub', 'success');
                return true;
            } catch (error) {
                console.error('保存数据到GitHub失败:', error);
                showNotification(`保存失败: ${error.message}`, 'error');
                return false;
            }
        }

        // 渲染书签（主页）
        function renderBookmarks() {
            elements.bookmarksContainer.innerHTML = '';
            
            if (appData.bookmarks.length === 0) {
                elements.bookmarksContainer.innerHTML = `
                    <div class="text-center py-12 bg-white/60 dark:bg-space-blue/10 rounded-xl">
                        <i class="fa fa-folder-open-o text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400">暂无书签，请在编辑中心添加</p>
                    </div>
                `;
                return;
            }
            
            // 按分组整理书签
            const groupedBookmarks = {};
            appData.bookmarks.forEach(bookmark => {
                const group = bookmark.group || '未分组';
                if (!groupedBookmarks[group]) {
                    groupedBookmarks[group] = [];
                }
                groupedBookmarks[group].push(bookmark);
            });
            
            // 渲染每个分组
            Object.keys(groupedBookmarks).forEach(groupName => {
                const groupElement = document.createElement('div');
                groupElement.className = 'bg-white/80 dark:bg-space-darker/60 backdrop-blur-sm rounded-xl p-4 border border-gray-200 dark:border-space-blue/20 shadow-lg';
                
                const bookmarks = groupedBookmarks[groupName];
                
                groupElement.innerHTML = `
                    <h3 class="font-space font-semibold text-lg mb-4 text-space-neon">${groupName}</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        ${bookmarks.map(bookmark => `
                            <a href="${bookmark.url}" target="_blank" class="flex items-center space-x-2 p-3 bg-gray-50 dark:bg-space-blue/10 rounded-lg bookmark-hover border border-gray-100 dark:border-space-blue/20">
                                <img src="${getFaviconUrl(bookmark.url)}" alt="${bookmark.title} 图标" class="w-6 h-6 rounded">
                                <span class="text-sm truncate">${bookmark.title}</span>
                            </a>
                        `).join('')}
                    </div>
                `;
                
                elements.bookmarksContainer.appendChild(groupElement);
            });
        }

        // 渲染编辑模式的书签
        function renderBookmarksEdit() {
            elements.bookmarksEditContainer.innerHTML = '';
            
            if (appData.bookmarks.length === 0) {
                elements.bookmarksEditContainer.innerHTML = `
                    <div class="text-center py-6 text-gray-500 dark:text-gray-400">
                        暂无书签，请添加
                    </div>
                `;
                return;
            }
            
            // 按分组整理书签
            const groupedBookmarks = {};
            appData.bookmarks.forEach(bookmark => {
                const group = bookmark.group || '未分组';
                if (!groupedBookmarks[group]) {
                    groupedBookmarks[group] = [];
                }
                groupedBookmarks[group].push(bookmark);
            });
            
            // 渲染每个分组
            Object.keys(groupedBookmarks).forEach(groupName => {
                const groupElement = document.createElement('div');
                groupElement.className = 'mb-4';
                
                groupElement.innerHTML = `
                    <h4 class="font-medium text-space-neon mb-2">${groupName}</h4>
                    <div class="space-y-2 pl-4 border-l-2 border-gray-200 dark:border-space-blue/30">
                        ${groupedBookmarks[groupName].map(bookmark => `
                            <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-space-blue/10 rounded-lg">
                                <div class="flex items-center space-x-2 flex-1 min-w-0">
                                    <img src="${getFaviconUrl(bookmark.url)}" alt="${bookmark.title} 图标" class="w-5 h-5 rounded flex-shrink-0">
                                    <div class="min-w-0">
                                        <div class="text-sm font-medium truncate">${bookmark.title}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 truncate">${bookmark.url}</div>
                                    </div>
                                </div>
                                <div class="flex space-x-1 ml-2">
                                    <button data-id="${bookmark.id}" class="editBookmarkBtn p-1.5 rounded hover:bg-gray-200 dark:hover:bg-space-blue/30">
                                        <i class="fa fa-pencil text-gray-600 dark:text-gray-400"></i>
                                    </button>
                                    <button data-id="${bookmark.id}" class="deleteBookmarkBtn p-1.5 rounded hover:bg-gray-200 dark:hover:bg-red-900/30">
                                        <i class="fa fa-trash text-gray-600 dark:text-red-400"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                elements.bookmarksEditContainer.appendChild(groupElement);
            });
            
            // 添加编辑和删除书签的事件监听
            document.querySelectorAll('.editBookmarkBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    editBookmark(id);
                });
            });
            
            document.querySelectorAll('.deleteBookmarkBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    deleteBookmark(id);
                });
            });
        }

        // 获取网站图标URL
        function getFaviconUrl(url) {
            try {
                const parsedUrl = new URL(url);
                return `${parsedUrl.protocol}//${parsedUrl.hostname}/favicon.ico`;
            } catch (e) {
                return 'https://picsum.photos/32/32?grayscale';
            }
        }

        // 更新书签计数
        function updateBookmarkCount() {
            elements.bookmarkCount.textContent = appData.bookmarks.length;
            elements.totalSites.textContent = `共收录 ${appData.bookmarks.length} 个网站`;
        }

        // 添加书签
        function addBookmark(title, url, group) {
            // 去重检查
            const exists = appData.bookmarks.some(b => b.url.toLowerCase() === url.toLowerCase());
            if (exists) {
                showNotification('该书签已存在', 'warning');
                return false;
            }
            
            const newBookmark = {
                id: Date.now().toString(),
                title: title || new URL(url).hostname,
                url: url,
                group: group || '未分组'
            };
            
            appData.bookmarks.push(newBookmark);
            
            renderBookmarks();
            renderBookmarksEdit();
            updateBookmarkCount();
            
            showNotification('书签添加成功', 'success');
            return true;
        }

        // 编辑书签
        function editBookmark(id) {
            const bookmark = appData.bookmarks.find(b => b.id === id);
            if (!bookmark) return;
            
            // 填充表单
            document.getElementById('newBookmarkTitle').value = bookmark.title;
            document.getElementById('newBookmarkUrl').value = bookmark.url;
            document.getElementById('newBookmarkGroup').value = bookmark.group || '';
            
            // 显示模态框
            elements.addBookmarkModal.classList.remove('hidden');
            
            // 替换确认按钮事件
            const originalHandler = elements.confirmAddBookmarkBtn.onclick;
            elements.confirmAddBookmarkBtn.onclick = function() {
                const title = document.getElementById('newBookmarkTitle').value.trim();
                const url = document.getElementById('newBookmarkUrl').value.trim();
                const group = document.getElementById('newBookmarkGroup').value.trim();
                
                if (!url) {
                    showNotification('请输入网站URL', 'error');
                    return;
                }
                
                // 更新书签
                const index = appData.bookmarks.findIndex(b => b.id === id);
                if (index !== -1) {
                    appData.bookmarks[index] = {
                        ...appData.bookmarks[index],
                        title: title || new URL(url).hostname,
                        url: url,
                        group: group || '未分组'
                    };
                    
                    renderBookmarks();
                    renderBookmarksEdit();
                    updateBookmarkCount();
                    
                    showNotification('书签更新成功', 'success');
                }
                
                // 隐藏模态框
                elements.addBookmarkModal.classList.add('hidden');
                
                // 恢复原始事件处理
                elements.confirmAddBookmarkBtn.onclick = originalHandler;
                
                // 清空表单
                document.getElementById('newBookmarkTitle').value = '';
                document.getElementById('newBookmarkUrl').value = '';
                document.getElementById('newBookmarkGroup').value = '';
            };
        }

        // 删除书签
        function deleteBookmark(id) {
            const bookmark = appData.bookmarks.find(b => b.id === id);
            if (!bookmark) return;
            
            if (confirm(`确定要删除书签 "${bookmark.title}" 吗？`)) {
                appData.bookmarks = appData.bookmarks.filter(b => b.id !== id);
                
                renderBookmarks();
                renderBookmarksEdit();
                updateBookmarkCount();
                
                showNotification('书签已删除', 'info');
            }
        }

        // 导入HTML书签
        function importBookmarks() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.html';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(event.target.result, 'text/html');
                        const bookmarks = parseBookmarkHtml(doc);
                        
                        if (bookmarks.length === 0) {
                            showNotification('未找到有效的书签', 'warning');
                            return;
                        }
                        
                        // 去重并合并书签
                        let newCount = 0;
                        bookmarks.forEach(bookmark => {
                            const exists = appData.bookmarks.some(b => 
                                b.url.toLowerCase() === bookmark.url.toLowerCase()
                            );
                            
                            if (!exists) {
                                appData.bookmarks.push({
                                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                                    ...bookmark
                                });
                                newCount++;
                            }
                        });
                        
                        renderBookmarks();
                        renderBookmarksEdit();
                        updateBookmarkCount();
                        
                        showNotification(`成功导入 ${newCount} 个新书签`, 'success');
                    } catch (error) {
                        console.error('导入书签失败:', error);
                        showNotification('导入书签失败，请检查文件格式', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // 解析HTML书签文件
        function parseBookmarkHtml(doc) {
            const bookmarks = [];
            
            function processNode(node, currentGroup = '未分组') {
                if (node.tagName === 'A') {
                    // 书签项
                    bookmarks.push({
                        title: node.textContent.trim(),
                        url: node.href,
                        group: currentGroup
                    });
                } else if (node.tagName === 'DL') {
                    // 书签列表
                    Array.from(node.children).forEach(child => {
                        if (child.tagName === 'DT') {
                            processNode(child.firstElementChild, currentGroup);
                        }
                    });
                } else if (node.tagName === 'DT') {
                    // 列表项
                    const child = node.firstElementChild;
                    if (child.tagName === 'H3') {
                        // 文件夹（分组）
                        const groupName = child.textContent.trim();
                        const nextSibling = node.nextElementSibling;
                        if (nextSibling && nextSibling.tagName === 'DL') {
                            processNode(nextSibling, groupName);
                        }
                    } else if (child.tagName === 'A') {
                        // 直接的书签项
                        processNode(child, currentGroup);
                    }
                }
            }
            
            // 查找书签的根节点
            const rootNode = doc.querySelector('dl') || doc.body;
            processNode(rootNode);
            
            return bookmarks;
        }

        // 导出HTML书签
        function exportBookmarks() {
            if (appData.bookmarks.length === 0) {
                showNotification('没有书签可导出', 'warning');
                return;
            }
            
            // 按分组整理书签
            const groupedBookmarks = {};
            appData.bookmarks.forEach(bookmark => {
                const group = bookmark.group || '未分组';
                if (!groupedBookmarks[group]) {
                    groupedBookmarks[group] = [];
                }
                groupedBookmarks[group].push(bookmark);
            });
            
            // 构建HTML内容
            let html = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>书签导出</TITLE>
<H1>书签</H1>
<DL><p>
`;
            
            // 添加分组和书签
            Object.keys(groupedBookmarks).forEach(groupName => {
                html += `    <DT><H3>${escapeHtml(groupName)}</H3>
    <DL><p>
`;
                
                groupedBookmarks[groupName].forEach(bookmark => {
                    html += `        <DT><A HREF="${escapeHtml(bookmark.url)}">${escapeHtml(bookmark.title)}</A>
`;
                });
                
                html += `    </DL><p>
`;
            });
            
            html += `</DL><p>`;
            
            // 创建并下载文件
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookmarks_${new Date().toISOString().slice(0,10)}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('书签导出成功', 'success');
        }

        // 备份JSON数据
        function backupJSON() {
            const jsonData = JSON.stringify(appData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookmarks_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('JSON备份成功', 'success');
        }

        // 加载JSON备份
        function loadJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (data.bookmarks) {
                            // 合并书签，去重
                            data.bookmarks.forEach(bookmark => {
                                const exists = appData.bookmarks.some(b => 
                                    b.url.toLowerCase() === bookmark.url.toLowerCase()
                                );
                                
                                if (!exists) {
                                    appData.bookmarks.push({
                                        id: bookmark.id || Date.now().toString() + Math.random().toString(36).substr(2, 5),
                                        ...bookmark
                                    });
                                }
                            });
                        }
                        
                        if (data.worldClocks) appData.worldClocks = data.worldClocks;
                        if (data.ads) appData.ads = data.ads;
                        if (data.settings) appData.settings = { ...appData.settings, ...data.settings };
                        
                        renderBookmarks();
                        renderBookmarksEdit();
                        renderTimezones();
                        renderTimezonesEdit();
                        renderAds();
                        updateBookmarkCount();
                        loadTheme(); // 应用可能的主题变更
                        
                        showNotification('JSON备份加载成功', 'success');
                    } catch (error) {
                        console.error('加载JSON备份失败:', error);
                        showNotification('加载JSON备份失败，请检查文件格式', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // 渲染世界时间（主页）
        function renderTimezones() {
            elements.timezonesContainer.innerHTML = '';
            
            if (appData.worldClocks.length === 0) {
                elements.timezonesContainer.innerHTML = `
                    <div class="h-full flex items-center justify-center">
                        <p class="text-gray-500 dark:text-gray-400">暂无时区，请添加</p>
                    </div>
                `;
                return;
            }
            
            // 更新并显示所有时区的时间
            appData.worldClocks.forEach(clock => {
                const clockElement = document.createElement('div');
                clockElement.className = 'flex justify-between items-center py-1 border-b border-gray-100 dark:border-space-blue/10 last:border-0';
                
                // 计算时区时间
                const now = new Date();
                const utcTime = now.getTime() + now.getTimezoneOffset() * 60000;
                const offsetHours = parseFloat(clock.timezone);
                const localTime = new Date(utcTime + offsetHours * 3600000);
                
                clockElement.innerHTML = `
                    <span class="font-medium">${clock.city}</span>
                    <span class="text-space-neon">${localTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                `;
                
                elements.timezonesContainer.appendChild(clockElement);
            });
            
            // 每秒更新一次时间
            clearTimeout(window.timezoneUpdateTimeout);
            window.timezoneUpdateTimeout = setTimeout(renderTimezones, 1000);
        }

        // 渲染编辑模式的世界时间
        function renderTimezonesEdit() {
            elements.timezonesEditContainer.innerHTML = '';
            
            if (appData.worldClocks.length === 0) {
                elements.timezonesEditContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                        暂无时区，请添加
                    </div>
                `;
                return;
            }
            
            appData.worldClocks.forEach(clock => {
                const clockElement = document.createElement('div');
                clockElement.className = 'flex justify-between items-center p-2 bg-gray-50 dark:bg-space-blue/10 rounded-lg';
                
                clockElement.innerHTML = `
                    <div>
                        <div class="font-medium">${clock.city}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">UTC${clock.timezone}</div>
                    </div>
                    <button data-id="${clock.id}" class="deleteTimezoneBtn p-1.5 rounded hover:bg-gray-200 dark:hover:bg-red-900/30">
                        <i class="fa fa-trash text-gray-600 dark:text-red-400"></i>
                    </button>
                `;
                
                elements.timezonesEditContainer.appendChild(clockElement);
            });
            
            // 添加删除时区的事件监听
            document.querySelectorAll('.deleteTimezoneBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    deleteTimezone(id);
                });
            });
        }

        // 添加时区
        function addTimezone(city, offset) {
            if (!city || !offset) {
                showNotification('请输入城市和时区', 'error');
                return false;
            }
            
            // 验证时区格式
            if (!/^[+-]\d{1,2}$/.test(offset)) {
                showNotification('时区格式应为 ±X (例如: +8, -5)', 'error');
                return false;
            }
            
            // 去重检查
            const exists = appData.worldClocks.some(c => c.city.toLowerCase() === city.toLowerCase());
            if (exists) {
                showNotification('该城市时区已存在', 'warning');
                return false;
            }
            
            appData.worldClocks.push({
                id: Date.now().toString(),
                city: city,
                timezone: offset
            });
            
            renderTimezones();
            renderTimezonesEdit();
            
            showNotification(`已添加 ${city} 时区`, 'success');
            return true;
        }

        // 删除时区
        function deleteTimezone(id) {
            const clock = appData.worldClocks.find(c => c.id === id);
            if (!clock) return;
            
            if (confirm(`确定要删除 ${clock.city} 时区吗？`)) {
                appData.worldClocks = appData.worldClocks.filter(c => c.id !== id);
                
                renderTimezones();
                renderTimezonesEdit();
                
                showNotification(`${clock.city} 时区已删除`, 'info');
            }
        }

        // 渲染广告
        function renderAds() {
            appData.ads.forEach(ad => {
                const adSlot = document.getElementById(`adSlot${ad.id}`);
                if (!adSlot) return;
                
                if (ad.imageUrl && ad.link) {
                    adSlot.innerHTML = `
                        <a href="${ad.link}" target="_blank" class="block w-full h-full">
                            <img src="${ad.imageUrl}" alt="广告图片 ${ad.id}" class="w-full h-full object-cover rounded-lg">
                        </a>
                    `;
                } else if (ad.imageUrl) {
                    adSlot.innerHTML = `
                        <div class="aspect-video w-full rounded-lg overflow-hidden">
                            <img src="${ad.imageUrl}" alt="广告图片 ${ad.id}" class="w-full h-full object-cover">
                        </div>
                    `;
                } else {
                    adSlot.innerHTML = `
                        <div class="aspect-video w-full bg-gradient-to-r from-space-blue/20 to-space-purple/20 rounded-lg flex items-center justify-center">
                            <p class="text-gray-500 dark:text-gray-400 text-center">广告位 ${ad.id}</p>
                        </div>
                    `;
                }
                
                // 更新编辑页的广告链接输入框
                const adLinkInput = document.getElementById(`ad${ad.id}Link`);
                if (adLinkInput) adLinkInput.value = ad.link || '';
            });
        }

        // 处理广告图片上传
        function handleAdImageUpload(adId, file) {
            if (!file) return;
            
            // 检查文件大小
            if (file.size > 3 * 1024 * 1024) {
                showNotification('图片大小不能超过3MB', 'error');
                return;
            }
            
            // 读取图片并显示
            const reader = new FileReader();
            reader.onload = (event) => {
                const adIndex = appData.ads.findIndex(a => a.id === adId);
                if (adIndex !== -1) {
                    appData.ads[adIndex] = {
                        ...appData.ads[adIndex],
                        imageUrl: event.target.result
                    };
                    
                    renderAds();
                    showNotification(`广告图片 ${adId} 已更新`, 'success');
                }
            };
            reader.readAsDataURL(file);
        }

        // 删除广告
        function deleteAd(adId) {
            const adIndex = appData.ads.findIndex(a => a.id === adId);
            if (adIndex !== -1) {
                appData.ads[adIndex] = {
                    id: adId,
                    imageUrl: '',
                    link: ''
                };
                
                renderAds();
                document.getElementById(`ad${adId}Link`).value = '';
                showNotification(`广告 ${adId} 已删除`, 'info');
            }
        }

        // 保存广告链接
        function saveAdLink(adId, link) {
            const adIndex = appData.ads.findIndex(a => a.id === adId);
            if (adIndex !== -1) {
                appData.ads[adIndex] = {
                    ...appData.ads[adIndex],
                    link: link
                };
            }
        }

        // 初始化在线时长图表
        function initOnlineTimeChart() {
            const ctx = document.getElementById('onlineTimeChart').getContext('2d');
            
            const days = appData.settings.onlineTime.map(item => item.day);
            const hours = appData.settings.onlineTime.map(item => item.hours);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: '在线小时',
                        data: hours,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + 'h';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // 计算总在线时长
            const totalHours = hours.reduce((sum, hour) => sum + hour, 0);
            document.getElementById('totalOnlineTime').textContent = totalHours.toFixed(1) + ' 小时';
        }

        // 设置滚动监听，控制小组件栏显示/隐藏
        function setupScrollListener() {
            let lastScrollTime = 0;
            let isWidgetsVisible = true;
            
            function checkScroll() {
                const now = Date.now();
                
                // 如果正在滚动，显示小组件栏
                if (now - lastScrollTime < 3000) {
                    if (!isWidgetsVisible) {
                        elements.widgetsBar.classList.remove('opacity-0', 'pointer-events-none');
                        elements.widgetsBar.classList.add('opacity-100');
                        isWidgetsVisible = true;
                    }
                } else {
                    // 如果3秒内没有滚动，隐藏小组件栏
                    if (isWidgetsVisible) {
                        elements.widgetsBar.classList.remove('opacity-100');
                        elements.widgetsBar.classList.add('opacity-0', 'pointer-events-none');
                        isWidgetsVisible = false;
                    }
                }
            }
            
            window.addEventListener('scroll', () => {
                lastScrollTime = Date.now();
                checkScroll();
            });
            
            // 初始检查
            checkScroll();
            // 设置定时器定期检查
            setInterval(checkScroll, 1000);
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = elements.notification;
            notification.textContent = '';
            notification.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center space-x-2 max-w-sm';
            
            let icon, bgColor;
            switch (type) {
                case 'success':
                    icon = 'fa-check-circle';
                    bgColor = 'bg-green-500 text-white';
                    break;
                case 'error':
                    icon = 'fa-exclamation-circle';
                    bgColor = 'bg-red-500 text-white';
                    break;
                case 'warning':
                    icon = 'fa-exclamation-triangle';
                    bgColor = 'bg-yellow-500 text-white';
                    break;
                default:
                    icon = 'fa-info-circle';
                    bgColor = 'bg-blue-500 text-white';
            }
            
            notification.classList.add(...bgColor.split(' '));
            notification.innerHTML = `
                <i class="fa ${icon}"></i>
                <span>${message}</span>
            `;
            
            // 显示通知
            setTimeout(() => {
                notification.classList.remove('translate-y-20', 'opacity-0');
            }, 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // HTML转义
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 设置事件监听
        function setupEventListeners() {
            // 主题切换
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            // 编辑页相关
            elements.editBtn.addEventListener('click', () => {
                elements.editModal.classList.remove('hidden');
            });
            
            elements.closeEditModal.addEventListener('click', () => {
                elements.editModal.classList.add('hidden');
            });
            
            elements.modalOverlay.addEventListener('click', () => {
                elements.editModal.classList.add('hidden');
            });
            
            elements.cancelEditBtn.addEventListener('click', () => {
                elements.editModal.classList.add('hidden');
            });
            
            elements.saveChangesBtn.addEventListener('click', async () => {
                // 保存广告链接
                appData.ads.forEach(ad => {
                    const linkInput = document.getElementById(`ad${ad.id}Link`);
                    if (linkInput) {
                        saveAdLink(ad.id, linkInput.value.trim());
                    }
                });
                
                // 保存到GitHub
                const saved = await saveDataToGitHub();
                if (saved) {
                    elements.editModal.classList.add('hidden');
                    renderAds();
                }
            });
            
            // 添加书签相关
            elements.addBookmarkBtn.addEventListener('click', () => {
                // 清空表单
                document.getElementById('newBookmarkTitle').value = '';
                document.getElementById('newBookmarkUrl').value = '';
                document.getElementById('newBookmarkGroup').value = '';
                
                elements.addBookmarkModal.classList.remove('hidden');
            });
            
            elements.addBookmarkOverlay.addEventListener('click', () => {
                elements.addBookmarkModal.classList.add('hidden');
            });
            
            elements.cancelAddBookmarkBtn.addEventListener('click', () => {
                elements.addBookmarkModal.classList.add('hidden');
            });
            
            elements.confirmAddBookmarkBtn.addEventListener('click', () => {
                const title = document.getElementById('newBookmarkTitle').value.trim();
                const url = document.getElementById('newBookmarkUrl').value.trim();
                const group = document.getElementById('newBookmarkGroup').value.trim();
                
                if (!url) {
                    showNotification('请输入网站URL', 'error');
                    return;
                }
                
                // 确保URL以http://或https://开头
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                
                addBookmark(title, url, group);
                elements.addBookmarkModal.classList.add('hidden');
            });
            
            // 书签导入导出
            elements.importBookmarkBtn.addEventListener('click', importBookmarks);
            elements.exportBookmarkBtn.addEventListener('click', exportBookmarks);
            elements.backupJSONBtn.addEventListener('click', backupJSON);
            elements.loadJSONBtn.addEventListener('click', loadJSON);
            
            // 世界时间相关
            elements.addTimezoneBtn.addEventListener('click', () => {
                // 清空表单
                document.getElementById('newTimezoneCity').value = '';
                document.getElementById('newTimezoneOffset').value = '';
                
                elements.addTimezoneModal.classList.remove('hidden');
            });
            
            elements.addTimezone.addEventListener('click', () => {
                // 清空表单
                document.getElementById('newTimezoneCity').value = '';
                document.getElementById('newTimezoneOffset').value = '';
                
                elements.addTimezoneModal.classList.remove('hidden');
            });
            
            elements.addTimezoneOverlay.addEventListener('click', () => {
                elements.addTimezoneModal.classList.add('hidden');
            });
            
            elements.cancelAddTimezoneBtn.addEventListener('click', () => {
                elements.addTimezoneModal.classList.add('hidden');
            });
            
            elements.confirmAddTimezoneBtn.addEventListener('click', () => {
                const city = document.getElementById('newTimezoneCity').value.trim();
                const offset = document.getElementById('newTimezoneOffset').value.trim();
                
                addTimezone(city, offset);
                elements.addTimezoneModal.classList.add('hidden');
            });
            
            // 广告图片上传
            document.getElementById('ad1Image').addEventListener('change', (e) => {
                handleAdImageUpload('1', e.target.files[0]);
            });
            
            document.getElementById('ad2Image').addEventListener('change', (e) => {
                handleAdImageUpload('2', e.target.files[0]);
            });
            
            document.getElementById('ad3Image').addEventListener('change', (e) => {
                handleAdImageUpload('3', e.target.files[0]);
            });
            
            // 广告删除按钮
            document.querySelectorAll('.deleteAdBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const adId = e.currentTarget.dataset.ad;
                    deleteAd(adId);
                });
            });
            
            // GitHub配置变更时重新加载数据
            elements.githubUsername.addEventListener('change', loadDataFromGitHub);
            elements.githubRepo.addEventListener('change', loadDataFromGitHub);
            elements.githubToken.addEventListener('change', loadDataFromGitHub);
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
