<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookmark Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4 max-w-4xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Bookmark Manager</h1>
            <button id="config-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                <i class="fa fa-cog mr-1"></i> Settings
            </button>
        </div>

        <!-- 配置面板 -->
        <div id="config-panel" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Repository Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">Default GitHub Repository (owner/repo)</label>
                    <input type="text" id="default-repo-input" 
                           class="w-full p-2 border border-gray-300 rounded"
                           placeholder="your-username/your-repo">
                    <p class="text-xs text-gray-500 mt-1">Automatically detected from current GitHub Pages URL</p>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">File Path</label>
                    <input type="text" id="file-path-input" 
                           class="w-full p-2 border border-gray-300 rounded"
                           value="bookmarks.json">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Your GitHub Token (optional, for private repos)</label>
                    <input type="text" id="github-token-input" 
                           class="w-full p-2 border border-gray-300 rounded"
                           placeholder="ghp_...">
                </div>
                <button id="save-config" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Save Settings
                </button>
            </div>
        </div>

        <div id="bookmarks-container" class="space-y-4"></div>
        <div id="loading" class="py-8 text-center text-gray-500">
            <i class="fa fa-spinner fa-spin mr-2"></i> Loading bookmarks...
        </div>
        <div id="error" class="py-8 text-center text-red-500 hidden"></div>
    </div>

    <script>
        // 从URL自动检测GitHub仓库信息 (owner/repo)
        function detectGitHubRepoFromUrl() {
            try {
                const currentUrl = window.location.href;
                const url = new URL(currentUrl);
                
                // GitHub Pages的URL格式通常是:
                // 1. https://<username>.github.io/<repo>/
                // 2. https://<org>.github.io/<repo>/
                if (url.hostname.endsWith('.github.io')) {
                    const parts = url.hostname.split('.');
                    const owner = parts[0]; // 提取用户名/组织名
                    
                    // 提取仓库名（从路径中）
                    const pathParts = url.pathname.split('/').filter(part => part.trim() !== '');
                    const repo = pathParts.length > 0 ? pathParts[0] : '';
                    
                    if (owner && repo) {
                        return `${owner}/${repo}`;
                    }
                }
                return ''; // 不是GitHub Pages或无法解析
            } catch (e) {
                console.error('Failed to detect GitHub repo from URL:', e);
                return '';
            }
        }

        // 从本地存储加载配置，没有则使用初始默认值
        function loadConfig() {
            const savedConfig = localStorage.getItem('bookmarkConfig');
            if (savedConfig) {
                return JSON.parse(savedConfig);
            }
            
            // 初始默认配置 - 自动检测当前仓库
            return {
                githubRepo: detectGitHubRepoFromUrl(),
                filePath: 'bookmarks.json',
                githubToken: ''
            };
        }

        // 保存配置到本地存储
        function saveConfig(config) {
            localStorage.setItem('bookmarkConfig', JSON.stringify(config));
        }

        // 应用级默认仓库 - 当所有检测都失败时使用
        const FALLBACK_REPO = {
            githubRepo: 'example/public-bookmarks', // 备用公开仓库
            filePath: 'bookmarks.json'
        };

        // 加载并显示配置
        function initConfigPanel() {
            const config = loadConfig();
            const detectedRepo = detectGitHubRepoFromUrl();
            
            // 显示自动检测到的仓库，除非用户已保存了自己的配置
            const repoToShow = config.githubRepo || detectedRepo;
            
            document.getElementById('default-repo-input').value = repoToShow || '';
            document.getElementById('file-path-input').value = config.filePath || 'bookmarks.json';
            document.getElementById('github-token-input').value = config.githubToken || '';
        }

        // 确定最终使用的仓库信息
        function getFinalConfig() {
            const userConfig = loadConfig();
            const detectedRepo = detectGitHubRepoFromUrl();
            
            // 优先级: 用户保存的配置 > 自动检测的仓库 > 备用仓库
            return {
                githubRepo: userConfig.githubRepo || detectedRepo || FALLBACK_REPO.githubRepo,
                filePath: userConfig.filePath || FALLBACK_REPO.filePath,
                githubToken: userConfig.githubToken || ''
            };
        }

        // 加载GitHub仓库中的书签数据
        async function loadBookmarks() {
            try {
                const config = getFinalConfig();
                const [owner, repo] = config.githubRepo.split('/');
                
                if (!owner || !repo) {
                    throw new Error('Invalid repository format (expected "owner/repo")');
                }

                // 构建GitHub API请求URL
                const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${config.filePath}`;
                
                // 配置请求头
                const headers = {
                    'Accept': 'application/vnd.github.v3.raw'
                };
                if (config.githubToken) {
                    headers['Authorization'] = `token ${config.githubToken}`;
                }

                // 发起请求
                const response = await fetch(apiUrl, { headers });
                
                if (!response.ok) {
                    throw new Error(`Failed to load: ${response.statusText}`);
                }

                const bookmarks = await response.json();
                renderBookmarks(bookmarks);
            } catch (err) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').textContent = `Error: ${err.message}`;
                document.getElementById('error').classList.remove('hidden');
            }
        }

        // 渲染书签列表
        function renderBookmarks(bookmarks) {
            const container = document.getElementById('bookmarks-container');
            container.innerHTML = bookmarks.map(bookmark => `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                    <h3 class="font-semibold text-lg">
                        <a href="${bookmark.url}" target="_blank" class="text-blue-600 hover:underline">
                            ${bookmark.title}
                        </a>
                    </h3>
                    <p class="text-gray-500 text-sm mt-1">${bookmark.description || ''}</p>
                </div>
            `).join('');
            
            document.getElementById('loading').classList.add('hidden');
        }

        // 事件监听
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化配置面板
            initConfigPanel();
            
            // 加载书签
            loadBookmarks();
            
            // 配置按钮点击事件
            document.getElementById('config-btn').addEventListener('click', () => {
                const panel = document.getElementById('config-panel');
                panel.classList.toggle('hidden');
            });
            
            // 保存配置
            document.getElementById('save-config').addEventListener('click', () => {
                const newConfig = {
                    githubRepo: document.getElementById('default-repo-input').value.trim(),
                    filePath: document.getElementById('file-path-input').value.trim() || 'bookmarks.json',
                    githubToken: document.getElementById('github-token-input').value.trim()
                };
                
                saveConfig(newConfig);
                
                // 重新加载书签
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('bookmarks-container').innerHTML = '';
                document.getElementById('error').classList.add('hidden');
                loadBookmarks();
                
                // 隐藏配置面板
                document.getElementById('config-panel').classList.add('hidden');
            });
        });
    </script>
</body>
</html>
    