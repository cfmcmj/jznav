<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能书签管理器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-3xl mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">书签管理器</h1>
            <p class="text-gray-600">自动识别仓库，无需手动配置</p>
        </header>

        <!-- 状态与配置区 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div id="detection-status" class="flex items-center justify-center py-6">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-3"></div>
                    <p class="text-gray-600">正在自动识别仓库信息...</p>
                </div>
            </div>

            <!-- 手动配置选项 (默认隐藏) -->
            <div id="manual-config" class="hidden space-y-4 mt-4">
                <div>
                    <label for="repo-path" class="block text-sm font-medium text-gray-700 mb-1">
                        GitHub仓库路径
                    </label>
                    <input 
                        type="text" 
                        id="repo-path" 
                        placeholder="用户名/仓库名" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>
                <div>
                    <label for="bookmark-file" class="block text-sm font-medium text-gray-700 mb-1">
                        书签文件路径
                    </label>
                    <input 
                        type="text" 
                        id="bookmark-file" 
                        value="bookmarks.json" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>
                <button 
                    onclick="confirmManualConfig()" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors"
                >
                    确认配置并加载
                </button>
            </div>
        </div>

        <!-- 书签容器 -->
        <div class="bg-white rounded-xl shadow-md p-6 min-h-[300px]" id="bookmarks-container">
            <div class="flex items-center justify-center h-40 text-gray-400">
                <i class="fa fa-bookmark-o text-5xl"></i>
            </div>
        </div>
    </div>

    <script>
        // 页面加载时启动自动检测流程
        document.addEventListener('DOMContentLoaded', () => {
            // 先检查本地是否已有缓存的仓库信息
            const cachedRepo = localStorage.getItem('autoDetectedRepo');
            if (cachedRepo) {
                const { owner, repo, filePath } = JSON.parse(cachedRepo);
                document.getElementById('detection-status').innerHTML = `
                    <p class="text-green-600"><i class="fa fa-check-circle mr-2"></i>已找到缓存的仓库信息</p>
                `;
                loadBookmarks(owner, repo, filePath);
                return;
            }
            
            // 启动自动检测流程
            startAutoDetection();
        });

        /**
         * 启动自动检测流程
         * 自定义域名下通过CNAME记录反向查询关联仓库
         */
        async function startAutoDetection() {
            try {
                // 步骤1: 获取当前域名
                const currentDomain = window.location.hostname;
                updateStatus(`正在识别域名: ${currentDomain}`);

                // 步骤2: 尝试通过GitHub API搜索包含此域名的CNAME文件
                updateStatus(`正在查找关联的GitHub仓库...`);
                const repoInfo = await findRepoByCNAME(currentDomain);
                
                if (repoInfo) {
                    const { owner, repo } = repoInfo;
                    const filePath = 'bookmarks.json'; // 默认文件路径
                    
                    // 保存到本地缓存
                    localStorage.setItem('autoDetectedRepo', JSON.stringify({
                        owner, repo, filePath,
                        detectedAt: new Date().toISOString()
                    }));
                    
                    updateStatus(`成功找到关联仓库: ${owner}/${repo}`);
                    loadBookmarks(owner, repo, filePath);
                    return;
                }
                
                // 步骤3: 如果API搜索失败，尝试其他备选方案
                updateStatus(`未直接找到关联仓库，尝试其他方式...`);
                
                // 备选方案1: 检查常见的书签仓库命名模式
                const commonRepos = [
                    `${getPossibleOwner()}/bookmarks`,
                    `${getPossibleOwner()}/my-bookmarks`,
                    `${getPossibleOwner()}/web-bookmarks`
                ];
                
                for (const repoPath of commonRepos) {
                    const [owner, repo] = repoPath.split('/');
                    if (await verifyRepoExists(owner, repo)) {
                        updateStatus(`找到可能的仓库: ${owner}/${repo}`);
                        loadBookmarks(owner, repo, 'bookmarks.json');
                        return;
                    }
                }
                
                // 所有自动方法都失败，显示手动配置选项
                showManualConfig(`无法自动识别仓库信息，请手动输入`);
                
            } catch (error) {
                console.error('自动检测失败:', error);
                showManualConfig(`自动识别失败: ${error.message}`);
            }
        }

        /**
         * 通过CNAME记录查找关联的GitHub仓库
         * 这是自定义域名下最可靠的自动关联方法
         */
        async function findRepoByCNAME(domain) {
            try {
                // GitHub API搜索包含特定CNAME内容的文件
                // 注意: 此API有速率限制，每小时60次
                const encodedDomain = encodeURIComponent(domain);
                const searchUrl = `https://api.github.com/search/code?q=filename:cname+${encodedDomain}+in:path`;
                
                const response = await fetch(searchUrl);
                
                if (!response.ok) {
                    // API调用失败，不抛出错误，尝试其他方法
                    return null;
                }
                
                const data = await response.json();
                
                // 查找最可能的仓库（通常是第一个结果）
                if (data.items && data.items.length > 0) {
                    const firstMatch = data.items[0];
                    return {
                        owner: firstMatch.repository.owner.login,
                        repo: firstMatch.repository.name
                    };
                }
                
                return null;
            } catch (e) {
                console.log('CNAME搜索失败:', e.message);
                return null;
            }
        }

        /**
         * 验证仓库是否存在
         */
        async function verifyRepoExists(owner, repo) {
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`);
                return response.ok;
            } catch (e) {
                return false;
            }
        }

        /**
         * 获取可能的仓库所有者（基于常见命名模式）
         */
        function getPossibleOwner() {
            // 从域名中提取可能的用户名
            const domainParts = window.location.hostname.split('.');
            // 取主域名作为可能的用户名
            return domainParts.length > 1 ? domainParts[0] : domainParts[0];
        }

        /**
         * 更新状态信息
         */
        function updateStatus(message) {
            const statusElement = document.getElementById('detection-status');
            statusElement.innerHTML = `
                <p class="text-gray-600"><i class="fa fa-info-circle mr-2"></i>${message}</p>
            `;
        }

        /**
         * 显示手动配置选项
         */
        function showManualConfig(message) {
            const statusElement = document.getElementById('detection-status');
            statusElement.innerHTML = `
                <p class="text-amber-600"><i class="fa fa-exclamation-circle mr-2"></i>${message}</p>
            `;
            document.getElementById('manual-config').classList.remove('hidden');
        }

        /**
         * 确认手动配置
         */
        function confirmManualConfig() {
            const repoPath = document.getElementById('repo-path').value.trim();
            const filePath = document.getElementById('bookmark-file').value.trim();
            
            if (!repoPath || !repoPath.includes('/')) {
                alert('请输入正确的仓库路径，格式为：用户名/仓库名');
                return;
            }
            
            const [owner, repo] = repoPath.split('/');
            updateStatus(`正在验证仓库: ${owner}/${repo}`);
            
            // 验证并加载
            verifyRepoExists(owner, repo)
                .then(exists => {
                    if (exists) {
                        // 保存到本地缓存
                        localStorage.setItem('autoDetectedRepo', JSON.stringify({
                            owner, repo, filePath,
                            detectedAt: new Date().toISOString()
                        }));
                        loadBookmarks(owner, repo, filePath);
                    } else {
                        showManualConfig(`仓库不存在，请检查信息`);
                    }
                });
        }

        /**
         * 加载书签数据
         */
        async function loadBookmarks(owner, repo, filePath) {
            const container = document.getElementById('bookmarks-container');
            container.innerHTML = `
                <div class="flex items-center justify-center h-40">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-2"></div>
                        <p class="text-gray-600">正在加载书签...</p>
                    </div>
                </div>
            `;

            try {
                const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`无法加载文件 (${response.status})`);
                }
                
                const data = await response.json();
                
                // 解码并解析书签
                if (data.content) {
                    const safeContent = data.content.replace(/-/g, '+').replace(/_/g, '/');
                    const padLength = (4 - (safeContent.length % 4)) % 4;
                    const paddedContent = safeContent + '='.repeat(padLength);
                    
                    const decodedArray = Uint8Array.from(atob(paddedContent), c => c.charCodeAt(0));
                    const decoder = new TextDecoder('utf-8');
                    const decodedContent = decoder.decode(decodedArray);
                    
                    const bookmarks = JSON.parse(decodedContent);
                    renderBookmarks(bookmarks);
                } else {
                    throw new Error('书签文件为空');
                }
            } catch (error) {
                console.error('加载书签失败:', error);
                container.innerHTML = `
                    <div class="text-center py-10">
                        <i class="fa fa-exclamation-triangle text-amber-500 text-3xl mb-3"></i>
                        <p class="text-gray-600 mb-2">加载书签失败</p>
                        <p class="text-sm text-gray-500">${error.message}</p>
                        <button 
                            onclick="document.getElementById('manual-config').classList.remove('hidden')"
                            class="mt-4 text-blue-600 hover:text-blue-800 text-sm"
                        >
                            重新配置仓库
                        </button>
                    </div>
                `;
            }
        }

        /**
         * 渲染书签
         */
        function renderBookmarks(bookmarksData) {
            const container = document.getElementById('bookmarks-container');
            container.innerHTML = '';
            
            if (!bookmarksData || !bookmarksData.bookmarks || bookmarksData.bookmarks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10">
                        <i class="fa fa-folder-open-o text-gray-300 text-3xl mb-3"></i>
                        <p class="text-gray-500">未找到书签数据</p>
                    </div>
                `;
                return;
            }
            
            const bookmarksList = document.createElement('div');
            bookmarksList.className = 'space-y-4';
            
            bookmarksData.bookmarks.forEach(folder => {
                const folderDiv = document.createElement('div');
                folderDiv.className = 'border border-gray-100 rounded-lg overflow-hidden';
                
                const folderHeader = document.createElement('div');
                folderHeader.className = 'bg-gray-50 px-4 py-2 font-medium flex items-center justify-between cursor-pointer';
                folderHeader.innerHTML = `
                    <span><i class="fa fa-folder text-yellow-500 mr-2"></i>${folder.name || '未命名文件夹'}</span>
                    <i class="fa fa-chevron-down text-xs text-gray-500 transition-transform duration-200"></i>
                `;
                
                const folderContent = document.createElement('div');
                folderContent.className = 'px-4 py-3 hidden';
                
                if (folder.bookmarks && folder.bookmarks.length > 0) {
                    const linksList = document.createElement('ul');
                    linksList.className = 'space-y-2';
                    
                    folder.bookmarks.forEach(bookmark => {
                        const linkItem = document.createElement('li');
                        linkItem.className = 'flex items-center';
                        linkItem.innerHTML = `
                            <i class="fa fa-bookmark text-blue-500 mr-2"></i>
                            <a href="${bookmark.url}" target="_blank" class="text-blue-600 hover:underline">
                                ${bookmark.title || bookmark.url}
                            </a>
                        `;
                        linksList.appendChild(linkItem);
                    });
                    
                    folderContent.appendChild(linksList);
                } else {
                    folderContent.innerHTML = '<div class="text-gray-500 italic text-sm">空文件夹</div>';
                }
                
                // 点击展开/折叠
                folderHeader.addEventListener('click', () => {
                    folderContent.classList.toggle('hidden');
                    folderHeader.querySelector('.fa-chevron-down').classList.toggle('rotate-180');
                });
                
                folderDiv.appendChild(folderHeader);
                folderDiv.appendChild(folderContent);
                bookmarksList.appendChild(folderDiv);
            });
            
            container.appendChild(bookmarksList);
        }
    </script>
</body>
</html>
