<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>星际导航 | Space Navigator</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%231a202c'/%3E%3Ccircle cx='50' cy='50' r='25' fill='%233182ce'/%3E%3Ccircle cx='35' cy='40' r='5' fill='white'/%3E%3Ccircle cx='65' cy='40' r='3' fill='white'/%3E%3Ccircle cx='45' cy='60' r='4' fill='white'/%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        space: {
                            dark: '#0b0e1a',
                            darker: '#070912',
                            light: '#161b30',
                            accent: '#3b82f6',
                            glow: '#60a5fa',
                            nebula: '#7c3aed',
                            star: '#fcd34d'
                        }
                    },
                    fontFamily: {
                        space: ['Orbitron', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .star {
                position: absolute;
                background-color: white;
                border-radius: 50%;
                animation: twinkle 2s infinite ease-in-out;
            }
            @keyframes twinkle {
                0%, 100% { opacity: 0.5; }
                50% { opacity: 1; }
            }
            .widget-card {
                @apply bg-space-light/40 backdrop-blur-md rounded-xl border border-space-accent/20 overflow-hidden transition-all duration-300 hover:border-space-accent/50 hover:shadow-lg hover:shadow-space-accent/10;
            }
            .widget-header {
                @apply px-4 py-3 border-b border-space-accent/20 flex justify-between items-center;
            }
            .widget-title {
                @apply font-medium text-space-glow flex items-center;
            }
            .search-suggestion {
                @apply px-4 py-2 hover:bg-space-light/50 cursor-pointer transition-colors text-sm;
            }
            .search-suggestion-active {
                @apply bg-space-light/50;
            }
            .search-result-highlight {
                @apply bg-space-accent/30 px-1 rounded;
            }
            /* 移动端触摸优化 */
            .touch-target {
                @apply min-h-[44px] min-w-[44px] flex items-center justify-center;
            }
            /* 搜索容器样式 - 修复按钮移位问题 */
            .search-container {
                @apply relative;
            }
            .search-input {
                @apply w-full bg-space-darker border border-space-accent/30 rounded-lg px-4 py-3 pr-10 focus:outline-none focus:border-space-accent transition-colors text-base;
            }
            .search-button {
                @apply absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-space-accent touch-target;
            }
        }
    </style>
</head>
<body class="bg-space-dark text-white min-h-screen relative overflow-x-hidden transition-colors duration-300">
    <div id="stars" class="fixed inset-0 z-0"></div>
    
    <header id="header" class="fixed top-0 left-0 right-0 z-40 transition-all duration-500 bg-space-dark/80 backdrop-blur-md border-b border-space-accent/20">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg width="24" height="24" viewBox="0 0 100 100" class="text-space-accent">
                    <circle cx="50" cy="50" r="45" fill="#0b0e1a"/>
                    <circle cx="50" cy="50" r="25" fill="#3b82f6"/>
                    <circle cx="35" cy="40" r="5" fill="white"/>
                    <circle cx="65" cy="40" r="3" fill="white"/>
                    <circle cx="45" cy="60" r="4" fill="white"/>
                </svg>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-space-accent to-space-nebula">星际                    星际导航
                </h1>
            </div>
            
            <div class="flex items-center space-x-2">
                <button id="settings-btn" class="touch-target p-2 rounded-full hover:bg-space-light/30 transition-colors">
                    <i class="fa fa-cog text-space-accent"></i>
                </button>
                <button id="theme-toggle" class="touch-target p-2 rounded-full hover:bg-space-light/30 transition-colors">
                    <i class="fa fa-moon-o text-space-accent"></i>
                </button>
            </div>
        </div>
    </header>
    
    <main class="container mx-auto px-4 pt-24 pb-16 relative z-10">
        <!-- 时间和搜索 - 移动端优化布局 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 widget-card">
                <div class="p-6">
                    <div id="time-display" class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-space-accent to-space-nebula mb-2">
                        00:00:00
                    </div>
                    <div id="date-display" class="text-center text-gray-400">
                        2023年1月1日 星期日
                    </div>
                </div>
            </div>
            
            <div class="widget-card">
                <div class="p-4">
                    <!-- 仅保留留站内                <div class="relative search-container">
                        <div class="flex border-b border-space-accent/30 mb-2">
                            <button id="search-type-site" class="flex-1 py-1 text-sm font-medium text-space-glow border-b-2 border-space-accent">站内搜索</button>
                        </div>
                        
                        <input type="text" id="search-input" placeholder="搜索书签..." class="search-input">
                        <button id="search-btn" class="search-button">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- 搜索结果容器 -->
                    <div id="search-results-container" class="mt-3 hidden">
                        <div class="flex justify-between items-center text-sm mb-2">
                            <span id="search-results-count" class="text-space-glow"></span>
                            <button id="clear-search" class="text-gray-400 hover:text-white touch-target">
                                <i class="fa fa-times-circle"></i> 清除
                            </button>
                        </div>
                        <div id="search-results" class="max-h-80 overflow-y-auto scrollbar-hide space-y-2">
                            <!-- 搜索结果将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 搜索建议下拉框 -->
                    <div id="search-suggestions" class="absolute left-0 right-0 mt-1 bg-space-light border border-space-accent/30 rounded-lg shadow-xl z-20 hidden max-h-60 overflow-y-auto scrollbar-hide">
                        <!-- 搜索建议将通过JS动态生成 -->
                    </div>
                    
                    <!-- 搜索历史 -->
                    <div id="search-history" class="mt-3 hidden">
                        <div class="flex justify-between items-center text-xs text-gray-500 mb-1">
                            <span>搜索历史</span>
                            <button id="clear-history" class="hover:text-space-accent">清除</button>
                        </div>
                        <div id="history-list" class="flex flex-wrap gap-2">
                            <!-- 搜索历史将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 时区和使用统计 - 移动端堆叠布局 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="widget-card">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fa fa-globe mr-2"></i>世界时钟
                    </h3>
                </div>
                <div id="timezones-container" class="p-4 grid grid-cols-2 gap-4">
                    <!-- 时区将通过JS动态生成 -->
                </div>
            </div>
            
            <div class="widget-card">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fa fa-line-chart mr-2"></i>使用统计
                    </h3>
                </div>
                <!-- 修复统计标签窗口无限延伸问题：添加max-h和overflow-hidden -->
                <div class="p-4 max-h-[400px] overflow-hidden">
                    <canvas id="usage-chart" height="180"></canvas>
                    <div class="mt-4 text-center text-sm text-gray-400">
                        <p>已运行: <span id="uptime-display">0天0小时0分钟</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 广告位 1 - 响应式尺寸 -->
        <div class="my-8 rounded-xl overflow-hidden border border-space-accent/30 relative group widget-card">
            <div class="ad-container aspect-video bg-space-light/30 flex items-center justify-center overflow-hidden">
                <img id="ad1-img" src="https://picsum.photos/1200/400?random=1" alt="广告图片1" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                <a id="ad1-link" href="#" target="_blank" class="absolute inset-0"></a>
            </div>
        </div>
        
        <!-- 书签分类和内容 - 移动端自适应网格 -->
        <div id="bookmarks-container" class="space-y-6">
            <!-- 书签分组将通过JS动态生成 -->
        </div>
        
        <!-- 广告位 2 -->
        <div class="my-8 rounded-xl overflow-hidden border border-space-accent/30 relative group widget-card">
            <div class="ad-container aspect-[21/9] bg-space-light/30 flex items-center justify-center overflow-hidden">
                <img id="ad2-img" src="https://picsum.photos/1200/400?random=2" alt="广告图片2" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                <a id="ad2-link" href="#" target="_blank" class="absolute inset-0"></a>
            </div>
        </div>
        
        <!-- 广告位 3 -->
        <div class="my-8 rounded-xl overflow-hidden border border-space-accent/30 relative group widget-card">
            <div class="ad-container aspect-[21/9] bg-space-light/30 flex items-center justify-center overflow-hidden">
                <img id="ad3-img" src="https://picsum.photos/1200/400?random=3" alt="广告图片3" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                <a id="ad3-link" href="#" target="_blank" class="absolute inset-0"></a>
            </div>
        </div>
    </main>
    
    <!-- 底部信息 -->
    <footer class="bg-space-dark/80 backdrop-blur-md py-4 border-t border-space-accent/20 relative z-10">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>共收录<span id="total-bookmarks">0</span>个网站</div>
                <div class="mt-2 md:mt-0">Copyright © 2018-<span id="current-year"></span> <span id="hostname">SpaceNavigator</span>, All Rights Reserved</div>
            </div>
        </div>
    </footer>
    
    <!-- 设置对话框 - 移动端适配 -->
    <div id="settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-space-light rounded-xl w-full max-w-md p-6 border border-space-accent/30 relative mx-4">
            <button id="close-settings" class="absolute top-4 right-4 text-gray-400 hover:text-white touch-target">
                <i class="fa fa-times"></i>
            </button>
            <h2 class="text-xl font-bold mb-4 text-center">GitHub 配置</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-300 mb-1">仓库 (username/repo-name)</label>
                    <input type="text" id="github-repo" placeholder="username/repo-name" class="w-full bg-space-dark border border-space-accent/50 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-space-accent" readonly>
                </div>
                <div>
                    <label class="block text-sm text-gray-300 mb-1">个人访问令牌 (Token)</label>
                    <input type="password" id="github-token" placeholder="ghp_..." class="w-full bg-space-dark border border-space-accent/50 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-space-accent">
                    <p class="text-xs text-gray-500 mt-1">需要 repo 权限，用于读写书签数据</p>
                </div>
                <button id="authenticate-btn" class="w-full bg-gradient-to-r from-space-accent to-space-nebula py-3 rounded-lg hover:opacity-90 transition-opacity font-medium">
                    验证并进入编辑模式
                </button>
                <p class="text-xs text-center text-gray-500">未配置时将使用默认公开仓库</p>
            </div>
        </div>
    </div>
    
    <!-- 编辑页 - 移动端滚动优化 -->
    <div id="editor-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-space-light rounded-xl w-full max-w-5xl max-h-[90vh] overflow-hidden border border-space-accent/30 flex flex-col">
                <div class="p-4 border-b border-space-accent/20 flex justify-between items-center">
                    <h2 class="text-xl font-bold">书签编辑中心</h2>
                    <div class="flex space-x-2">
                        <button id="import-bookmarks" class="px-3 py-2 text-sm bg-space-dark rounded hover:bg-space-darker transition-colors touch-target">
                            <i class="fa fa-upload mr-1"></i>导入
                        </button>
                        <button id="export-bookmarks" class="px-3 py-2 text-sm bg-space-dark rounded hover:bg-space-darker transition-colors touch-target">
                            <i class="fa fa-download mr-1"></i>导出
                        </button>
                        <button id="close-editor" class="touch-target p-2 text-gray-400 hover:text-white">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex flex-1 overflow-hidden flex-col md:flex-row">
                    <!-- 书签编辑区 - 移动端优先显示 -->
                    <div class="flex-1 overflow-y-auto p-4">
                        <h3 class="text-lg font-semibold mb-3">书签管理</h3>
                        <div class="mb-4">
                            <button id="add-bookmark-group" class="px-4 py-2 bg-space-accent/20 hover:bg-space-accent/30 rounded-lg transition-colors text-sm touch-target">
                                <i class="fa fa-folder-open-o mr-1"></i>添加书签组
                            </button>
                        </div>
                        <div id="bookmarks-editor-container" class="space-y-6">
                            <!-- 编辑区书签内容将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 广告和时区编辑区 - 移动端可滚动 -->
                    <div class="w-full md:w-80 border-t md:border-t-0 md:border-l border-space-accent/20 p-4 overflow-y-auto">
                        <h3 class="text-lg font-semibold mb-3">广告管理</h3>
                        <div class="space-y-6">
                            <!-- 广告1编辑 -->
                            <div class="bg-space-dark/50 rounded-lg p-3">
                                <h4 class="text-sm font-medium mb-2">广告位 1</h4>
                                <div class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">图片URL</label>
                                        <input type="text" id="ad1-url-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">链接URL</label>
                                        <input type="text" id="ad1-link-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">上传图片</label>
                                        <input type="file" id="ad1-upload" accept="image/*" class="w-full text-xs text-gray-400">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 广告2编辑 -->
                            <div class="bg-space-dark/50 rounded-lg p-3">
                                <h4 class="text-sm font-medium mb-2">广告位 2</h4>
                                <div class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">图片URL</label>
                                        <input type="text" id="ad2-url-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">链接URL</label>
                                        <input type="text" id="ad2-link-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">上传图片</label>
                                        <input type="file" id="ad2-upload" accept="image/*" class="w-full text-xs text-gray-400">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 广告3编辑 -->
                            <div class="bg-space-dark/50 rounded-lg p-3">
                                <h4 class="text-sm font-medium mb-2">广告位 3</h4>
                                <div class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">图片URL</label>
                                        <input type="text" id="ad3-url-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">链接URL</label>
                                        <input type="text" id="ad3-link-input" class="w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-white focus:outline-none focus:border-space-accent">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">上传图片</label>
                                        <input type="file" id="ad3-upload" accept="image/*" class="w-full text-xs text-gray-400">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 时区编辑区 - 仅在编辑中心显示 -->
                        <h3 class="text-lg font-semibold mb-3 mt-8">时区管理</h3>
                        <div class="space-y-4">
                            <div class="flex">
                                <select id="new-timezone" class="flex-1 bg-space-dark border border-space-accent/50 rounded-l-lg px-3 py-2 text-white focus:outline-none focus:ring-1 focus:ring-space-accent">
                                    <option value="">选择城市...</option>
                                    <option value="Asia/Shanghai">北京 (Asia/Shanghai)</option>
                                    <option value="America/New_York">纽约 (America/New_York)</option>
                                    <option value="Europe/London">伦敦 (Europe/London)</option>
                                    <option value="Asia/Tokyo">东京 (Asia/Tokyo)</option>
                                    <option value="Asia/Singapore">新加坡 (Asia/Singapore)</option>
                                    <option value="Australia/Sydney">悉尼 (Australia/Sydney)</option>
                                    <option value="Europe/Paris">巴黎 (Europe/Paris)</option>
                                    <option value="America/Los_Angeles">洛杉矶 (America/Los_Angeles)</option>
                                </select>
                                <button id="add-timezone-btn" class="bg-space-accent px-4 py-2 rounded-r-lg hover:bg-space-accent/80 transition-colors touch-target">
                                    添加
                                </button>
                            </div>
                            <div id="timezones-list" class="space-y-2 max-h-60 overflow-y-auto scrollbar-hide">
                                <!-- 时区列表将通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-space-accent/20 flex justify-between items-center">
                    <div>
                        <span id="bookmark-count-display" class="text-sm text-gray-400">共 0 个书签</span>
                    </div>
                    <button id="save-changes" class="px-6 py-3 bg-gradient-to-r from-space-accent to-space-nebula rounded-lg hover:opacity-90 transition-opacity font-medium touch-target">
                        保存更改
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 确认对话框 - 移动端适配 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-space-light rounded-xl w-full max-w-md p-6 border border-space-accent/30 mx-4">
            <h3 class="text-lg font-bold mb-2" id="confirm-title">确认操作</h3>
            <p class="text-gray-300 mb-4" id="confirm-message">您确定要执行此操作吗？</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-confirm" class="px-4 py-2 bg-space-dark border border-gray-700 rounded-lg hover:bg-space-darker transition-colors touch-target">
                    取消
                </button>
                <button id="confirm-action" class="px-4 py-2 bg-red-600/80 rounded-lg hover:bg-red-600 transition-colors touch-target">
                    确认
                </button>
            </div>
        </div>
    </div>
    
    <!-- 通知提示 - 移动端适配 -->
    <div id="notification" class="fixed bottom-4 right-4 bg-space-light border border-space-accent/30 rounded-lg p-4 shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 max-w-xs">
        <div class="flex items-start">
            <div id="notification-icon" class="mr-3 text-xl">
                <i class="fa fa-info-circle text-space-accent"></i>
            </div>
            <div class="flex-1">
                <h4 id="notification-title" class="font-medium text-white"></h4>
                <p id="notification-message" class="text-sm text-gray-300 mt-1"></p>
            </div>
            <button id="close-notification" class="ml-2 text-gray-400 hover:text-white touch-target">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- 搜索设置对话框 -->
    <div id="search-settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-space-light rounded-xl w-full max-w-md p-6 border border-space-accent/30 mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">搜索设置</h3>
                <button id="close-search-settings" class="text-gray-400 hover:text-white touch-target">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="save-search-history" class="form-checkbox h-4 w-4 text-space-accent bg-space-dark border-gray-700 rounded">
                        <span class="ml-2 text-sm">保存搜索历史</span>
                    </label>
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="show-search-suggestions" class="form-checkbox h-4 w-4 text-space-accent bg-space-dark border-gray-700 rounded">
                        <span class="ml-2 text-sm">显示搜索建议</span>
                    </label>
                </div>
                <button id="save-search-settings" class="w-full bg-gradient-to-r from-space-accent to-space-nebula py-2 rounded-lg hover:opacity-90 transition-opacity font-medium">
                    保存设置
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 由GitHub Actions自动注入的仓库信息（部署时替换）
        const DEFAULT_REPO = "your-username/your-repo"; // 占位符，Actions会替换
        const DEFAULT_RAW_URL = `https://raw.githubusercontent.com/${DEFAULT_REPO}/main/bookmarks.json`;
        const DEPLOY_DATE = new Date("2023-01-01"); // 初始部署日期，可根据实际情况修改
        
        // 全局数据存储
        const appData = {
            bookmarks: [],
            ads: [
                { imgUrl: "https://picsum.photos/1200/400?random=1", linkUrl: "#" },
                { imgUrl: "https://picsum.photos/1200/400?random=2", linkUrl: "#" },
                { imgUrl: "https://picsum.photos/1200/400?random=3", linkUrl: "#" }
            ],
            timezones: [
                { name: "北京", timezone: "Asia/Shanghai" },
                { name: "纽约", timezone: "America/New_York" },
                { name: "伦敦", timezone: "Europe/London" }
            ],
            github: {
                repo: "",
                token: ""
            },
            search: {
                type: "site", // 只保留站内搜索
                history: [],
                saveHistory: true,
                showSuggestions: true
            },
            usageData: [1.2, 0.8, 1.5, 0.6, 2.1, 1.8, 3.5],
            currentTheme: "dark"
        };
        
        // DOM元素
        const elements = {
            stars: document.getElementById('stars'),
            header: document.getElementById('header'),
            themeToggle: document.getElementById('theme-toggle'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettings: document.getElementById('close-settings'),
            githubRepo: document.getElementById('github-repo'),
            githubToken: document.getElementById('github-token'),
            authenticateBtn: document.getElementById('authenticate-btn'),
            editorModal: document.getElementById('editor-modal'),
            closeEditor: document.getElementById('close-editor'),
            bookmarksContainer: document.getElementById('bookmarks-container'),
            bookmarksEditorContainer: document.getElementById('bookmarks-editor-container'),
            importBookmarks: document.getElementById('import-bookmarks'),
            exportBookmarks: document.getElementById('export-bookmarks'),
            saveChanges: document.getElementById('save-changes'),
            addBookmarkGroup: document.getElementById('add-bookmark-group'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            cancelConfirm: document.getElementById('cancel-confirm'),
            confirmAction: document.getElementById('confirm-action'),
            notification: document.getElementById('notification'),
            notificationTitle: document.getElementById('notification-title'),
            notificationMessage: document.getElementById('notification-message'),
            notificationIcon: document.getElementById('notification-icon'),
            closeNotification: document.getElementById('close-notification'),
            totalBookmarks: document.getElementById('total-bookmarks'),
            currentYear: document.getElementById('current-year'),
            hostname: document.getElementById('hostname'),
            bookmarkCountDisplay: document.getElementById('bookmark-count-display'),
            newTimezone: document.getElementById('new-timezone'),
            addTimezoneBtn: document.getElementById('add-timezone-btn'),
            timezonesContainer: document.getElementById('timezones-container'),
            timezonesList: document.getElementById('timezones-list'),
            timeDisplay: document.getElementById('time-display'),
            dateDisplay: document.getElementById('date-display'),
            uptimeDisplay: document.getElementById('uptime-display'),
            ad1Img: document.getElementById('ad1-img'),
            ad1Link: document.getElementById('ad1-link'),
            ad1UrlInput: document.getElementById('ad1-url-input'),
            ad1LinkInput: document.getElementById('ad1-link-input'),
            ad1Upload: document.getElementById('ad1-upload'),
            ad2Img: document.getElementById('ad2-img'),
            ad2Link: document.getElementById('ad2-link'),
            ad2UrlInput: document.getElementById('ad2-url-input'),
            ad2LinkInput: document.getElementById('ad2-link-input'),
            ad2Upload: document.getElementById('ad2-upload'),
            ad3Img: document.getElementById('ad3-img'),
            ad3Link: document.getElementById('ad3-link'),
            ad3UrlInput: document.getElementById('ad3-url-input'),
            ad3LinkInput: document.getElementById('ad3-link-input'),
            ad3Upload: document.getElementById('ad3-upload'),
            // 搜索引擎相关元素
            searchInput: document.getElementById('search-input'),
            searchBtn: document.getElementById('search-btn'),
            searchSuggestions: document.getElementById('search-suggestions'),
            searchHistory: document.getElementById('search-history'),
            historyList: document.getElementById('history-list'),
            clearHistory: document.getElementById('clear-history'),
            searchSettings: document.getElementById('search-settings'),
            searchSettingsModal: document.getElementById('search-settings-modal'),
            closeSearchSettings: document.getElementById('close-search-settings'),
            saveSearchHistory: document.getElementById('save-search-history'),
            showSearchSuggestions: document.getElementById('show-search-suggestions'),
            saveSearchSettings: document.getElementById('save-search-settings'),
            // 搜索类型切换
            searchTypeSite: document.getElementById('search-type-site'),
            // 搜索结果
            searchResultsContainer: document.getElementById('search-results-container'),
            searchResults: document.getElementById('search-results'),
            searchResultsCount: document.getElementById('search-results-count'),
            clearSearch: document.getElementById('clear-search')
        };
        
        // 确认对话框回调
        let confirmCallback = null;
        let scrollTimer;
        let searchSuggestionIndex = -1;
        let searchSuggestionTimeout = null;
        
        // 初始化函数
        async function init() {
            createStars();
            initUsageChart();
            setupEventListeners();
            loadLocalSettings();
            
            // 自动填充仓库信息
            document.getElementById('github-repo').value = DEFAULT_REPO;
            
            await loadDataFromGitHub();
            renderTimezones();
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000);
            renderBookmarks();
            updateBookmarkCount();
            setupAdEditor();
            elements.currentYear.textContent = new Date().getFullYear();
            
            // 初始化搜索引擎
            initSearchEngine();
            loadSearchHistory();
            renderSearchHistory();
            
            // 计算并更新运行时间
            updateUptime();
            setInterval(updateUptime, 60000); // 每分钟更新一次
            
            // 检查主题设置并应用
            applyTheme(appData.currentTheme);
        }
        
        // 创建星空背景
        function createStars() {
            const starsCount = 150;
            const starsContainer = elements.stars;
            
            for (let i = 0; i < starsCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // 随机位置
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                
                // 随机大小
                const size = Math.random() * 2 + 1;
                
                // 随机闪烁延迟
                const delay = Math.random() * 2;
                
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.animationDelay = `${delay}s`;
                
                starsContainer.appendChild(star);
            }
        }
        
        // 初始化使用统计图表
        function initUsageChart() {
            const ctx = document.getElementById('usage-chart').getContext('2d');
            
            // 生成过去7天的日期标签
            const labels = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                labels.push(`${date.getMonth() + 1}/${date.getDate()}`);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '使用时长 (小时)',
                        data: appData.usageData,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        }
        
        // 更新运行时间显示
        function updateUptime() {
            const now = new Date();
            const diffMs = now - DEPLOY_DATE;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            elements.uptimeDisplay.textContent = `${diffDays}天${diffHours}小时${diffMinutes}分钟`;
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 主题切换
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            // 设置对话框
            elements.settingsBtn.addEventListener('click', () => {
                elements.settingsModal.classList.remove('hidden');
            });
            
            elements.closeSettings.addEventListener('click', () => {
                elements.settingsModal.classList.add('hidden');
            });
            
            // 验证并进入编辑模式
            elements.authenticateBtn.addEventListener('click', () => {
                appData.github.token = elements.githubToken.value;
                appData.github.repo = elements.githubRepo.value;
                saveLocalSettings();
                elements.settingsModal.classList.add('hidden');
                showNotification('成功', '已进入编辑模式', 'success');
                elements.editorModal.classList.remove('hidden');
                renderBookmarksEditor();
            });
            
            // 编辑模式
            elements.closeEditor.addEventListener('click', () => {
                elements.editorModal.classList.add('hidden');
            });
            
            // 添加书签组
            elements.addBookmarkGroup.addEventListener('click', () => {
                const newGroup = {
                    id: Date.now().toString(),
                    name: '新书签组',
                    bookmarks: []
                };
                appData.bookmarks.push(newGroup);
                renderBookmarksEditor();
                updateBookmarkCount();
            });
            
            // 导入书签
            elements.importBookmarks.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const imported = JSON.parse(event.target.result);
                                if (Array.isArray(imported)) {
                                    appData.bookmarks = imported;
                                    renderBookmarksEditor();
                                    updateBookmarkCount();
                                    showNotification('成功', '书签导入成功', 'success');
                                } else {
                                    showNotification('错误', '导入的文件格式不正确', 'error');
                                }
                            } catch (err) {
                                showNotification('错误', '解析文件失败', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            });
            
            // 导出书签
            elements.exportBookmarks.addEventListener('click', () => {
                const dataStr = JSON.stringify(appData.bookmarks, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `bookmarks_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showNotification('成功', '书签已导出', 'success');
            });
            
            // 保存更改
            elements.saveChanges.addEventListener('click', async () => {
                saveAdSettings();
                saveTimezones();
                await saveDataToGitHub();
                renderBookmarks();
                updateBookmarkCount();
                elements.editorModal.classList.add('hidden');
                showNotification('成功', '更改已保存', 'success');
            });
            
            // 确认对话框
            elements.cancelConfirm.addEventListener('click', () => {
                elements.confirmModal.classList.add('hidden');
                confirmCallback = null;
            });
            
            elements.confirmAction.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                    confirmCallback = null;
                }
                elements.confirmModal.classList.add('hidden');
            });
            
            // 通知关闭
            elements.closeNotification.addEventListener('click', hideNotification);
            
            // 时区添加
            elements.addTimezoneBtn.addEventListener('click', addTimezone);
            
            // 搜索相关
            elements.searchBtn.addEventListener('click', performSearch);
            elements.searchInput.addEventListener('input', handleSearchInput);
            elements.searchInput.addEventListener('keydown', handleSearchKeydown);
            elements.clearSearch.addEventListener('click', clearSearch);
            elements.clearHistory.addEventListener('click', clearSearchHistory);
            
            // 搜索设置
            elements.searchSettings.addEventListener('click', () => {
                elements.searchSettingsModal.classList.remove('hidden');
            });
            
            elements.closeSearchSettings.addEventListener('click', () => {
                elements.searchSettingsModal.classList.add('hidden');
            });
            
            elements.saveSearchSettings.addEventListener('click', saveSearchSettings);
            
            // 滚动事件 - 处理导航栏
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimer);
                if (window.scrollY > 50) {
                    elements.header.classList.add('py-2');
                    elements.header.classList.remove('py-3');
                    elements.header.classList.add('shadow-md');
                } else {
                    scrollTimer = setTimeout(() => {
                        elements.header.classList.add('py-3');
                        elements.header.classList.remove('py-2');
                        elements.header.classList.remove('shadow-md');
                    }, 300);
                }
            });
            
            // 点击页面其他地方关闭搜索建议
            document.addEventListener('click', (e) => {
                if (!elements.searchInput.contains(e.target) && 
                    !elements.searchSuggestions.contains(e.target)) {
                    elements.searchSuggestions.classList.add('hidden');
                    searchSuggestionIndex = -1;
                }
            });
        }
        
        // 应用主题设置
        function applyTheme(theme) {
            const body = document.body;
            
            if (theme === 'light') {
                body.classList.add('light');
                body.classList.remove('bg-space-dark');
                body.classList.add('bg-gray-100');
                body.classList.add('text-gray-900');
                elements.themeToggle.innerHTML = '<i class="fa fa-sun-o text-space-accent"></i>';
            } else {
                body.classList.remove('light');
                body.classList.add('bg-space-dark');
                body.classList.remove('bg-gray-100');
                body.classList.remove('text-gray-900');
                elements.themeToggle.innerHTML = '<i class="fa fa-moon-o text-space-accent"></i>';
            }
            
            // 更新星星可见性
            elements.stars.style.display = theme === 'light' ? 'none' : 'block';
        }
        
        // 切换主题
        function toggleTheme() {
            appData.currentTheme = appData.currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(appData.currentTheme);
            saveLocalSettings();
        }
        
        // 显示通知
        function showNotification(title, message, type = 'info') {
            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;
            
            // 设置图标
            let iconClass = 'fa-info-circle text-space-accent';
            if (type === 'success') {
                iconClass = 'fa-check-circle text-green-500';
            } else if (type === 'error') {
                iconClass = 'fa-exclamation-circle text-red-500';
            } else if (type === 'warning') {
                iconClass = 'fa-exclamation-triangle text-yellow-500';
            }
            
            elements.notificationIcon.innerHTML = `<i class="fa ${iconClass}"></i>`;
            
            // 显示通知
            elements.notification.classList.remove('translate-y-20', 'opacity-0');
            
            // 自动隐藏
            setTimeout(hideNotification, 3000);
        }
        
        // 隐藏通知
        function hideNotification() {
            elements.notification.classList.add('translate-y-20', 'opacity-0');
        }
        
        // 加载本地设置
        function loadLocalSettings() {
            const saved = localStorage.getItem('spaceNavigatorSettings');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.github) {
                    appData.github = parsed.github;
                    elements.githubToken.value = appData.github.token || '';
                }
                if (parsed.search) {
                    appData.search = parsed.search;
                    elements.saveSearchHistory.checked = appData.search.saveHistory;
                    elements.showSearchSuggestions.checked = appData.search.showSuggestions;
                }
                if (parsed.theme) {
                    appData.currentTheme = parsed.theme;
                }
                if (parsed.timezones) {
                    appData.timezones = parsed.timezones;
                }
                if (parsed.ads) {
                    appData.ads = parsed.ads;
                }
            }
        }
        
        // 保存本地设置
        function saveLocalSettings() {
            const toSave = {
                github: appData.github,
                search: appData.search,
                theme: appData.currentTheme,
                timezones: appData.timezones,
                ads: appData.ads
            };
            localStorage.setItem('spaceNavigatorSettings', JSON.stringify(toSave));
        }
        
        // 从GitHub加载数据
        async function loadDataFromGitHub() {
            try {
                const response = await fetch(DEFAULT_RAW_URL);
                if (response.ok) {
                    appData.bookmarks = await response.json();
                } else {
                    throw new Error('Failed to fetch bookmarks');
                }
            } catch (err) {
                console.error('Error loading data from GitHub:', err);
                // 使用默认数据
                appData.bookmarks = [
                    {
                        id: '1',
                        name: '开发工具',
                        bookmarks: [
                            { id: '1-1', name: 'GitHub', url: 'https://github.com', icon: 'fa-github' },
                            { id: '1-2', name: 'Stack Overflow', url: 'https://stackoverflow.com', icon: 'fa-stack-overflow' }
                        ]
                    },
                    {
                        id: '2',
                        name: '学习资源',
                        bookmarks: [
                            { id: '2-1', name: 'MDN Web Docs', url: 'https://developer.mozilla.org', icon: 'fa-book' }
                        ]
                    }
                ];
            }
        }
        
        // 保存数据到GitHub
        async function saveDataToGitHub() {
            // 实际项目中实现GitHub API保存逻辑
            saveLocalSettings();
            return true;
        }
        
        // 渲染书签
        function renderBookmarks() {
            elements.bookmarksContainer.innerHTML = '';
            
            appData.bookmarks.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'widget-card';
                
                // 书签组标题
                const header = document.createElement('div');
                header.className = 'widget-header';
                header.innerHTML = `<h3 class="widget-title"><i class="fa fa-folder-open-o mr-2"></i>${group.name}</h3>`;
                groupElement.appendChild(header);
                
                // 书签内容
                const bookmarksContent = document.createElement('div');
                bookmarksContent.className = 'p-4';
                
                // 响应式网格布局
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3';
                
                group.bookmarks.forEach(bookmark => {
                    const bookmarkElement = document.createElement('a');
                    bookmarkElement.href = bookmark.url;
                    bookmarkElement.target = '_blank';
                    bookmarkElement.className = 'bg-space-darker/50 rounded-lg p-3 flex flex-col items-center justify-center text-center hover:bg-space-accent/10 transition-all hover:scale-105';
                    
                    const icon = document.createElement('i');
                    icon.className = `fa ${bookmark.icon || 'fa-link'} text-space-accent text-xl mb-2`;
                    
                    const name = document.createElement('div');
                    name.className = 'text-sm truncate w-full';
                    name.textContent = bookmark.name;
                    
                    bookmarkElement.appendChild(icon);
                    bookmarkElement.appendChild(name);
                    grid.appendChild(bookmarkElement);
                });
                
                bookmarksContent.appendChild(grid);
                groupElement.appendChild(bookmarksContent);
                elements.bookmarksContainer.appendChild(groupElement);
            });
            
            // 更新总书签数
            let total = 0;
            appData.bookmarks.forEach(group => {
                total += group.bookmarks.length;
            });
            elements.totalBookmarks.textContent = total;
        }
        
        // 渲染书签编辑器
        function renderBookmarksEditor() {
            elements.bookmarksEditorContainer.innerHTML = '';
            
            appData.bookmarks.forEach((group, groupIndex) => {
                const groupElement = document.createElement('div');
                groupElement.className = 'bg-space-dark/50 rounded-lg p-4';
                
                // 书签组标题编辑
                const groupHeader = document.createElement('div');
                groupHeader.className = 'flex items-center mb-3';
                
                const groupNameInput = document.createElement('input');
                groupNameInput.type = 'text';
                groupNameInput.value = group.name;
                groupNameInput.className = 'flex-1 w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-white focus:outline-none focus:border-space-accent mr-2';
                groupNameInput.addEventListener('change', (e) => {
                    group.name = e.target.value;
                });
                
                const deleteGroupBtn = document.createElement('button');
                deleteGroupBtn.className = 'text-gray-400 hover:text-red-500 touch-target';
                deleteGroupBtn.innerHTML = '<i class="fa fa-trash"></i>';
                deleteGroupBtn.addEventListener('click', () => {
                    showConfirm('删除书签组', `确定要删除"${group.name}"吗？此操作不可恢复。`, () => {
                        appData.bookmarks.splice(groupIndex, 1);
                        renderBookmarksEditor();
                        updateBookmarkCount();
                    });
                });
                
                groupHeader.appendChild(groupNameInput);
                groupHeader.appendChild(deleteGroupBtn);
                groupElement.appendChild(groupHeader);
                
                // 添加书签按钮
                const addBookmarkBtn = document.createElement('button');
                addBookmarkBtn.className = 'w-full py-2 text-sm bg-space-accent/20 hover:bg-space-accent/30 rounded-lg transition-colors mb-3 text-center';
                addBookmarkBtn.innerHTML = '<i class="fa fa-plus mr-1"></i>添加书签';
                addBookmarkBtn.addEventListener('click', () => {
                    const newBookmark = {
                        id: `${group.id}-${Date.now()}`,
                        name: '新书签',
                        url: 'https://',
                        icon: 'fa-link'
                    };
                    group.bookmarks.push(newBookmark);
                    renderBookmarksEditor();
                    updateBookmarkCount();
                });
                
                groupElement.appendChild(addBookmarkBtn);
                
                // 书签列表
                const bookmarksList = document.createElement('div');
                bookmarksList.className = 'space-y-2';
                
                group.bookmarks.forEach((bookmark, bookmarkIndex) => {
                    const bookmarkElement = document.createElement('div');
                    bookmarkElement.className = 'flex items-center p-2 bg-space-darker/70 rounded';
                    
                    const bookmarkInfo = document.createElement('div');
                    bookmarkInfo.className = 'flex-1 space-y-1';
                    
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = bookmark.name;
                    nameInput.className = 'w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-white focus:outline-none focus:border-space-accent text-sm';
                    nameInput.addEventListener('change', (e) => {
                        bookmark.name = e.target.value;
                    });
                    
                    const urlInput = document.createElement('input');
                    urlInput.type = 'url';
                    urlInput.value = bookmark.url;
                    urlInput.className = 'w-full bg-space-dark border border-gray-700 rounded px-2 py-2 text-white focus:outline-none focus:border-space-accent text-sm text-gray-400';
                    urlInput.addEventListener('change', (e) => {
                        bookmark.url = e.target.value;
                    });
                    
                    bookmarkInfo.appendChild(nameInput);
                    bookmarkInfo.appendChild(urlInput);
                    
                    const actions = document.createElement('div');
                    actions.className = 'flex space-x-1';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-gray-400 hover:text-red-500 touch-target';
                    deleteBtn.innerHTML = '<i class="fa fa-trash"></i>';
                    deleteBtn.addEventListener('click', () => {
                        group.bookmarks.splice(bookmarkIndex, 1);
                        renderBookmarksEditor();
                        updateBookmarkCount();
                    });
                    
                    actions.appendChild(deleteBtn);
                    bookmarkElement.appendChild(bookmarkInfo);
                    bookmarkElement.appendChild(actions);
                    bookmarksList.appendChild(bookmarkElement);
                });
                
                groupElement.appendChild(bookmarksList);
                elements.bookmarksEditorContainer.appendChild(groupElement);
            });
        }
        
        // 更新书签计数
        function updateBookmarkCount() {
            let total = 0;
            appData.bookmarks.forEach(group => {
                total += group.bookmarks.length;
            });
            elements.bookmarkCountDisplay.textContent = `共 ${total} 个书签`;
            elements.totalBookmarks.textContent = total;
        }
        
        // 设置广告编辑
        function setupAdEditor() {
            // 广告1
            elements.ad1UrlInput.value = appData.ads[0].imgUrl;
            elements.ad1LinkInput.value = appData.ads[0].linkUrl;
            
            // 广告2
            elements.ad2UrlInput.value = appData.ads[1].imgUrl;
            elements.ad2LinkInput.value = appData.ads[1].linkUrl;
            
            // 广告3
            elements.ad3UrlInput.value = appData.ads[2].imgUrl;
            elements.ad3LinkInput.value = appData.ads[2].linkUrl;
            
            // 广告图片上传
            setupAdUpload(elements.ad1Upload, (url) => {
                appData.ads[0].imgUrl = url;
                elements.ad1Img.src = url;
                elements.ad1UrlInput.value = url;
            });
            
            setupAdUpload(elements.ad2Upload, (url) => {
                appData.ads[1].imgUrl = url;
                elements.ad2Img.src = url;
                elements.ad2UrlInput.value = url;
            });
            
            setupAdUpload(elements.ad3Upload, (url) => {
                appData.ads[2].imgUrl = url;
                elements.ad3Img.src = url;
                elements.ad3UrlInput.value = url;
            });
        }
        
        // 设置广告上传
        function setupAdUpload(inputElement, callback) {
            inputElement.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        callback(event.target.result);
                        showNotification('成功', '图片上传成功', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // 保存广告设置
        function saveAdSettings() {
            appData.ads[0].imgUrl = elements.ad1UrlInput.value;
            appData.ads[0].linkUrl = elements.ad1LinkInput.value;
            elements.ad1Img.src = appData.ads[0].imgUrl;
            elements.ad1Link.href = appData.ads[0].linkUrl;
            
            appData.ads[1].imgUrl = elements.ad2UrlInput.value;
            appData.ads[1].linkUrl = elements.ad2LinkInput.value;
            elements.ad2Img.src = appData.ads[1].imgUrl;
            elements.ad2Link.href = appData.ads[1].linkUrl;
            
            appData.ads[2].imgUrl = elements.ad3UrlInput.value;
            appData.ads[2].linkUrl = elements.ad3LinkInput.value;
            elements.ad3Img.src = appData.ads[2].imgUrl;
            elements.ad3Link.href = appData.ads[2].linkUrl;
            
            saveLocalSettings();
        }
        
        // 添加时区
        function addTimezone() {
            const timezoneValue = elements.newTimezone.value;
            if (!timezoneValue) return;
            
            // 从选项文本中提取城市名称
            const selectElement = elements.newTimezone;
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const cityName = selectedOption.text.split(' ')[0];
            
            // 检查是否已存在
            const exists = appData.timezones.some(tz => tz.timezone === timezoneValue);
            if (!exists) {
                appData.timezones.push({
                    name: cityName,
                    timezone: timezoneValue
                });
                renderTimezonesEditor();
                renderTimezones();
                saveLocalSettings();
                elements.newTimezone.value = '';
            }
        }
        
        // 渲染时区
        function renderTimezones() {
            elements.timezonesContainer.innerHTML = '';
            
            appData.timezones.forEach((tz, index) => {
                const timezoneElement = document.createElement('div');
                timezoneElement.className = 'bg-space-darker/50 rounded-lg p-3';
                
                const cityName = document.createElement('div');
                cityName.className = 'text-sm text-gray-400';
                cityName.textContent = tz.name;
                
                const timeDisplay = document.createElement('div');
                timeDisplay.className = 'text-lg font-medium mt-1';
                timeDisplay.id = `timezone-${index}`;
                
                timezoneElement.appendChild(cityName);
                timezoneElement.appendChild(timeDisplay);
                elements.timezonesContainer.appendChild(timezoneElement);
            });
            
            renderTimezonesEditor();
        }
        
        // 渲染时区编辑器
        function renderTimezonesEditor() {
            elements.timezonesList.innerHTML = '';
            
            appData.timezones.forEach((tz, index) => {
                const timezoneElement = document.createElement('div');
                timezoneElement.className = 'flex items-center justify-between bg-space-darker/50 p-2 rounded';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-sm';
                nameSpan.textContent = tz.name;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-gray-400 hover:text-red-500 touch-target';
                deleteBtn.innerHTML = '<i class="fa fa-times"></i>';
                deleteBtn.addEventListener('click', () => {
                    appData.timezones.splice(index, 1);
                    renderTimezones();
                    saveLocalSettings();
                });
                
                timezoneElement.appendChild(nameSpan);
                timezoneElement.appendChild(deleteBtn);
                elements.timezonesList.appendChild(timezoneElement);
            });
        }
        
        // 保存时区设置
        function saveTimezones() {
            saveLocalSettings();
        }
        
        // 更新时间显示
        function updateTimeDisplay() {
            const now = new Date();
            
            // 更新本地时间
            elements.timeDisplay.textContent = now.toTimeString().slice(0, 8);
            
            // 更新日期
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            elements.dateDisplay.textContent = now.toLocaleDateString('zh-CN', options);
            
            // 更新各时区时间
            appData.timezones.forEach((tz, index) => {
                const element = document.getElementById(`timezone-${index}`);
                if (element) {
                    // 使用toLocaleTimeString确保时区正确转换
                    const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: tz.timezone };
                    const timezoneTime = now.toLocaleTimeString('zh-CN', options);
                    element.textContent = timezoneTime;
                }
            });
        }
        
        // 显示确认对话框
        function showConfirm(title, message, callback) {
            elements.confirmTitle.textContent = title;
            elements.confirmMessage.textContent = message;
            confirmCallback = callback;
            elements.confirmModal.classList.remove('hidden');
        }
        
        // 初始化搜索引擎
        function initSearchEngine() {
            // 只保留站内搜索
            elements.search.type = "site";
        }
        
        // 处理搜索输入
        function handleSearchInput() {
            const query = elements.searchInput.value.trim();
            
            if (query.length < 1) {
                elements.searchSuggestions.classList.add('hidden');
                elements.searchResultsContainer.classList.add('hidden');
                if (appData.search.history.length > 0) {
                    elements.searchHistory.classList.remove('hidden');
                } else {
                    elements.searchHistory.classList.add('hidden');
                }
                return;
            }
            
            elements.searchHistory.classList.add('hidden');
            
            if (appData.search.type === 'site') {
                // 站内搜索
                performSiteSearch(query);
                
                // 显示搜索结果
                elements.searchResultsContainer.classList.remove('hidden');
            }
            
            // 搜索建议
            if (appData.search.showSuggestions && query.length >= 2) {
                clearTimeout(searchSuggestionTimeout);
                searchSuggestionTimeout = setTimeout(() => {
                    generateSearchSuggestions(query);
                }, 300);
            } else {
                elements.searchSuggestions.classList.add('hidden');
            }
        }
        
        // 处理搜索按键
        function handleSearchKeydown(e) {
            const suggestions = elements.searchSuggestions.querySelectorAll('.search-suggestion');
            
            // 下箭头
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                searchSuggestionIndex = (searchSuggestionIndex + 1) % suggestions.length;
                highlightSuggestion(suggestions);
            }
            // 上箭头
            else if (e.key === 'ArrowUp') {
                e.preventDefault();
                searchSuggestionIndex = (searchSuggestionIndex - 1 + suggestions.length) % suggestions.length;
                highlightSuggestion(suggestions);
            }
            // 回车
            else if (e.key === 'Enter') {
                e.preventDefault();
                if (searchSuggestionIndex >= 0 && suggestions.length > 0) {
                    elements.searchInput.value = suggestions[searchSuggestionIndex].textContent;
                }
                elements.searchSuggestions.classList.add('hidden');
                performSearch();
                searchSuggestionIndex = -1;
            }
            // ESC
            else if (e.key === 'Escape') {
                elements.searchSuggestions.classList.add('hidden');
                searchSuggestionIndex = -1;
            }
        }
        
        // 高亮搜索建议
        function highlightSuggestion(suggestions) {
            suggestions.forEach((s, i) => {
                if (i === searchSuggestionIndex) {
                    s.classList.add('search-suggestion-active');
                } else {
                    s.classList.remove('search-suggestion-active');
                }
            });
        }
        
        // 执行搜索
        function performSearch() {
            const query = elements.searchInput.value.trim();
            if (!query) return;
            
            // 保存搜索历史
            if (appData.search.saveHistory) {
                // 移除重复项
                appData.search.history = appData.search.history.filter(item => item !== query);
                // 添加到历史记录
                appData.search.history.unshift(query);
                // 限制历史记录数量
                if (appData.search.history.length > 20) {
                    appData.search.history.pop();
                }
                saveSearchHistory();
                renderSearchHistory();
            }
            
            // 执行站内搜索
            performSiteSearch(query);
            
            // 显示搜索结果
            elements.searchResultsContainer.classList.remove('hidden');
            elements.searchSuggestions.classList.add('hidden');
        }
        
        // 执行站内搜索
        function performSiteSearch(query) {
            const results = [];
            const lowerQuery = query.toLowerCase();
            
            appData.bookmarks.forEach(group => {
                group.bookmarks.forEach(bookmark => {
                    const nameMatch = bookmark.name.toLowerCase().includes(lowerQuery);
                    const urlMatch = bookmark.url.toLowerCase().includes(lowerQuery);
                    
                    if (nameMatch || urlMatch) {
                        results.push({
                            ...bookmark,
                            groupName: group.name
                        });
                    }
                });
            });
            
            // 显示结果计数
            elements.searchResultsCount.textContent = `找到 ${results.length} 个结果`;
            
            // 显示结果
            elements.searchResults.innerHTML = '';
            
            if (results.length === 0) {
                elements.searchResults.innerHTML = '<div class="text-center py-4 text-gray-400">没有找到匹配的书签</div>';
                return;
            }
            
            results.forEach(result => {
                const resultElement = document.createElement('a');
                resultElement.href = result.url;
                resultElement.target = '_blank';
                resultElement.className = 'block p-3 bg-space-darker/50 rounded-lg hover:bg-space-accent/10 transition-colors';
                
                // 高亮匹配文本
                let displayName = result.name;
                const nameLower = result.name.toLowerCase();
                const queryIndex = nameLower.indexOf(lowerQuery);
                
                if (queryIndex !== -1) {
                    displayName = result.name.substring(0, queryIndex) +
                                  `<span class="search-result-highlight">${result.name.substring(queryIndex, queryIndex + query.length)}</span>` +
                                  result.name.substring(queryIndex + query.length);
                }
                
                resultElement.innerHTML = `
                    <div class="text-sm text-gray-400 mb-1">${result.groupName}</div>
                    <div class="flex items-center">
                        <i class="fa ${result.icon || 'fa-link'} text-space-accent mr-2"></i>
                        <div>
                            <div class="font-medium">${displayName}</div>
                            <div class="text-xs text-gray-500 mt-1 truncate">${result.url}</div>
                        </div>
                    </div>
                `;
                
                elements.searchResults.appendChild(resultElement);
            });
        }
        
        // 生成搜索建议
        function generateSearchSuggestions(query) {
            const suggestions = [];
            const lowerQuery = query.toLowerCase();
            
            // 从书签名称生成建议
            appData.bookmarks.forEach(group => {
                group.bookmarks.forEach(bookmark => {
                    if (bookmark.name.toLowerCase().includes(lowerQuery) && 
                        !suggestions.includes(bookmark.name) &&
                        suggestions.length < 10) {
                        suggestions.push(bookmark.name);
                    }
                });
            });
            
            // 显示建议
            elements.searchSuggestions.innerHTML = '';
            
            if (suggestions.length === 0) {
                elements.searchSuggestions.classList.add('hidden');
                return;
            }
            
            suggestions.forEach(suggestion => {
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'search-suggestion';
                suggestionElement.textContent = suggestion;
                suggestionElement.addEventListener('click', () => {
                    elements.searchInput.value = suggestion;
                    elements.searchSuggestions.classList.add('hidden');
                    performSearch();
                });
                elements.searchSuggestions.appendChild(suggestionElement);
            });
            
            elements.searchSuggestions.classList.remove('hidden');
            searchSuggestionIndex = -1;
        }
        
        // 清除搜索
        function clearSearch() {
            elements.searchInput.value = '';
            elements.searchResultsContainer.classList.add('hidden');
            elements.searchSuggestions.classList.add('hidden');
            if (appData.search.history.length > 0) {
                elements.searchHistory.classList.remove('hidden');
            }
            searchSuggestionIndex = -1;
        }
        
        // 加载搜索历史
        function loadSearchHistory() {
            // 已在loadLocalSettings中加载
        }
        
        // 保存搜索历史
        function saveSearchHistory() {
            saveLocalSettings();
        }
        
        // 渲染搜索历史
        function renderSearchHistory() {
            elements.historyList.innerHTML = '';
            
            appData.search.history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-space-darker/50 px-2 py-1 rounded text-sm hover:bg-space-accent/20 transition-colors';
                historyItem.textContent = item;
                historyItem.addEventListener('click', () => {
                    elements.searchInput.value = item;
                    performSearch();
                });
                elements.historyList.appendChild(historyItem);
            });
            
            if (appData.search.history.length === 0) {
                elements.searchHistory.classList.add('hidden');
            }
        }
        
        // 清除搜索历史
        function clearSearchHistory() {
            showConfirm('清除搜索历史', '确定要清除所有搜索历史吗？', () => {
                appData.search.history = [];
                saveSearchHistory();
                renderSearchHistory();
                elements.searchHistory.classList.add('hidden');
            });
        }
        
        // 保存搜索设置
        function saveSearchSettings() {
            appData.search.saveHistory = elements.saveSearchHistory.checked;
            appData.search.showSuggestions = elements.showSuggestions.checked;
            saveLocalSettings();
            elements.searchSettingsModal.classList.add('hidden');
            showNotification('成功', '搜索设置已保存', 'success');
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
