<!-- index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>外太空导航</title>
    <link rel="icon" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiMwMDAwMDAiLz4KICA8Y2lyY2xlIGN4PSIzMiIgY3k9IjMyIiByPSIyMCIgZmlsbD0iIzAwMDBGRiIgb3BhY2l0eT0iMC41Ii8+CiAgPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iNSIgZmlsbD0iI0ZGRkZGRiIvPgogIDxjaXJjbGUgY3g9IjQ0IiBjeT0iMjAiIHI9IjQiIGZpbGw9IiNGRkZGRkYiLz4KICA8Y2lyY2xlIGN4PSIzMiIgY3k9IjQwIiByPSI2IiBmaWxsPSIjRkZGRkZGIi8+CiAgPGNpcmNsZSBjeD0iMTUiIGN5PSI0NSIgcj0iMyIgZmlsbD0iI0ZGRkZGRiIvPgogIDxjaXJjbGUgY3g9IjQ5IiBjeT0iNDUiIHI9IjIiIGZpbGw9IiNGRkZGRkYiLz4KICA8cGF0aCBkPSJNMzIgMzJMNDAgNDBNMzIgMzJMMjQgNDBNMzIgMzJMNDAgMjRNMzIgMzJMMjQgMjQiIHN0cm9rZT0iI0ZGRkZGRiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg==" type="image/svg+xml">
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzAwMDAxNSIvPgogIDxjaXJjbGUgY3g9IjEwIiBjeT0iMTAiIHI9IjEiIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMC41IiBmaWxsPSJ3aGl0ZSIvPgogIDxjaXJjbGUgY3g9IjMwIiBjeT0iMzAiIHI9IjAuOCIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSI0MCIgY3k9IjQwIiByPSIxIiBmaWxsPSJ3aGl0ZSIvPgogIDxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjAuNSIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSI2MCIgY3k9IjYwIiByPSIwLjciIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iNzAiIGN5PSI3MCIgcj0iMC45IiBmaWxsPSJ3aGl0ZSIvPgogIDxjaXJjbGUgY3g9IjgwIiBjeT0iODAiIHI9IjAuNiIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSI5MCIgY3k9IjkwIiByPSIwLjQiIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iMTAiIGN5PSI5MCIgcj0iMC44IiBmaWxsPSJ3aGl0ZSIvPgogIDxjaXJjbGUgY3g9IjIwIiBjeT0iODAiIHI9IjAuNSIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSIzMCIgY3k9IjcwIiByPSIwLjciIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iNDAiIGN5PSI2MCIgcj0iMC45IiBmaWxsPSJ3aGl0ZSIvPgogIDxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjAuNiIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSI2MCIgY3k9IjQwIiByPSIwLjQiIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iNzAiIGN5PSIzMCIgcj0iMC44IiBmaWxsPSJ3aGl0ZSIvPgogIDxjaXJjbGUgY3g9IjgwIiBjeT0iMjAiIHI9IjAuNSIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSI5MCIgY3k9IjEwIiByPSIwLjciIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==') repeat; color: #fff; transition: background 0.3s, color 0.3s; }
        body.light { background: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI0ZGRkZGRiIvPgogIDxjaXJjbGUgY3g9IjEwIiBjeT0iMTAiIHI9IjEiIGZpbGw9IiMwMDAwMDAiLz4KICA8Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIwLjUiIGZpbGw9IiMwMDAwMDAiLz4KICA8Y2lyY2xlIGN4PSIzMCIgY3k9IjMwIiByPSIwLjgiIGZpbGw9IiMwMDAwMDAiLz4KICA8Y2lyY2xlIGN4PSI0MCIgY3k9IjQwIiByPSIxIiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMC41IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iNjAiIGN5PSI2MCIgcj0iMC43IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iNzAiIGN5PSI3MCIgcj0iMC45IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iODAiIGN5PSI4MCIgcj0iMC42IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iOTAiIGN5PSI5MCIgcj0iMC40IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iMTAiIGN5PSI5MCIgcj0iMC44IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iMjAiIGN5PSI4MCIgcj0iMC41IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iMzAiIGN5PSI3MCIgcj0iMC43IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iNDAiIGN5PSI2MCIgcj0iMC45IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMC42IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iNjAiIGN5PSI0MCIgcj0iMC40IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iNzAiIGN5PSIzMCIgcj0iMC44IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iODAiIGN5PSIyMCIgcj0iMC41IiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iOTAiIGN5PSIxMCIgcj0iMC43IiBmaWxsPSIjMDAwMDAwIi8+Cjwvc3ZnPg==') repeat; color: #000; }
        .header { display: flex; justify-content: space-between; padding: 10px; }
        .widgets { display: flex; gap: 20px; }
        .widget { border: 1px solid #fff; padding: 10px; border-radius: 5px; background: rgba(0,0,0,0.5); color: #fff; }
        body.light .widget { border-color: #000; background: rgba(255,255,255,0.5); color: #000; }
        .search { margin: 10px; }
        #searchInput { width: 100%; padding: 10px; box-sizing: border-box; }
        .bookmarks { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding: 10px; }
        .bookmark { display: flex; align-items: center; justify-content: center; height: 50px; background: rgba(255,255,255,0.1); border-radius: 5px; text-decoration: none; color: inherit; font-size: 14px; text-align: center; word-break: break-all; padding: 5px; }
        body.light .bookmark { background: rgba(0,0,0,0.1); }
        .bookmark img { width: 16px; height: 16px; margin-right: 5px; }
        .folder { cursor: pointer; }
        .ads { display: flex; justify-content: space-around; padding: 10px; }
        .ad { width: 30%; height: 100px; background: grey; }
        .ad img { width: 100%; height: 100%; object-fit: cover; }
        .footer { text-align: center; padding: 10px; }
        .nav-buttons { position: fixed; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 10; }
        .nav-btn { padding: 5px 10px; border: 1px solid #fff; border-radius: 5px; background: rgba(0,0,0,0.5); color: #fff; cursor: pointer; }
        body.light .nav-btn { border-color: #000; background: rgba(255,255,255,0.5); color: #000; }
        .hidden { display: none; }
        #editCenter { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: #fff; overflow: auto; padding: 20px; box-sizing: border-box; }
        body.light #editCenter { background: rgba(255,255,255,0.8); color: #000; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.5); padding: 20px; border-radius: 5px; color: #fff; }
        @media (max-width: 600px) { .widgets { flex-direction: column; } .ads { flex-direction: column; } .ad { width: 100%; margin-bottom: 10px; } }
    </style>
</head>
<body class="dark">
    <div class="nav-buttons">
        <button class="nav-btn" id="modeToggle">切换模式</button>
        <button class="nav-btn" id="settingsBtn">设置</button>
    </div>
    <div class="header">
        <div class="widgets">
            <div class="widget" id="onlineTime">在线时长: 0s</div>
            <div class="widget" id="healthReminder">健康提醒</div>
            <div class="widget" id="worldClock"></div>
        </div>
    </div>
    <div class="search">
        <input type="text" id="searchInput" placeholder="搜索书签...">
    </div>
    <div class="bookmarks" id="bookmarksContainer"></div>
    <div class="ads">
        <a class="ad" id="ad1"><img></a>
        <a class="ad" id="ad2"><img></a>
        <a class="ad" id="ad3"><img></a>
    </div>
    <div class="footer" id="footer"></div>
    <div id="editCenter" class="hidden">
        <h2>编辑中心</h2>
        <div id="githubSettings">
            <h3>GitHub 设置</h3>
            <input type="text" id="githubOwner" placeholder="仓库所有者">
            <input type="text" id="githubRepo" placeholder="仓库名">
            <input type="text" id="githubToken" placeholder="GitHub Token">
            <button id="validateToken">验证</button>
            <button id="saveGithub" disabled>保存 GitHub 设置</button>
            <p id="githubStatus"></p>
        </div>
        <div id="bookmarkEditor" disabled>
            <h3>书签管理</h3>
            <input type="text" id="newBookmarkTitle" placeholder="标题">
            <input type="text" id="newBookmarkUrl" placeholder="URL">
            <button id="addBookmark">添加书签</button>
            <input type="file" id="importFile" accept=".html">
            <button id="importBookmarks">导入书签</button>
            <button id="exportBookmarks">导出书签</button>
            <div id="bookmarkList"></div>
            <p>书签数量: <span id="bookmarkCount">0</span></p>
        </div>
        <div id="cityEditor">
            <h3>城市管理</h3>
            <input type="text" id="newCity" placeholder="时区，如 Asia/Shanghai">
            <button id="addCity">添加城市</button>
            <div id="cityList"></div>
        </div>
        <div id="adEditor">
            <h3>广告管理</h3>
            <div for each ad>
                <input type="file" class="adImg" accept="image/*">
                <input type="text" class="adLink" placeholder="链接">
                <button class="saveAd">保存</button>
                <button class="deleteAd">删除</button>
            </div>
        </div>
        <button id="saveChanges">保存更改</button>
        <button id="closeEdit">关闭</button>
    </div>
    <div id="loading" class="hidden">加载中...</div>
    <script>
        const DEFAULT_OWNER = '<!-- REPO_OWNER -->';
        const DEFAULT_REPO = '<!-- REPO_NAME -->';
        let appData = {
            bookmarks: [],
            cities: ["Asia/Shanghai", "America/New_York", "Europe/London", "Australia/Sydney"],
            ads: [{imgUrl: "", link: ""}, {imgUrl: "", link: ""}, {imgUrl: "", link: ""}],
            github: { owner: DEFAULT_OWNER, repo: DEFAULT_REPO, token: "", validated: false }
        };
        let onlineTimer;
        let scrollTimer;
        let healthInterval;

        async function init() {
            showLoading(true);
            await loadDataFromGitHub();
            renderBookmarks(appData.bookmarks);
            renderClocks();
            renderAds();
            renderFooter();
            updateBookmarkCount();
            startOnlineTimer();
            startHealthReminder();
            setupEventListeners();
            showLoading(false);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        async function loadDataFromGitHub() {
            const { owner, repo, token } = appData.github;
            let url;
            if (token) {
                url = `https://api.github.com/repos/${owner}/${repo}/contents/bookmarks.json`;
                const response = await fetch(url, { headers: { Authorization: `token ${token}` } });
                if (response.ok) {
                    const data = await response.json();
                    const content = atob(data.content.replace(/\n/g, ''));
                    Object.assign(appData, JSON.parse(content));
                }
            } else {
                url = `https://raw.githubusercontent.com/${owner || DEFAULT_OWNER}/${repo || DEFAULT_REPO}/main/bookmarks.json`;
                const response = await fetch(url);
                if (response.ok) {
                    Object.assign(appData, await response.json());
                }
            }
        }

        async function saveDataToGitHub() {
            showLoading(true);
            const { owner, repo, token, validated } = appData.github;
            if (!validated || !token) {
                alert('请先验证 GitHub 设置');
                showLoading(false);
                return;
            }
            const content = JSON.stringify(appData);
            const base64Content = btoa(unescape(encodeURIComponent(content))); // UTF-8 safe base64
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/bookmarks.json`;
            const shaResponse = await fetch(url, { headers: { Authorization: `token ${token}` } });
            const sha = shaResponse.ok ? (await shaResponse.json()).sha : undefined;
            const response = await fetch(url, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'Update bookmarks', content: base64Content, sha })
            });
            if (response.ok) {
                alert('保存成功');
            } else {
                alert('保存失败: ' + await response.text());
            }
            showLoading(false);
        }

        async function validateGitHubToken() {
            const token = document.getElementById('githubToken').value;
            const owner = document.getElementById('githubOwner').value || DEFAULT_OWNER;
            const repo = document.getElementById('githubRepo').value || DEFAULT_REPO;
            if (!token) return;
            const url = `https://api.github.com/repos/${owner}/${repo}`;
            const response = await fetch(url, { headers: { Authorization: `token ${token}` } });
            if (response.ok) {
                appData.github = { owner, repo, token, validated: true };
                document.getElementById('githubStatus').textContent = '验证成功';
                document.getElementById('saveGithub').disabled = false;
                updateEditFeaturesStatus(true);
            } else {
                document.getElementById('githubStatus').textContent = '验证失败: ' + await response.text();
            }
        }

        function updateEditFeaturesStatus(enabled) {
            document.getElementById('bookmarkEditor').disabled = !enabled;
            document.getElementById('cityEditor').disabled = !enabled;
            document.getElementById('adEditor').disabled = !enabled;
        }

        function renderBookmarks(bookmarks, container = document.getElementById('bookmarksContainer'), path = []) {
            container.innerHTML = '';
            bookmarks.forEach((bm, index) => {
                if (bm.children) {
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'bookmark folder';
                    folderDiv.textContent = bm.title;
                    folderDiv.onclick = () => toggleFolder(folderDiv);
                    const childContainer = document.createElement('div');
                    childContainer.style.display = 'none';
                    childContainer.className = 'bookmarks';
                    renderBookmarks(bm.children, childContainer, [...path, index]);
                    folderDiv.appendChild(childContainer);
                    container.appendChild(folderDiv);
                } else {
                    const a = document.createElement('a');
                    a.className = 'bookmark';
                    a.href = bm.url;
                    a.target = '_blank';
                    const img = document.createElement('img');
                    img.src = `https://www.google.com/s2/favicons?domain=${new URL(bm.url).hostname}`;
                    img.onerror = () => img.src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text x='0' y='14'>${bm.title[0]}</text></svg>`;
                    a.appendChild(img);
                    a.appendChild(document.createTextNode(bm.title));
                    container.appendChild(a);
                }
            });
        }

        function toggleFolder(folder) {
            const child = folder.querySelector('.bookmarks');
            child.style.display = child.style.display === 'none' ? 'grid' : 'none';
        }

        function renderClocks() {
            const clockDiv = document.getElementById('worldClock');
            clockDiv.innerHTML = appData.cities.map(tz => {
                const time = new Intl.DateTimeFormat('zh', { timeZone: tz, hour: '2-digit', minute: '2-digit', second: '2-digit' }).format(new Date());
                return `<div>${tz.split('/')[1]}: ${time}</div>`;
            }).join('');
            setTimeout(renderClocks, 1000);
        }

        function renderAds() {
            appData.ads.forEach((ad, i) => {
                const a = document.getElementById(`ad${i+1}`);
                a.href = ad.link;
                a.querySelector('img').src = ad.imgUrl;
            });
        }

        function renderFooter() {
            const year = new Date().getFullYear();
            const total = countBookmarks(appData.bookmarks);
            const hostname = location.hostname;
            document.getElementById('footer').innerHTML = `<div class="dark-white"><div>共收录${total}个网站</div><div>Copyright © 2018-${year} ${hostname}, All Rights Reserved</div></div>`;
        }

        function countBookmarks(bms) {
            return bms.reduce((acc, bm) => acc + (bm.children ? countBookmarks(bm.children) : 1), 0);
        }

        function updateBookmarkCount() {
            document.getElementById('bookmarkCount').textContent = countBookmarks(appData.bookmarks);
        }

        function startOnlineTimer() {
            let seconds = 0;
            onlineTimer = setInterval(() => {
                seconds++;
                document.getElementById('onlineTime').textContent = `在线时长: ${seconds}s`;
            }, 1000);
        }

        function startHealthReminder() {
            healthInterval = setInterval(() => {
                alert('健康提醒: 休息一下吧！');
            }, 1800000); // 30min
        }

        function setupEventListeners() {
            document.getElementById('modeToggle').onclick = () => document.body.classList.toggle('light');
            document.getElementById('settingsBtn').onclick = () => {
                if (appData.github.validated) {
                    document.getElementById('editCenter').classList.remove('hidden');
                    renderBookmarkList();
                    renderCityList();
                    renderAdEditor();
                } else {
                    alert('请先验证 GitHub 设置');
                }
            };
            document.getElementById('closeEdit').onclick = () => document.getElementById('editCenter').classList.add('hidden');
            document.getElementById('validateToken').onclick = validateGitHubToken;
            document.getElementById('saveGithub').onclick = () => {
                localStorage.setItem('github', JSON.stringify(appData.github));
                alert('GitHub 设置保存成功');
            };
            document.getElementById('addBookmark').onclick = () => {
                const title = document.getElementById('newBookmarkTitle').value;
                const url = document.getElementById('newBookmarkUrl').value;
                if (title && url) {
                    appData.bookmarks.push({title, url});
                    renderBookmarks(appData.bookmarks);
                    updateBookmarkCount();
                    renderBookmarkList();
                }
            };
            document.getElementById('importBookmarks').onclick = () => {
                const file = document.getElementById('importFile').files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const html = e.target.result;
                        const parsed = parseBookmarkHTML(html);
                        appData.bookmarks = mergeBookmarks(appData.bookmarks, parsed);
                        appData.bookmarks = deduplicateBookmarks(appData.bookmarks);
                        renderBookmarks(appData.bookmarks);
                        updateBookmarkCount();
                        renderBookmarkList();
                        alert('导入成功');
                    };
                    reader.onerror = () => alert('导入失败');
                    reader.readAsText(file);
                }
            };
            document.getElementById('exportBookmarks').onclick = () => {
                const html = generateBookmarkHTML(appData.bookmarks);
                const blob = new Blob([html], {type: 'text/html'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'bookmarks.html';
                a.click();
            };
            document.getElementById('addCity').onclick = () => {
                const tz = document.getElementById('newCity').value;
                if (tz && appData.cities.length < 4) {
                    appData.cities.push(tz);
                    renderClocks();
                    renderCityList();
                }
            };
            document.getElementById('saveChanges').onclick = saveDataToGitHub;
            document.getElementById('searchInput').oninput = e => {
                const query = e.target.value.toLowerCase();
                const filtered = filterBookmarks(appData.bookmarks, query);
                renderBookmarks(filtered);
            };
            window.onscroll = () => {
                clearTimeout(scrollTimer);
                document.querySelector('.nav-buttons').style.opacity = 1;
                scrollTimer = setTimeout(() => document.querySelector('.nav-buttons').style.opacity = 0, 3000);
            };
        }

        function renderBookmarkList() {
            const list = document.getElementById('bookmarkList');
            list.innerHTML = '';
            appData.bookmarks.forEach((bm, i) => {
                const div = document.createElement('div');
                div.textContent = bm.title;
                const editBtn = document.createElement('button');
                editBtn.textContent = '编辑';
                editBtn.onclick = () => {
                    const newTitle = prompt('新标题', bm.title);
                    const newUrl = prompt('新URL', bm.url);
                    if (newTitle) bm.title = newTitle;
                    if (newUrl) bm.url = newUrl;
                    renderBookmarks(appData.bookmarks);
                    renderBookmarkList();
                };
                const delBtn = document.createElement('button');
                delBtn.textContent = '删除';
                delBtn.onclick = () => {
                    if (confirm('确认删除?')) {
                        appData.bookmarks.splice(i, 1);
                        renderBookmarks(appData.bookmarks);
                        renderBookmarkList();
                        updateBookmarkCount();
                    }
                };
                div.append(editBtn, delBtn);
                list.appendChild(div);
            });
        }

        function renderCityList() {
            const list = document.getElementById('cityList');
            list.innerHTML = '';
            appData.cities.forEach((tz, i) => {
                const div = document.createElement('div');
                div.textContent = tz;
                const delBtn = document.createElement('button');
                delBtn.textContent = '删除';
                delBtn.onclick = () => {
                    appData.cities.splice(i, 1);
                    renderClocks();
                    renderCityList();
                };
                div.append(delBtn);
                list.appendChild(div);
            });
        }

        function renderAdEditor() {
            const editor = document.getElementById('adEditor');
            editor.innerHTML = '<h3>广告管理</h3>';
            appData.ads.forEach((ad, i) => {
                const div = document.createElement('div');
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = e => {
                    const file = e.target.files[0];
                    if (file && file.size <= 3 * 1024 * 1024) {
                        const reader = new FileReader();
                        reader.onload = ev => ad.imgUrl = ev.target.result;
                        reader.readAsDataURL(file);
                    } else {
                        alert('图片超过3MB');
                    }
                };
                const linkInput = document.createElement('input');
                linkInput.type = 'text';
                linkInput.value = ad.link;
                linkInput.onchange = e => ad.link = e.target.value;
                const saveBtn = document.createElement('button');
                saveBtn.textContent = '保存';
                saveBtn.onclick = () => renderAds();
                const delBtn = document.createElement('button');
                delBtn.textContent = '删除';
                delBtn.onclick = () => {
                    if (confirm('确认删除?')) {
                        ad.imgUrl = '';
                        ad.link = '';
                        renderAds();
                    }
                };
                div.append(fileInput, linkInput, saveBtn, delBtn);
                editor.appendChild(div);
            });
        }

        function filterBookmarks(bms, query) {
            return bms.map(bm => {
                if (bm.children) {
                    return { ...bm, children: filterBookmarks(bm.children, query) };
                }
                return bm.title.toLowerCase().includes(query) ? bm : null;
            }).filter(Boolean);
        }

        function parseBookmarkHTML(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            function parseDL(dl) {
                const items = [];
                let current = dl.firstChild;
                while (current) {
                    if (current.tagName === 'DT') {
                        const a = current.querySelector('A');
                        if (a) {
                            items.push({ title: a.textContent, url: a.href });
                        } else {
                            const h3 = current.querySelector('H3');
                            if (h3) {
                                const folder = { title: h3.textContent, children: parseDL(current.nextElementSibling) };
                                items.push(folder);
                            }
                        }
                    }
                    current = current.nextSibling;
                }
                return items;
            }
            return parseDL(doc.querySelector('DL'));
        }

        function generateBookmarkHTML(bms, level = 0) {
            let html = '';
            bms.forEach(bm => {
                if (bm.children) {
                    html += '<DT><H3>' + bm.title + '</H3></DT>\n<DL><p>\n' + generateBookmarkHTML(bm.children, level + 1) + '</DL><p>\n';
                } else {
                    html += '<DT><A HREF="' + bm.url + '">' + bm.title + '</A></DT>\n';
                }
            });
            return html;
        }

        function mergeBookmarks(existing, newBms) {
            return [...existing, ...newBms];
        }

        function deduplicateBookmarks(bms) {
            const seen = new Set();
            function dedup(arr) {
                return arr.filter(bm => {
                    if (bm.children) {
                        bm.children = dedup(bm.children);
                        return true;
                    }
                    const key = bm.url;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
            }
            return dedup(bms);
        }

        // Load saved github if any
        const savedGithub = localStorage.getItem('github');
        if (savedGithub) {
            appData.github = JSON.parse(savedGithub);
            if (appData.github.validated) updateEditFeaturesStatus(true);
        } else {
            document.getElementById('githubOwner').value = DEFAULT_OWNER;
            document.getElementById('githubRepo').value = DEFAULT_REPO;
        }

        init();
    </script>
</body>
</html>