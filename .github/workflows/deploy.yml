# .github/workflows/deploy.yml
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Inject default repo information
        run: |
          # 获取当前仓库完整地址（owner/repo）
          REPO_FULL_NAME="${{ github.repository }}"
          
          # 替换HTML中的默认仓库占位符（关键步骤）
          sed -i "s|const DEFAULT_REPO = \".*\";|const DEFAULT_REPO = \"$REPO_FULL_NAME\";|g" index.html
          sed -i "s|const DEFAULT_RAW_URL = \".*\";|const DEFAULT_RAW_URL = \"https://raw.githubusercontent.com/$REPO_FULL_NAME/main/bookmarks.json\";|g" index.html
      
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4.4.1
        with:
          branch: gh-pages
          folder: .
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Initialize default bookmarks.json
        if: github.ref == 'refs/heads/main'
        run: |
          if [ ! -f "bookmarks.json" ]; then
            echo '{"bookmarks": [], "ads": [], "timezones": []}' > bookmarks.json
            git add bookmarks.json
            git commit -m "Initialize default bookmarks"
            git push origin main
          fi